<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>动画测试：失律卫士序列帧 (Targeted)</title>
<style>
    body {
        background-color: #1a1a1a;
        color: #fff;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
    }

    /* 战场容器 */
    .test-stage {
        width: 800px;
        height: 400px;
        border: 2px solid #444;
        background-color: #000;
        position: relative;
        /* background-image: url('assets/Background/bg.png'); */
        background-size: cover;
        overflow: hidden; /* 防止特效溢出 */
    }

    /* === 目标：打击乐手 === */
    .target-ally {
        width: 150px;
        height: 150px;
        position: absolute;
        left: 200px; /* 放在左侧 */
        bottom: 50px;
        background-image: url('assets/Roles/percussionist.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center bottom;
        transition: filter 0.1s, transform 0.1s;
    }

    /* === 攻击者：失律卫士 === */
    .sprite-enemy {
        width: 250px;
        height: 250px;
        position: absolute;
        right: 150px; /* 初始在右侧 */
        bottom: 50px;
        background-image: url('assets/Enemies/knight.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center bottom;
        z-index: 10;
    }

    /* === 特效 === */
    .vfx-particle {
        position: absolute;
        pointer-events: none;
        z-index: 20;
        animation: vfxFade 0.5s ease-out forwards;
    }
    @keyframes vfxFade {
        0% { opacity: 1; transform: scale(0.8); }
        50% { transform: scale(1.5); }
        100% { opacity: 0; transform: scale(1.2); }
    }

    /* === 优化后的攻击动画 (总时长 1.2s) === */
    /* 目标位置：left: 200px (target) vs right: 150px (attacker) 
       容器宽800。attacker left ≈ 800 - 150 - 250 = 400px.
       target left = 200px.
       距离 ≈ 200px. 
       所以位移需要大概 -200px 左右。
    */

    @keyframes enemyRushOptimized {
        0% { transform: translateX(0) scale(1); }
        
        /* 蓄力阶段 (0-45%) */
        45% { transform: translateX(60px) scale(0.9) skewX(-10deg); filter: brightness(1.2); } 
        
        /* 冲刺阶段 (45-52%) -> 到达目标点 */
        /* 修正位移距离为 -280px，确保贴脸 */
        52% { transform: translateX(-280px) scale(1.15) skewX(5deg); } 
        
        /* 停顿阶段 (52-75%) -> 保持姿势 */
        75% { transform: translateX(-280px) scale(1.15); } 
        
        /* 返回阶段 (75-100%) */
        100% { transform: translateX(0) scale(1); }
    }

    @keyframes knightSequenceOptimized {
        0% { background-image: url('assets/Enemies/knight_attack_1.png'); } 
        
        /* attack_1 现在持续到 45%，正好覆盖整个缓慢后退的蓄力阶段 */
        45% { background-image: url('assets/Enemies/knight_attack_2.png'); } 
        
        /* 59% 切换到挥砍帧 (attack_3)。
           人物会以 attack_2 的姿态完成冲刺并“撞”到目标面前。 */
        59% { background-image: url('assets/Enemies/knight_attack_3.png'); } 
        
        75% { background-image: url('assets/Enemies/knight_attack_4.png'); } 
        
        92% { background-image: url('assets/Enemies/knight.png'); }
        100% { background-image: url('assets/Enemies/knight.png'); }
    }

    .anim-knight-attack {
        animation: 
            enemyRushOptimized 1.2s cubic-bezier(0.5, 0, 0.2, 1),
            knightSequenceOptimized 1.2s steps(1); 
    }

    /* 受击动画 */
    .anim-hit {
        animation: shakeHit 0.4s ease-out;
    }
    @keyframes shakeHit {
        0% { filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); transform: translateX(-10px); }
        20% { transform: translateX(10px); }
        40% { transform: translateX(-10px); }
        60% { transform: translateX(5px); }
        100% { filter: none; transform: translateX(0); }
    }

    .controls { margin-top: 20px; }
    button { padding: 10px 30px; font-size: 18px; cursor: pointer; background: #e74c3c; color: white; border: none; border-radius: 4px; }
    button:hover { background: #c0392b; }
    
    #preload { display: none; }
</style>
</head>
<body>

    <div class="test-stage">
        <!-- 目标 -->
        <div id="target-unit" class="target-ally"></div>
        <!-- 敌人 -->
        <div id="test-enemy" class="sprite-enemy"></div>
    </div>

    <div class="controls">
        <button onclick="playAnim()">测试攻击 (Attack)</button>
    </div>

    <div id="preload">
        <img src="assets/Enemies/knight_attack_1.png">
        <img src="assets/Enemies/knight_attack_2.png">
        <img src="assets/Enemies/knight_attack_3.png">
        <img src="assets/Enemies/knight_attack_4.png">
        <img src="assets/vfx/vfx_Heavy_Rending.png">
    </div>

    <script>
        function playAnim() {
            const enemy = document.getElementById('test-enemy');
            const target = document.getElementById('target-unit');
            
            // 1. 重置并播放敌人动画
            enemy.classList.remove('anim-knight-attack');
            void enemy.offsetWidth; // Reflow
            enemy.classList.add('anim-knight-attack');

            // 2. 模拟击中时刻
            // 挥砍帧在 59% 触发 (1.2 * 0.59 ≈ 0.708s)
            // 设为 710ms，让特效与刀光完全重合
            setTimeout(() => {
                spawnVFX();
                target.classList.remove('anim-hit');
                void target.offsetWidth;
                target.classList.add('anim-hit');
            }, 710);
        }

        function spawnVFX() {
            const target = document.getElementById('target-unit');
            const stage = document.querySelector('.test-stage');
            
            const vfx = document.createElement('img');
            vfx.src = 'assets/vfx/vfx_Heavy_Rending.png';
            vfx.className = 'vfx-particle';
            
            // 定位到目标中心
            // target left=200, width=150 -> center=275
            // target bottom=50, height=150 -> center from bottom=125
            
            vfx.style.left = (200 + 150/2 - 100) + 'px'; // 假设特效宽200
            vfx.style.bottom = (50 + 150/2 - 100) + 'px';
            vfx.style.width = '200px'; 
            
            stage.appendChild(vfx);
            
            setTimeout(() => vfx.remove(), 500);
        }
    </script>
</body>
</html>