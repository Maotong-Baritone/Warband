(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function a(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=a(n);fetch(n.href,i)}})();window.wait=e=>new Promise(t=>setTimeout(t,e));const g={roles:"assets/Roles/",enemies:"assets/Enemies/",vfx:"assets/vfx/",cards:"assets/Cards/"},A=[2,3,4,6,7,17,18],M={pianist:{id:"pianist",name:"å¹»å¥è£å†³è€…",hp:60,sprite:g.roles+"pianist.png",deck:[1,19,30],buff:"çµæ„Ÿä¸Šé™ +1"},violinist:{id:"violinist",name:"é“¶å¼¦åœ£å¾’",hp:50,sprite:g.roles+"violinist.png",deck:[5,20,31],buff:"æ‰‹ç‰Œä¸Šé™ +1"},vocalist:{id:"vocalist",name:"é•‡é­‚åŸå”±è€…",hp:45,sprite:g.roles+"vocalist.png",deck:[8,9,10],buff:"å›åˆç»“æŸå› 5 HP"},cellist:{id:"cellist",name:"æ²‰éŸ³å®ˆæœ›è€…",hp:75,sprite:g.roles+"cellist.png",deck:[11,12,13],buff:"åˆå§‹è·å¾— 8 æŠ¤ç›¾"},brass:{id:"brass",name:"ç ´æ™“å·æ‰‹",hp:70,sprite:g.roles+"brass.png",deck:[14,15,16],buff:"é«˜è´¹å¡(>=2)é¢å¤–+5ä¼¤å®³"},flutist:{id:"flutist",name:"çµé£è¡Œè€…",hp:45,sprite:g.roles+"flutist.png",deck:[24,25,26],buff:"æ¯å›åˆç¬¬ä¸€å¼ ç‰Œå˜ä¸ºæ— æ¶ˆè€—"},percussionist:{id:"percussionist",name:"é›·éœ†éœ‡å‡»è€…",hp:70,sprite:g.roles+"percussionist.png",deck:[27,28,29],buff:"æ”»å‡»ä¼¤å®³ +2"},conductor:{id:"conductor",name:"çµé­‚ç»‡å¾‹è€…",hp:55,sprite:g.roles+"conductor.png",deck:[21,22,23],buff:"åˆå¥ç‰Œæ¶ˆè€— -1"}},B={noise:{name:"æ‚éŸ³å¾®ç²’",sprite:g.enemies+"slime.png",hpScale:1,act:["atk"]},discord:{name:"å¤±å¾‹å«å£«",sprite:g.enemies+"knight.png",hpScale:1.5,act:["atk","atk","atk","def"]},silence:{name:"å¯‚é™æŒ‡æŒ¥å®¶",sprite:g.enemies+"demon.png",hpScale:2.5,act:["atk","atk","buff","debuff"]},bayinhe:{name:"æ¶æ„å…«éŸ³ç›’",sprite:g.enemies+"bayinhe.png",hpScale:1.2,act:["buff_str","buff_str","atk_heavy"]},changshiban:{name:"æ‚éŸ³å”±è¯—ç­",sprite:g.enemies+"changshiban.png",hpScale:1.8,act:["atk_vuln","atk","atk_vuln"]},shihengwuzhe:{name:"å¤±è¡¡èˆè€…",sprite:g.enemies+"shihengwuzhe.png",hpScale:2,act:["atk_heavy","atk_heavy","def_block"]}},T={metronome:{name:"èŠ‚æ‹å™¨",icon:"â°",desc:"æ¯å›åˆç¬¬ä¸€å¼ æ”»å‡»ç‰Œæ‰“å‡ºä¸¤æ¬¡"},rosin:{name:"æ¾é¦™",icon:"ğŸ§‚",desc:"æ¯æ¬¡é€ æˆä¼¤å®³æ—¶æ–½åŠ  1 å±‚æ˜“ä¼¤"},baton:{name:"æŒ‡æŒ¥æ£’",icon:"ğŸª„",desc:"æˆ˜æ–—å¼€å§‹æ—¶é¢å¤–è·å¾— 1 ç‚¹çµæ„Ÿ"},tuning_fork:{name:"éŸ³å‰",icon:"Y",desc:"å›åˆç»“æŸæ—¶ä¿ç•™ 10 ç‚¹æŠ¤ç›¾"},sheet_music:{name:"å¤è€ä¹è°±",icon:"ğŸ“œ",desc:"æ‰€æœ‰åˆå§‹å¡ç‰Œç­‰çº§+1"},beethoven_ear:{name:"è´å¤šèŠ¬çš„å¤±èªè€³èœ—",icon:"ğŸ‘‚",desc:"HP < 30% æ—¶ï¼Œé€ æˆä¼¤å®³ç¿»å€"},paganini_string:{name:"å¸•æ ¼å°¼å°¼çš„æ–­å¼¦",icon:"ğŸ»",desc:"é¦–å¼ æ”»å‡»ç‰Œè€—èƒ½-1ï¼Œä½†è‡ªä¼¤ 2 ç‚¹"},mozart_quill:{name:"è«æ‰ç‰¹çš„å®‰é­‚ç¾½ç¬”",icon:"âœ’ï¸",desc:"é˜Ÿå‹æ¿’æ­»æ—¶ï¼Œå¯¹æ•Œé€ æˆ 30 çœŸå®ä¼¤å®³"},bach_lens:{name:"å·´èµ«çš„èµ‹æ ¼é€é•œ",icon:"ğŸ”",desc:"è¿ç»­æ‰“å‡º 3 å¼ åŒç±»ç‰Œï¼ŒæŠ½1ç‰Œ+1è´¹"},liszt_bullet:{name:"ææ–¯ç‰¹çš„é­”å¼¹",icon:"ğŸ¹",desc:"æ‰€æœ‰å¤šæ®µæ”»å‡»æ¬¡æ•° +1"}};class U{constructor(){this.listeners={}}on(t,a){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(a)}off(t,a){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(s=>s!==a))}emit(t,a){this.listeners[t]&&this.listeners[t].forEach(s=>s(a))}}const o=new U;class N{constructor(){this.state={gold:100,level:1,partyRoles:[],relics:[],cardLevels:{}}}get gold(){return this.state.gold}get level(){return this.state.level}get partyRoles(){return[...this.state.partyRoles]}get relics(){return[...this.state.relics]}get cardLevels(){return{...this.state.cardLevels}}initGame(t){this.state.gold=100,this.state.level=1,this.state.partyRoles=[t],this.state.relics=[],this.state.cardLevels={},this.notifyChange("init")}addGold(t){this.state.gold+=t,this.notifyChange("gold")}spendGold(t){return this.state.gold>=t?(this.state.gold-=t,this.notifyChange("gold"),!0):!1}nextLevel(){this.state.level++,this.notifyChange("level")}addRelic(t){this.state.relics.includes(t)||(this.state.relics.push(t),this.notifyChange("relics"),t==="sheet_music"&&this.upgradeAllCards())}recruitMember(t){return this.state.partyRoles.includes(t)?!1:(this.state.partyRoles.push(t),this.notifyChange("party"),!0)}clearParty(){this.state.partyRoles=[],this.state.cardLevels={},this.notifyChange("party")}upgradeCard(t){const a=this.state.cardLevels[t]||0;return a<5?(this.state.cardLevels[t]=a+1,this.notifyChange("cards"),!0):!1}upgradeAllCards(){Object.keys(this.state.cardLevels).forEach(t=>{this.state.cardLevels[t]++}),this.notifyChange("cards")}getCardLevel(t){return this.state.cardLevels[t]||0}notifyChange(t){o.emit("update-ui"),o.emit(`store-change:${t}`,this.state),console.log(`[GameStore] State changed: ${t}`,this.state)}}const h=new N,L=[{id:101,name:"å†¬ä¹‹æ—…",cost:1,req:["pianist","vocalist"],val:12,desc:"{val} ä¼¤å®³ + å†°å†»ã€‚",img:g.cards+"dongzhilv.png",type:"duo",effects:[{type:"dmg",val:12,scale:!0,vfx:"ice"},{type:"toast",msg:"å¯’å†¬é™ä¸´..."},{type:"status",id:"stunned",msg:"æ•Œäººè¢«å†°å†»!"}]},{id:102,name:"å…‹é²é‡‡",cost:0,req:["pianist","violinist"],val:6,desc:"ç‹‚æš´ {val} ä¼¤å®³ x 4 æ¬¡ã€‚",img:g.cards+"kelucai.png",type:"duo",effects:[{type:"dmg",val:6,scale:!0,hits:4,interval:150,vfx:"slash"}]},{id:103,name:"ç»¿æ ‘æˆè«",cost:1,req:["violinist","vocalist"],val:15,desc:"å…¨å‘˜å› {val} HP + 5 ç›¾ã€‚",img:g.cards+"lvshuchengyin.png",type:"duo",effects:[{type:"heal",val:15,scale:!0,target:"all",vfx:"heal"},{type:"block",val:5,scale:!0,target:"all"},{type:"toast",msg:"ç¥åœ£å®é™"}]},{id:104,name:"å¼¦ä¹æŸ”æ¿",cost:1,req:["violinist","cellist"],val:30,desc:"å‰æ’è·å¾— {val} æŠ¤ç›¾å¹¶åä¼¤ã€‚",img:g.cards+"adagio.png",type:"duo",effects:[{type:"block",val:30,scale:!0,target:"front",vfx:"shield"},{type:"custom",fn:(e,t,a,s,n)=>{let i=e.getFrontAlly();i&&e.dmgEnemy(i.block,!1,n)}}]},{id:105,name:"ç‹‚æ¬¢èŠ‚",cost:2,req:["pianist","cellist"],val:8,desc:"éšæœº {val} ä¼¤å®³ x 5 æ¬¡ã€‚",img:g.cards+"carnival.png",type:"duo",effects:[{type:"dmg",val:8,scale:!0,hits:5,interval:120,vfx:"heavy_hit"}]},{id:106,name:"æ‚²æ­Œ",cost:2,req:["pianist","vocalist","cellist"],val:30,desc:"{val} çœŸå®ä¼¤å®³ + å…¨å‘˜å›è¡€ã€‚",img:g.cards+"elegie.png",type:"trio",effects:[{type:"dmg",val:30,scale:!0,vfx:"soundwave"},{type:"heal",val:20,scale:!0,target:"all",vfx:"heal"}]}],I={1:{name:"çƒ­æƒ…",cost:2,type:"atk",val:16,tag:"atk",img:g.cards+"reqing.png",desc:"{val} ä¼¤å®³",owner:"pianist",effects:[{type:"dmg",val:16,scale:!0,vfx:"heavy_hit"}]},19:{name:"å¤è°ƒå±•å¼€",cost:1,type:"skill",val:0,tag:"buff",eff:"polyphony",img:g.cards+"fudiao.png",desc:"æŠ½ {draw} å¼ ç‰Œï¼Œè‹¥æœ‰éæ”»å‡»ç‰Œå› {mana} è´¹",owner:"pianist",effects:[{type:"custom",fn:async(e,t,a,s)=>{const n=h.getCardLevel(19);let i=2+Math.floor((n+1)/2),l=1+Math.floor(n/2);(await e.drawCards(i)).some(c=>window.CARDS[c].type!=="atk")&&(e.manaData.current+=l,window.UI.spawnManaParticle(`char-${t.role}`,l),window.UI.floatText(`+${l} çµæ„Ÿ`,`char-${t.role}`,"#4dabf7"))}}]},30:{name:"å°¾å£°",cost:1,type:"atk",val:6,tag:"atk",eff:"hand_scale",img:g.cards+"weisheng.png",desc:"{val} ä¼¤å®³ (æ¯å¼ æ‰‹ç‰Œ+3ä¼¤å®³)",owner:"pianist",effects:[{type:"custom",fn:(e,t,a,s,n)=>{let i=Math.ceil(e.hand.length*3*s);e.dmgEnemy(a+i,!1,n);const l=n===0?"sprite-enemy":`sprite-enemy-${n}`;window.UI.spawnVFX("heavy_hit",l)}}]},2:{name:"ä¸åå’Œ",cost:1,type:"debuff",val:5,tag:"atk",img:g.cards+"buxiehe.png",desc:"{val} ä¼¤å®³ + æ˜“ä¼¤",owner:"common",effects:[{type:"dmg",val:5,scale:!0,vfx:"dissonance"},{type:"status",id:"vuln",val:1,delay:350}]},3:{name:"ä¼‘æ­¢ç¬¦",cost:1,type:"def",val:7,tag:"def",img:g.cards+"xiuzhifu.png",desc:"å‰æ’è·å¾— {val} æŠ¤ç›¾",owner:"common",effects:[{type:"block",val:7,scale:!0,vfx:"shield"}]},4:{name:"é¢¤éŸ³",cost:0,type:"atk",val:5,tag:"atk",img:g.cards+"chanyin.png",desc:"{val} ä¼¤å®³, æŠ½1ç‰Œ",owner:"common",effects:[{type:"dmg",val:5,scale:!0,vfx:"heavy_hit"},{type:"draw",val:1}]},6:{name:"ç‹¬å¥",cost:2,type:"atk",val:14,tag:"atk",img:g.cards+"duzou.png",desc:"{val} ç©¿é€ä¼¤å®³",owner:"common",effects:[{type:"dmg",val:14,scale:!0,pierce:!0,vfx:"slash"}]},7:{name:"æ€¥æ¿",cost:0,type:"atk",val:4,tag:"atk",img:g.cards+"jiban.png",desc:"{val} ä¼¤å®³,å›1è´¹",owner:"common",effects:[{type:"dmg",val:4,scale:!0,vfx:"slash"},{type:"mana",val:1}]},17:{name:"æ¸å¼º",cost:1,type:"atk",val:6,tag:"atk",eff:"crescendo",img:g.cards+"jianqiang.png",desc:"{val} ä¼¤å®³(éšæœ¬åœºæ”»å‡»æ¬¡æ•°æˆé•¿)",owner:"common",effects:[{type:"custom",fn:(e,t,a,s,n)=>{let i=Math.ceil(e.crescendoStacks*s);e.dmgEnemy(a+i,!1,n);const l=n===0?"sprite-enemy":`sprite-enemy-${n}`;window.UI.spawnVFX("soundwave",l)}}]},18:{name:"å˜å¥",cost:1,type:"skill",val:0,tag:"buff",eff:"variation",img:g.cards+"bianzou.png",desc:"ä¸‹ä¸€å¼ ç‰Œæ•ˆæœ +50%",owner:"common",effects:[{type:"custom",fn:(e,t,a,s)=>{const n=h.getCardLevel(18);e.variationBonus=.5+.1*n,window.UI.toast(`ä¸‹ä¸€å¼ ç‰Œæ•ˆæœ +${Math.round(e.variationBonus*100)}%`),window.UI.spawnVFX("heal",`char-${t.role}`)}}]},5:{name:"è¿å¼“",cost:1,type:"atk",val:6,hits:2,tag:"atk",img:g.cards+"yungong.png",desc:"{val} ä¼¤å®³ x2",owner:"violinist",effects:[{type:"dmg",val:6,scale:!0,hits:2,vfx:"slash"}]},20:{name:"åŒéŸ³",cost:1,type:"atk",val:4,tag:"atk",img:g.cards+"shuangyin.png",desc:"é€ æˆ 3 + è´Ÿé¢çŠ¶æ€å±‚æ•°æ¬¡ {val} ç‚¹ä¼¤å®³",owner:"violinist",effects:[{type:"custom",fn:(e,t,a,s,n)=>{const i=e.enemies[n];if(!i)return;let r=3+((i.buffs.vuln>0?1:0)+(i.stunned?1:0));h.relics.includes("liszt_bullet")&&r++;const c=n===0?"sprite-enemy":`sprite-enemy-${n}`;for(let m=0;m<r;m++)e.tm.add(()=>{e.dmgEnemy(a,!1,n),window.UI.spawnVFX("slash",c)},m*150)}}]},31:{name:"æ‹¨å¥",cost:0,type:"atk",val:3,tag:"atk",img:g.cards+"bozou.png",desc:"{val} ä¼¤å®³ï¼Œæ–½åŠ  2 å±‚æ˜“ä¼¤",owner:"violinist",effects:[{type:"dmg",val:3,scale:!0,vfx:"slash"},{type:"status",id:"vuln",val:2,msg:"æ˜“ä¼¤+2",delay:350}]},8:{name:"å°–å•¸",cost:1,type:"atk",val:10,tag:"atk",eff:"screech",img:g.cards+"jianxiao.png",desc:"{val} ä¼¤å®³ + 1å±‚å…±é¸£",owner:"vocalist",effects:[{type:"dmg",val:10,scale:!0,vfx:"soundwave"},{type:"status",id:"res",val:1,msg:"å…±é¸£+1",delay:350}]},9:{name:"å…±é¸£",cost:1,type:"buff",val:3,tag:"buff",img:g.cards+"gongming.png",desc:"{val} å±‚å…±é¸£ (å…¨ä½“)",owner:"vocalist",effects:[{type:"status",id:"res",val:3,target:"all",scale:!0,vfx:"dissonance"}]},10:{name:"å’å¹è°ƒ",cost:2,type:"spec",val:10,tag:"atk",img:g.cards+"yongtandiao.png",desc:"å¼•çˆ†å…±é¸£(å±‚æ•°x{val})",owner:"vocalist",effects:[{type:"custom",fn:(e,t,a,s,n)=>{const i=e.enemies[n];if(!i)return;let l=i.buffs.res*a;e.dmgEnemy(l,!1,n),i.buffs.res=0,window.UI.log(`[å¼•çˆ†] æ¶ˆè€— ${i.name} å…±é¸£é€ æˆ ${l} ä¼¤å®³`,"dmg"),window.UI.shake();const r=n===0?"sprite-enemy":`sprite-enemy-${n}`;window.UI.spawnVFX("soundwave",r)}}]},11:{name:"ä½åŸ",cost:1,type:"def",val:12,tag:"def",img:g.cards+"diyin.png",desc:"å‰æ’è·å¾— {val} æŠ¤ç›¾",owner:"cellist",effects:[{type:"block",val:12,scale:!0,vfx:"shield"}]},12:{name:"é‡å¥",cost:2,type:"spec",val:100,tag:"atk",img:g.cards+"chongzou.png",desc:"é€ æˆç­‰åŒäºæŠ¤ç›¾ {val}% çš„ä¼¤å®³",owner:"cellist",effects:[{type:"custom",fn:(e,t,a,s,n)=>{let i=Math.ceil(t.block*s);e.dmgEnemy(i,!1,n),window.UI.shake();const l=n===0?"sprite-enemy":`sprite-enemy-${n}`;window.UI.spawnVFX("heavy_hit",l)}}]},13:{name:"ç´å¼¦å£å’",cost:1,type:"def",val:5,tag:"def",img:g.cards+"qinxian.png",desc:"è·å¾— {val} æŠ¤ç›¾ï¼ŒæŠ½ä¸€å¼ ç‰Œ",owner:"cellist",effects:[{type:"block",val:5,scale:!0,vfx:"shield"},{type:"draw",val:1}]},14:{name:"éœ‡è¡å·è§’",cost:1,type:"atk",val:8,tag:"atk",img:g.cards+"zhendanghaojiao.png",desc:"{val} ä¼¤å®³ï¼Œæ–½åŠ  2 å±‚æ˜“ä¼¤",owner:"brass",effects:[{type:"dmg",val:8,scale:!0,vfx:"soundwave"},{type:"status",id:"vuln",val:2,delay:350}]},15:{name:"é«˜çˆ†éŸ³ç¬¦",cost:2,type:"atk",val:18,tag:"atk",img:g.cards+"gaobaoyinfu.png",desc:"{val} çˆ†å‘ä¼¤å®³ (AOE)",owner:"brass",effects:[{type:"dmg",val:18,scale:!0,vfx:"heavy_hit"}]},16:{name:"æ¯ç­äº¤å“",cost:3,type:"atk",val:35,tag:"atk",img:g.cards+"huimiejiaoxiang.png",desc:"{val} æ¯ç­æ€§æ‰“å‡»",owner:"brass",effects:[{type:"dmg",val:35,scale:!0,vfx:"heavy_hit"}]},21:{name:"èµ·æ‹",cost:0,type:"skill",val:0,tag:"buff",eff:"upbeat",img:g.cards+"qipai.png",desc:"è·å¾— {mana} çµæ„Ÿï¼ŒæŠ½1å¼ ç‰Œ",owner:"conductor",effects:[{type:"custom",fn:async(e,t,a,s)=>{const n=h.getCardLevel(21);let i=1+Math.floor(n/2);if(e.manaData.current+=i,window.UI.spawnManaParticle(`char-${t.role}`,i),window.UI.floatText(`+${i} çµæ„Ÿ`,`char-${t.role}`,"#4dabf7"),await e.drawCards(1),window.UI.spawnVFX("conductor",`char-${t.role}`),n>0){let l=e.getFrontAlly();l&&(l.block+=4)}}}]},22:{name:"ç¼„é»˜",cost:1,type:"atk",val:8,tag:"atk",eff:"weaken",img:g.cards+"jianmo.png",desc:"{val} ä¼¤å®³ï¼Œæœ¬å›åˆæ•ŒäººåŠ›é‡ -{str}",owner:"conductor",effects:[{type:"dmg",val:8,scale:!0,vfx:"dissonance"},{type:"custom",fn:(e,t,a,s,n)=>{const i=e.enemies[n];if(!i)return;const r=2+h.getCardLevel(22);i.buffs.str-=r,e.tempStrDebuff+=r;const c=n===0?"sprite-enemy":`sprite-enemy-${n}`;window.UI.floatText(`åŠ›é‡ -${r}`,c,"#bdc3c7")}}]},23:{name:"å¤§åˆå¥",cost:2,type:"atk",val:15,tag:"atk",eff:"tutti",img:g.cards+"dahezou.png",desc:"{val} ä¼¤å®³ï¼Œå…¨å‘˜è·å¾— 8 ç‚¹æŠ¤ç›¾",owner:"conductor",effects:[{type:"dmg",val:15,scale:!0,vfx:"soundwave"},{type:"block",val:8,scale:!0,target:"all"}]},24:{name:"èŠ±èˆŒ",cost:0,type:"atk",val:3,tag:"atk",img:g.cards+"huashe.png",desc:"{val} ä¼¤å®³ (æ¬¡æ•°=æœ¬å›åˆå·²è€—çµæ„Ÿ)",owner:"flutist",effects:[{type:"custom",fn:(e,t,a,s,n)=>{let i=Math.max(1,e.manaSpentTurn);h.relics.includes("liszt_bullet")&&i++;const l=n===0?"sprite-enemy":`sprite-enemy-${n}`;for(let r=0;r<i;r++)e.tm.add(()=>{e.dmgEnemy(a,!1,n),window.UI.spawnVFX("Multi-Thrust",l)},r*150)}}]},25:{name:"æ°”æ¯æ§åˆ¶",cost:1,type:"skill",val:0,tag:"buff",eff:"breath",img:g.cards+"qixikongzhi.png",desc:"è·å¾— {mana} ç‚¹çµæ„Ÿ",owner:"flutist",effects:[{type:"custom",fn:async(e,t,a,s)=>{const n=h.getCardLevel(25);let i=2+n;e.manaData.current+=i,window.UI.spawnManaParticle(`char-${t.role}`,i),window.UI.floatText(`+${i} çµæ„Ÿ`,`char-${t.role}`,"#4dabf7"),window.UI.spawnVFX("conductor",`char-${t.role}`),n>0&&await e.drawCards(1)}}]},26:{name:"ç©¿é€éŸ³",cost:1,type:"atk",val:8,tag:"atk",img:g.cards+"chuantouyin.png",desc:"{val} ç©¿é€ä¼¤å®³ï¼Œä¸”æŠ½ 1 å¼ ç‰Œ",owner:"flutist",effects:[{type:"dmg",val:8,scale:!0,pierce:!0,vfx:"soundwave"},{type:"draw",val:1}]},27:{name:"æ»šå¥",cost:1,type:"atk",val:4,hits:4,tag:"atk",img:g.cards+"gunzou.png",desc:"{val} ä¼¤å®³ x4",owner:"percussionist",effects:[{type:"dmg",val:4,scale:!0,hits:4,vfx:"heavy_hit"}]},28:{name:"ç‚¸é•²",cost:2,type:"atk",val:10,tag:"atk",eff:"stun",img:g.cards+"zhacha.png",desc:"{val} ä¼¤å®³ï¼Œå‡»æ™•æ•Œäºº(è·³è¿‡å›åˆ)",owner:"percussionist",effects:[{type:"dmg",val:10,scale:!0,vfx:"heavy_hit"},{type:"status",id:"stunned",msg:"æ•Œäººè¢«å‡»æ™•!",vfx:"Heavy_Rending",delay:350}]},29:{name:"å®šéŸ³",cost:1,type:"def",val:10,tag:"def",img:g.cards+"dingyin.png",desc:"å‰æ’è·å¾— {val} æŠ¤ç›¾ï¼Œä¸‹å›åˆä¿ç•™æŠ¤ç›¾",owner:"percussionist",effects:[{type:"block",val:10,scale:!0,vfx:"shield"},{type:"custom",fn:(e,t,a,s)=>{let n=e.getFrontAlly();n&&(n.retainBlock=!0)}}]},101:L[0],102:L[1],103:L[2],104:L[3],105:L[4],106:L[5]};class z{constructor(){this.reset()}reset(){const t=this.state?this.state.allies:[],a=this.state?[...this.state.deck,...this.state.hand,...this.state.discard]:[],s=this.state?this.state.mana.max:3,n=this.state?this.state.mana.draw:5;a.sort(()=>Math.random()-.5),t.forEach(i=>i.block=0),this.state={phase:"IDLE",turnCount:0,mana:{current:s,max:s,draw:n},allies:t,enemies:[],deck:a,hand:[],discard:[],selectedCardIdx:-1,attacksPlayed:0,manaSpentTurn:0,firstCardPlayed:!1,processing:!1,variationBonus:0,crescendoStacks:0,tempStrDebuff:0,relicState:{lastCardType:null,bachCounter:0,mozartTriggered:!1}},this.notify("reset")}get phase(){return this.state.phase}get turnCount(){return this.state.turnCount}get mana(){return this.state.mana}get allies(){return this.state.allies}get enemies(){return this.state.enemies}get enemy(){return this.state.enemies[0]}get deck(){return this.state.deck}get hand(){return this.state.hand}get discard(){return this.state.discard}setPhase(t){this.state.phase=t,this.notify("phase")}setAllies(t){this.state.allies=t,this.notify("allies")}setEnemies(t){this.state.enemies=t,this.notify("enemies")}setDeck(t){this.state.deck=t,this.notify("deck")}setHand(t){this.state.hand=t,this.notify("hand")}setDiscard(t){this.state.discard=t,this.notify("discard")}resetMana(){this.state.mana.current=this.state.mana.max,this.notify("mana")}modifyMana(t){this.state.mana.current+=t,this.notify("mana")}nextTurn(){this.state.turnCount++,this.state.attacksPlayed=0,this.state.manaSpentTurn=0,this.state.firstCardPlayed=!1,this.notify("turn")}selectCard(t){this.state.selectedCardIdx=t,this.notify("selection")}setProcessing(t){this.state.processing=t,this.notify("processing")}recordCardPlay(t,a){this.state.mana.current-=a,this.state.manaSpentTurn+=a,this.state.firstCardPlayed=!0,t.type==="atk"&&this.state.attacksPlayed++,t.tag==="atk"&&this.state.crescendoStacks++,this.notify("card-play")}notify(t){o.emit("update-ui"),o.emit(`battle-store:${t}`,this.state)}}const d=new z,k={switchScene(e){document.querySelectorAll(".scene").forEach(a=>a.classList.remove("active"));const t=document.getElementById(e);t&&t.classList.add("active")},updateHeader(){const e=document.getElementById("map-gold");e&&(e.innerText=h.gold);const t=document.getElementById("battle-gold");t&&(t.innerText=h.gold);const a=document.getElementById("shop-gold");a&&(a.innerText=h.gold);const s=document.getElementById("level-ui");s&&(s.innerText=h.level);const n=document.getElementById("map-level-num");n&&(n.innerText=h.level);const i=document.getElementById("relic-bar");i&&(i.innerHTML="",h.relics.forEach(l=>{const r=document.createElement("div");r.className="relic",r.innerText=T[l].icon,r.setAttribute("data-desc",`${T[l].name}: ${T[l].desc}`),i.appendChild(r)}))},toast(e){const t=document.createElement("div");t.className="toast",t.innerText=e;const a=document.getElementById("game-window");a&&a.appendChild(t),setTimeout(()=>t.remove(),1e3)},floatText(e,t,a){const s=document.getElementById(t);if(!s)return;const n=document.createElement("div");n.className="float-text",n.innerText=e,n.style.color=a;const i=s.getBoundingClientRect(),l=document.getElementById("game-window");if(!l)return;const r=l.getBoundingClientRect();n.style.left=i.left-r.left+i.width/2-20+(Math.random()-.5)*20+"px",n.style.top=i.top-r.top+"px",l.appendChild(n),setTimeout(()=>n.remove(),1e3)},spawnVFX(e,t){const a=document.getElementById(t);if(!a)return;const s=document.getElementById("game-window");if(!s)return;const n=a.getBoundingClientRect(),i=s.getBoundingClientRect(),l=document.createElement("img");l.src=`assets/vfx/vfx_${e}.png`,l.className=`vfx-particle vfx-${e}`,l.style.left=n.left-i.left+n.width/2+(Math.random()-.5)*40+"px",l.style.top=n.top-i.top+n.height/2+(Math.random()-.5)*40+"px",l.style.filter=`hue-rotate(${Math.random()*20}deg)`,s.appendChild(l),setTimeout(()=>l.remove(),500)},shake(){const e=document.getElementById("game-window");e&&(e.classList.remove("shake"),e.offsetWidth,e.classList.add("shake"))},currentBGM:null,playSound(e){const t=new Audio(e);t.volume=.6,t.play().catch(a=>console.warn("Audio error:",a))},playBGM(e){this.currentBGM&&this.currentBGM.src.endsWith(encodeURI(e))||(this.currentBGM&&this.currentBGM.pause(),this.currentBGM=new Audio(e),this.currentBGM.loop=!0,this.currentBGM.volume=.5,this.currentBGM.play().catch(t=>console.warn("BGM error:",t)))},stopBGM(){this.currentBGM&&(this.currentBGM.pause(),this.currentBGM=null)},showDeckModal(e,t,a=null){const s=document.getElementById("modal-overlay"),n=document.getElementById("modal-card-list");if(!s||!n)return;const i=document.getElementById("modal-title");i&&(i.innerText=t),n.innerHTML="",s.classList.add("active");const l=a?e.map((r,c)=>({id:r,originalIdx:c})):[...e].sort((r,c)=>r-c).map(r=>({id:r}));if(l.length===0){n.innerHTML='<div style="color:#666; margin-top:50px;">æš‚æ— å¡ç‰Œ</div>';return}l.forEach(r=>{const c=r.id,m=I[c];if(!m)return;const f=document.createElement("div");f.className="card-display",m.type==="duo"&&f.classList.add("duet"),m.type==="trio"&&f.classList.add("trio");const p=h.getCardLevel(c);p>0&&f.classList.add("upgraded");let u=m.desc;m.eff==="variation"&&(u=u.replace("50%",`${50+10*p}%`)),m.eff==="polyphony"&&(u=u.replace("{draw}",`<span class="highlight-val">${2+Math.floor((p+1)/2)}</span>`).replace("{mana}",`<span class="highlight-val">${1+Math.floor(p/2)}</span>`)),m.eff==="upbeat"&&(u=u.replace("{mana}",`<span class="highlight-val">${1+Math.floor(p/2)}</span>`)),m.eff==="breath"&&(u=u.replace("{mana}",`<span class="highlight-val">${2+p}</span>`)),m.eff==="weaken"&&(u=u.replace("{str}",`<span class="highlight-val">${2+p}</span>`));let w=m.val;if(w!==void 0){p>0&&w>0&&(w=Math.ceil(w*(1+.5*p)));const v=m.type==="duo"||m.type==="trio"?"#4dabf7":"#2ecc71";u=u.replace("{val}",`<span class="highlight-val" style="color:${v}">${w}</span>`)}f.innerHTML=`
                <div class="card-cost">${m.cost}</div>
                <img src="${m.img}" class="card-art" onerror="this.src=''">
                <div class="card-text">
                    <div class="card-name">${m.name}${p>0?" +"+p:""}</div>
                    <div class="card-desc"><span>${u}</span></div>
                </div>
            `,a&&(f.style.cursor="pointer",f.style.border="2px dashed #e74c3c",f.onclick=()=>a(c,r.originalIdx)),n.appendChild(f)})},closeDeckModal(){const e=document.getElementById("modal-overlay");e&&e.classList.remove("active")}},q={render(e,t){if(!e||e.length===0){console.warn("MapGraph is empty!");return}const a=parseInt(t.layer),s=parseInt(t.index),n=document.getElementById("map-nodes"),i=document.getElementById("map-lines");!n||!i||(n.innerHTML="",i.innerHTML="",e.forEach((l,r)=>{const c=document.createElement("div");c.className="map-layer",c.id=`layer-${r}`,l.forEach((m,f)=>{var v;const p=document.createElement("div");p.className="map-node-v2",p.id=`node-${r}-${f}`;let u="locked";if(a===-1)r===0&&(u="reachable");else if(r<a)u="passed";else if(r===a)f===s?u="current":u="locked";else if(r===a+1){const x=(v=e[a])==null?void 0:v[s];x&&x.next&&x.next.includes(f)&&(u="reachable")}p.classList.add(u),m.type==="boss"&&p.classList.add("boss");let w="assets/UI/Battle.png";m.type==="elite"&&(w="assets/UI/Elite.png"),m.type==="camp"&&(w="assets/UI/camp.png"),m.type==="recruit"&&(w="assets/UI/Recruit.png"),m.type==="shop"&&(w="assets/UI/shop_icon.png"),m.type==="boss"&&(w="assets/UI/BossBattle.png"),m.type==="start"&&(w="assets/UI/common_button.png"),p.innerHTML=`<img src="${w}"><div class="node-name">${m.name}</div>`,u==="reachable"&&(p.onclick=()=>window.game.enterNode(m.type,r,f)),c.appendChild(p)}),n.appendChild(c)}),setTimeout(()=>{var c;const l=(c=document.getElementById("map-container"))==null?void 0:c.getBoundingClientRect();if(!l)return;e.forEach((m,f)=>{f>=e.length-1||m.forEach((p,u)=>{const w=document.getElementById(`node-${f}-${u}`);if(!w)return;const v=w.getBoundingClientRect();if(v.width===0)return;const x=v.left-l.left+v.width/2,C=v.top-l.top+v.height/2;p.next.forEach(S=>{const R=document.getElementById(`node-${f+1}-${S}`);if(!R)return;const b=R.getBoundingClientRect(),E=b.left-l.left+b.width/2,G=b.top-l.top+b.height/2,D=document.createElementNS("http://www.w3.org/2000/svg","line");D.setAttribute("x1",x),D.setAttribute("y1",C),D.setAttribute("x2",E),D.setAttribute("y2",G),D.setAttribute("stroke","#555"),D.setAttribute("stroke-width","2"),i.appendChild(D)})})});const r=document.getElementById("map-scroll-area");if(a===-1&&r)r.scrollTo({left:0,behavior:"smooth"});else{const m=document.getElementById(`layer-${a}`);if(r&&m){const f=m.offsetLeft-r.clientWidth/2+m.clientWidth/2;r.scrollTo({left:f,behavior:"smooth"})}}},100))}},O={render(e){const t=document.getElementById("shop-cards");t&&(t.innerHTML="");const a=document.getElementById("shop-relics");a&&(a.innerHTML="");const s=document.getElementById("shop-services");if(s&&(s.innerHTML=""),t){const n=t.parentElement.querySelector("h3");n&&(n.innerHTML='<img src="assets/UI/upgrade_icon.png" class="icon-title"> æŠ€è‰ºç£¨ç‚¼ <span style="font-size:0.6em;color:#2ecc71">(å¼ºåŒ–)</span>'),e.cards.forEach((i,l)=>{const r=I[i.id],c=document.createElement("div");c.className="shop-item"+(i.sold?" sold":"");const m=i.level,f=m+1;c.innerHTML=`
                    <div style="position:relative; width:80px; height:80px;">
                        <img src="${r.img}" style="width:100%; height:100%; object-fit:contain;">
                        <div style="position:absolute; bottom:0; right:0; background:#2ecc71; color:#000; font-size:0.8em; padding:2px 4px; border-radius:4px; font-weight:bold;">Lv.${m} -> ${f}</div>
                    </div>
                    <div class="shop-item-name">${r.name}</div>
                    <div class="shop-item-desc" style="color:#2ecc71">ç‚¹å‡»å¼ºåŒ–</div>
                    <div class="shop-price"><img src="assets/UI/gold_icon.png" class="gold-icon-small"> ${i.price}</div>
                `,c.onclick=()=>window.game.buyItem("cards",l),t.appendChild(c)})}if(a){const n=a.parentElement.querySelector("h3");n&&(n.innerHTML='<img src="assets/UI/mystery_relic_icon.png" class="icon-title"> ä¼ ä¸–åœ£ç‰©'),e.relics.forEach((i,l)=>{const r=T[i.key],c=document.createElement("div");c.className="shop-item"+(i.sold?" sold":""),c.innerHTML=`
                    <div style="position:relative; width:80px; height:80px; display:flex; align-items:center; justify-content:center;">
                        <img src="assets/UI/mystery_relic_icon.png" style="width:100%; height:100%; position:absolute; opacity:0.3;">
                        <span style="font-size:2.5em; position:relative; z-index:2;">${r.icon}</span>
                    </div>
                    <div class="shop-item-name">${r.name}</div>
                    <div class="shop-item-desc">${r.desc}</div>
                    <div class="shop-price"><img src="assets/UI/gold_icon.png" class="gold-icon-small"> ${i.price}</div>
                `,c.onclick=()=>window.game.buyItem("relics",l),a.appendChild(c)})}s&&e.services.forEach((n,i)=>{const l=document.createElement("div");l.className="shop-item"+(n.sold?" sold":""),l.innerHTML=`
                    <div style="width:80px; height:80px;"><img src="${n.icon}" style="width:100%; height:100%; object-fit:contain;"></div>
                    <div class="shop-item-name">${n.name}</div>
                    <div class="shop-item-desc">${n.desc}</div>
                    <div class="shop-price"><img src="assets/UI/gold_icon.png" class="gold-icon-small"> ${n.price}</div>
                `,l.onclick=()=>window.game.buyItem("services",i),s.appendChild(l)})}},_={renderRewards(e="new"){const t=document.getElementById("reward-list");if(t&&(t.innerHTML="",e==="new")){document.getElementById("reward-title").innerText="é¢†æ‚Ÿæ–°ä¹è°±",document.getElementById("reward-text").innerText="é€‰æ‹©ä¸€å¼ åŠ å…¥ç‰Œç»„ (è‹¥å·²æœ‰åˆ™å¼ºåŒ–)";const a=window.game.getSmartRewards();for(let s of a){const n=I[s],i=document.createElement("div");i.className="char-card",i.style.height="250px";const l=d.deck.includes(parseInt(s));let r=n.desc;n.val!==void 0&&(r=r.replace("{val}",n.val));let c=l?'<span style="color:#2ecc71">â˜… çªç ´ (å…¨å±€+1)</span>':'<span style="color:#f0c040">âœ¨ æ–°è·å–</span>',m=h.getCardLevel(s),f=m>0?` +${m}`:"";i.innerHTML=`
                    <img src="${n.img}" class="char-img" onerror="this.src=''">
                    <div class="char-info">
                        <b>${n.name}${f}</b>
                        <div style="margin:5px 0;">${c}</div>
                        <div class="card-desc"><span>${r}</span></div>
                    </div>`,i.onclick=()=>{if(l){if(h.getCardLevel(s)>=5){k.toast(`${n.name} å·²è¾¾ç­‰çº§ä¸Šé™!`);return}h.upgradeCard(s),k.toast(`${n.name} çªç ´æˆåŠŸ!`)}else{const p=d.deck;p.push(parseInt(s)),d.setDeck(p),k.toast(`ä¹ å¾—: ${n.name}`)}window.game.finishReward()},t.appendChild(i)}}},renderUpgradeRewards(e=0){const t=document.getElementById("reward-list");if(!t)return;t.innerHTML="",document.getElementById("reward-title").innerText="æˆ˜ç«æ·¬ç‚¼",document.getElementById("reward-text").innerHTML=`è·å¾—é‡‘å¸: <img src="assets/UI/gold_icon.png" class="gold-icon-small"> <span style="color:#f0c040; font-weight:bold;">${e}</span><br>é€‰æ‹©ä¸€ç§æŠ€è‰ºè¿›è¡Œã€é’»ç ”ã€‘(ä¸Šé™ç­‰çº§ 5)`;const a=[...new Set(d.deck)].filter(i=>h.getCardLevel(i)<5);if(a.length===0){t.innerHTML="<div style='color:#888'>æ‰€æœ‰æŠ€è‰ºå·²è¾¾åŒ–å¢ƒ</div>";return}const s=[...a],n=[];for(let i=0;i<3&&s.length!==0;i++){const l=Math.floor(Math.random()*s.length);n.push(s[l]),s.splice(l,1)}n.forEach(i=>{const l=I[i],r=document.createElement("div");r.className="char-card",r.style.height="250px";const c=h.getCardLevel(i),m=c+1;l.val;let f=l.desc;if(l.eff==="variation"){const p=50+10*m;f=f.replace("50%",`${p}%`)}if(l.eff==="polyphony"){const p=2+Math.floor((m+1)/2),u=1+Math.floor(m/2);f=f.replace("{draw}",`<span class="highlight-val">${p}</span>`).replace("{mana}",`<span class="highlight-val">${u}</span>`)}if(l.eff==="upbeat"){const p=1+Math.floor(m/2);f=f.replace("{mana}",`<span class="highlight-val">${p}</span>`)}if(l.eff==="breath"){const p=2+m;f=f.replace("{mana}",`<span class="highlight-val">${p}</span>`)}if(l.eff==="weaken"){const p=2+m;f=f.replace("{str}",`<span class="highlight-val">${p}</span>`)}if(l.val!==void 0){const p=Math.ceil(l.val*(1+.5*m));f=f.replace("{val}",`<span class="highlight-val">${p}</span>`)}r.innerHTML=`
                <img src="${l.img}" class="char-img" onerror="this.src=''">
                <div class="char-info">
                    <b style="color:${c>0?"#2ecc71":"#eee"}">${l.name} ${c>0?"+"+c:""}</b>
                    <div style="font-size:2em; color:#f0c040; margin:2px 0;">â®• +${m}</div>
                    <div class="card-desc"><span>${f}</span></div>
                </div>`,r.onclick=()=>{h.upgradeCard(i),k.toast(`${l.name} é’»ç ”æˆåŠŸ!`),window.game.finishReward()},t.appendChild(r)})}},F={renderCharSelect(e,t){const a=document.getElementById(e);a&&(a.innerHTML="",Object.keys(M).forEach(s=>{if(e==="grid-recruit"&&h.partyRoles.includes(s))return;const n=M[s],i=document.createElement("div");i.className="char-card";const l=e==="grid-start"?"start":"recruit";i.innerHTML=`
                <img src="${n.sprite}" class="char-img idle-breathe" onerror="this.style.backgroundColor='#333';this.alt='å›¾ç‰‡ä¸¢å¤±'">
                <div class="char-info">
                    <div style="color:#f0c040;font-weight:bold;font-size:1.2em">${n.name}</div>
                    <div class="bonus-text">
                        <div>â¤ï¸ HP: ${n.hp}</div>
                        <div>ğŸŒŸ ${n.buff}</div>
                    </div>
                    <button class="btn-preview" onclick="window.game.previewDeck('${s}', '${l}')">ğŸ” é¢„è§ˆå¡ç»„</button>
                </div>`,i.onclick=r=>{r.target.tagName!=="BUTTON"&&(r.stopPropagation(),e==="grid-recruit"&&i.classList.add("joined"),t(s))},a.appendChild(i)}))}},H={selectedIdx:-1,handleClick(e){d.phase==="PREPARE"&&(this.selectedIdx===-1?(this.selectedIdx=e,o.emit("highlight-unit",{idx:e,active:!0})):this.selectedIdx===e?(o.emit("highlight-unit",{idx:e,active:!1}),this.selectedIdx=-1):(this.swap(this.selectedIdx,e),o.emit("highlight-unit",{idx:this.selectedIdx,active:!1}),this.selectedIdx=-1))},swap(e,t){const a=[...d.allies],s=a[e];a[e]=a[t],a[t]=s,d.setAllies(a),o.emit("render-battlefield")}},$={update(){const e=document.getElementById("mana-ui");if(e){const s=d.mana.current,n=d.mana.max;for(;e.children.length<n;){const i=document.createElement("div");i.className="mana-dot empty",e.appendChild(i)}for(;e.children.length>n;)e.lastChild&&e.lastChild.remove();Array.from(e.children).forEach((i,l)=>{const r=l<s,c=!i.classList.contains("empty");r&&!c?(i.classList.remove("empty","active-anim"),i.offsetWidth,i.classList.add("active-anim")):!r&&c&&(i.classList.add("empty"),i.classList.remove("active-anim"))})}const t=document.getElementById("draw-ui");t&&(t.innerHTML=`<img src="assets/UI/draw.png" class="ui-icon" style="width:32px;height:32px;" onerror="this.style.display='none'"> æ‰‹ç‰Œ: ${d.mana.draw}`),d.allies.forEach(s=>{const n=document.getElementById(`char-${s.role}`);if(n){s.dead?n.classList.add("dead"):n.classList.remove("dead");const i=document.getElementById(`hp-text-${s.role}`);i&&(i.innerText=`${s.hp}`);const l=document.getElementById(`block-${s.role}`),r=document.getElementById(`block-val-${s.role}`);l&&r&&(s.block>0?(l.style.display="flex",r.innerText=s.block):l.style.display="none")}}),this.renderEnemies();const a=document.getElementById("btn-end");if(a){const s=d.phase==="PLAYER"&&!d.state.processing;a.disabled=!s}this.renderHand()},renderBattleField(){const e=document.getElementById("party-container");if(!e)return;e.innerHTML="",d.allies.forEach((a,s)=>{const n=document.createElement("div");n.className="char-unit",n.id=`char-${a.role}`,n.onclick=()=>H.handleClick(s),n.innerHTML=`
                <div class="mini-status">
                    <div class="mini-hp-text">
                        <img src="assets/UI/hp_icon.png" class="ui-icon" onerror="this.style.display='none'"> <span id="hp-text-${a.role}">${a.hp}</span>
                    </div>
                    <div class="mini-block" id="block-${a.role}" style="display:none">
                        <div class="block-bg"></div>
                        <div class="block-val" id="block-val-${a.role}"></div>
                    </div>
                </div>
                <div class="musician-sprite idle-breathe" style="background-image:url('${M[a.role].sprite}'); animation-delay: ${s*.4}s"></div>
            `,e.appendChild(n)}),this.applyDynamicLayout(e,"char-unit",!1)},renderEnemies(){const e=document.querySelector(".enemy-container");if(!e)return;const t=d.enemies;t.length!==0&&(e.children.length!==t.length&&(e.innerHTML="",t.forEach((a,s)=>{const n=document.createElement("div");n.className="enemy-unit",n.id=`enemy-unit-${s}`;const i=s===0?"sprite-enemy":`sprite-enemy-${s}`;n.innerHTML=`
                    <div class="status-row"></div>
                    <div class="intent-badge"></div>
                    <div id="${i}" class="sprite-enemy enemy-idle-breathe" onclick="window.battle.targetEnemy(${s})"></div>
                    <div class="enemy-hp-box">
                        <img src="assets/UI/hp_icon.png" class="ui-icon" style="width:28px;height:28px;"> 
                        <span class="hp-text" style="color:#fff; font-weight:bold; font-size:1.4em; text-shadow:0 0 5px #000;"></span>
                    </div>
                    <div class="enemy-name"></div>
                `,e.appendChild(n)}),this.applyDynamicLayout(e,"enemy-unit",!0)),t.forEach((a,s)=>{const n=document.getElementById(`enemy-unit-${s}`);if(!n)return;a.isDying?n.classList.add("dead"):a.hp<=0?(n.classList.add("dead-static"),n.classList.remove("dead")):n.classList.remove("dead","dead-static");const i=n.querySelector(".hp-text");i&&(i.innerText=`${a.hp}/${a.maxHp}`);const l=n.querySelector(".enemy-name");l&&(l.innerText=a.name);const r=n.querySelector(".intent-badge");if(r)if(a.stunned)r.innerHTML='<span class="intent-icon">â„ï¸</span> æ— æ³•è¡ŒåŠ¨';else{const p=a.intent.icon||"assets/UI/attack.png";let u=a.intent.val>0?a.intent.val:"";["atk","atk_heavy","atk_vuln"].includes(a.intent.type)&&u!==""&&(u=parseInt(u)+(a.buffs.str||0)),r.innerHTML=`<img src="${p}" class="intent-icon-img" onerror="this.src='assets/UI/attack.png'"> ${u}`}const c=n.querySelector(".status-row");if(c){let p="";if(a.block>0&&(p+=`<div class="status-badge block"><img src="assets/UI/block.png" class="ui-icon"> <span>${a.block}</span></div>`),a.buffs.vuln>0&&(p+=`<div class="status-badge vuln"><img src="assets/UI/Vulnerable.png" class="ui-icon"> <span>${a.buffs.vuln}</span></div>`),a.buffs.str!==0){const u=a.buffs.str<0;p+=`<div class="status-icon" style="background:${u?"#bdc3c7":"#e74c3c"}">${u?"è™šå¼±":"åŠ›é‡"} ${a.buffs.str}</div>`}c.innerHTML=p}const m=s===0?"sprite-enemy":`sprite-enemy-${s}`,f=document.getElementById(m);f&&(a.stunned?f.classList.add("frozen-effect"):f.classList.remove("frozen-effect"),f.className.includes("anim-")||(f.style.backgroundImage=`url('${a.sprite}')`))}))},applyDynamicLayout(e,t,a){const s=e.getElementsByClassName(t),n=s.length;if(n===0)return;const i=1,l=.05,r=-15;let c=0;n>3&&(c=-20),n>4&&(c=-40),Array.from(s).forEach((m,f)=>{let p;a?p=n-1-f:p=f;const u=10+p,w=i-(n-1-p)*l,v=(n-1-p)*r;m.style.zIndex=u,m.style.transform=`scale(${w}) translateY(${v}px)`,a?(f>0&&(m.style.marginLeft=`${c}px`),m.style.marginRight="0"):(f>0&&(m.style.marginLeft=`${c}px`),m.style.marginRight="0")})},renderHand(){const e=document.getElementById("hand");if(!e)return;const t=document.getElementById("btn-cancel");t&&(t.style.display=d.state.selectedCardIdx===-1?"none":"block");const a=d.hand,s=Array.from(e.children);for(;s.length>a.length;)s.pop().remove();a.forEach((n,i)=>{const l=I[n];if(!l)return;let r=s[i],c=!1;r||(r=document.createElement("div"),e.appendChild(r),c=!0);const m=r.getAttribute("data-card-id"),f=c||m!=n;r.id=`hand-card-${i}`,r.setAttribute("data-card-id",n);const p=h.getCardLevel(n),u=window.battle&&window.battle.isCardPlayable?window.battle.isCardPlayable(l):!0,w=i===d.state.selectedCardIdx;r.className="card"+(w?" selected":"")+(l.type==="duo"?" duet":"")+(l.type==="trio"?" trio":"")+(u?"":" disabled")+(p>0?" upgraded":""),c&&(r.classList.add("card-draw-anim"),setTimeout(()=>r.classList.remove("card-draw-anim"),400));const v=a.length;let x=5,C=-30,S=1;if(v>6&&(x=4,C=-50),v>9&&(x=3,C=-70,S=.9),r.style.marginLeft=`${C}px`,r.style.marginRight=`${C}px`,!w&&u){const b=(i-(v-1)/2)*x;let E=Math.abs(b)*2;v>8&&(E=Math.abs(b)*1.5+10),r.style.transform=`rotate(${b}deg) translateY(${E}px) scale(${S})`}else r.style.transform=w?"":`scale(${S})`;const R=window.battle&&window.battle.getCardCost?window.battle.getCardCost(n):l.cost;if(f){let b=l.desc;if(l.eff==="variation"&&(b=b.replace("50%",`${50+10*p}%`)),l.eff==="polyphony"&&(b=b.replace("{draw}",`<span class="highlight-val">${2+Math.floor((p+1)/2)}</span>`).replace("{mana}",`<span class="highlight-val">${1+Math.floor(p/2)}</span>`)),l.eff==="upbeat"&&(b=b.replace("{mana}",`<span class="highlight-val">${1+Math.floor(p/2)}</span>`)),l.eff==="breath"&&(b=b.replace("{mana}",`<span class="highlight-val">${2+p}</span>`)),l.eff==="weaken"&&(b=b.replace("{str}",`<span class="highlight-val">${2+p}</span>`)),l.val!==void 0){let E=l.val;p>0&&E>0&&(E=Math.ceil(E*(1+.5*p))),b=b.replace("{val}",`<span class="highlight-val">${E}</span>`)}r.innerHTML=`
                    <div class="card-cost">${R}</div>
                    <img src="${l.img}" class="card-art" onerror="this.src=''">
                    <div class="card-text">
                        <div class="card-name">${l.name}${p>0?" +"+p:""}</div>
                        <div class="card-desc"><span>${b}</span></div>
                    </div>
                `,r.onclick=E=>{E.stopPropagation(),u&&window.battle.selectCard(i)}}else{const b=r.querySelector(".card-cost");b&&(b.innerText=R),r.onclick=E=>{E.stopPropagation(),u&&window.battle.selectCard(i)}}})},setBattleBackground(e){const t=document.getElementById("scene-battle");t&&(t.classList.remove("bg-boss","bg-elite","bg-normal"),e==="boss"?t.classList.add("bg-boss"):e==="elite"?t.classList.add("bg-elite"):t.classList.add("bg-normal"))},highlightUnit(e,t){document.querySelectorAll(".char-unit").forEach((s,n)=>{s.classList.remove("swap-selected","swap-target"),t&&(n===e?s.classList.add("swap-selected"):s.classList.add("swap-target"))})},log(e,t=""){const a=document.getElementById("battle-log");if(!a)return;const s=document.createElement("div");s.innerHTML=e,s.className=`log-line log-${t}`,a.appendChild(s),a.scrollTop=a.scrollHeight},clearLog(){const e=document.getElementById("battle-log");e&&(e.innerHTML="")},spawnManaParticle(e,t=1){const a=document.getElementById(e)||document.getElementById("party-container"),s=document.getElementById("mana-ui");if(!a||!s)return;const n=document.getElementById("game-window");if(!n)return;const i=n.getBoundingClientRect(),l=a.getBoundingClientRect(),r=s.getBoundingClientRect(),c=r.left-i.left+50,m=r.top-i.top+20;for(let f=0;f<t;f++)setTimeout(()=>{const p=document.createElement("div");p.className="mana-particle",p.style.left=l.left-i.left+l.width/2+(Math.random()-.5)*40+"px",p.style.top=l.top-i.top+l.height/2+(Math.random()-.5)*40+"px",n.appendChild(p),p.style.transition="all 0.6s cubic-bezier(0.5, 0, 0, 1)",p.offsetWidth,p.style.left=c+"px",p.style.top=m+"px",p.style.transform="scale(0.5)",p.style.opacity="0",setTimeout(()=>p.remove(),600)},f*150)},animateCardPlay({card:e,handIndex:t}){const a=document.getElementById("hand");let s=a&&a.children[t];if(!s&&a&&(s=a.querySelector(`[data-card-id="${e.id}"]`)),!s)return;const n=s.getBoundingClientRect(),l=window.getComputedStyle(s).transform,r=s.cloneNode(!0);r.style.position="fixed",r.style.left=n.left+"px",r.style.top=n.top+"px",r.style.width=n.width+"px",r.style.height=n.height+"px",r.style.margin="0",r.style.setProperty("--start-transform",l!=="none"?l:"scale(1)"),r.style.transform="",r.style.zIndex="9999",r.style.pointerEvents="none",r.classList.remove("selected","card-draw-anim"),document.body.appendChild(r),r.offsetWidth;let c=e.type==="atk"||e.tag==="atk"||e.type==="duo"?"anim-card-play-atk":"anim-card-play-skill";(e.cost>=3||e.type==="trio")&&(c="anim-card-play-power"),r.classList.add(c),setTimeout(()=>r.remove(),800)},initArrow(){document.addEventListener("mousemove",e=>{const t=d.state.selectedCardIdx;if(t===-1){this.hideArrow();return}if(!d.hand[t])return;const a=d.hand[t],s=I[a];if(!s||!(s.type==="atk"||s.type==="debuff"||s.eff==="boom"||s.eff==="bash")){this.hideArrow();return}const n=document.getElementById(`hand-card-${t}`);if(n){const i=n.getBoundingClientRect();this.drawArrow(i.left+i.width/2,i.top,e.clientX,e.clientY)}})},drawArrow(e,t,a,s){const n=document.getElementById("drag-arrow-layer"),i=document.getElementById("drag-arrow-path");if(!n||!i)return;n.style.display="block";const l=e+(a-e)*.5,r=Math.min(t,s)-100;i.setAttribute("d",`M ${e},${t} Q ${l},${r} ${a},${s}`);const c=document.querySelectorAll(".sprite-enemy");let m=null;c.forEach((f,p)=>{const u=f.getBoundingClientRect();a>=u.left&&a<=u.right&&s>=u.top&&s<=u.bottom?(m=f,f.style.filter="brightness(1.5) drop-shadow(0 0 10px red)",document.body.setAttribute("data-hover-enemy-idx",p)):f.style.filter=""}),m?(i.setAttribute("stroke","#ffcc00"),document.getElementById("arrowhead").children[0].setAttribute("fill","#ffcc00")):(i.setAttribute("stroke","#ff0000"),document.getElementById("arrowhead").children[0].setAttribute("fill","#ff0000"),document.body.removeAttribute("data-hover-enemy-idx"))},hideArrow(){const e=document.getElementById("drag-arrow-layer");e&&(e.style.display="none"),document.querySelectorAll(".sprite-enemy").forEach(t=>t.style.filter=""),document.body.removeAttribute("data-hover-enemy-idx")}},y={switchScene:e=>k.switchScene(e),toast:e=>k.toast(e),floatText:(e,t,a)=>k.floatText(e,t,a),spawnVFX:(e,t)=>k.spawnVFX(e,t),shake:()=>k.shake(),playSound:e=>k.playSound(e),playBGM:e=>k.playBGM(e),stopBGM:()=>k.stopBGM(),showDeckModal:(e,t,a)=>k.showDeckModal(e,t,a),closeDeckModal:()=>k.closeDeckModal(),renderCharSelect:(e,t)=>F.renderCharSelect(e,t),renderRewards:e=>_.renderRewards(e),renderUpgradeRewards:e=>_.renderUpgradeRewards(e),renderMap:(e,t)=>q.render(e,t),renderShop:e=>O.render(e),setBattleBackground:e=>$.setBattleBackground(e),renderBattleField:()=>$.renderBattleField(),renderEnemies:()=>$.renderEnemies(),highlightUnit:(e,t)=>$.highlightUnit(e,t),log:(e,t)=>$.log(e,t),clearLog:()=>$.clearLog(),spawnManaParticle:(e,t)=>$.spawnManaParticle(e,t),animateCardPlay:e=>$.animateCardPlay(e),initArrow:()=>$.initArrow(),update(){k.updateHeader();const e=document.getElementById("scene-battle");e&&e.classList.contains("active")&&$.update()}};o.on("highlight-unit",({idx:e,active:t})=>y.highlightUnit(e,t));o.on("render-battlefield",()=>y.renderBattleField());o.on("clear-log",()=>y.clearLog());o.on("log",({msg:e,type:t})=>y.log(e,t));o.on("toast",e=>y.toast(e));o.on("float-text",({text:e,targetId:t,color:a})=>y.floatText(e,t,a));o.on("play-sound",e=>y.playSound(e));o.on("spawn-vfx",({type:e,targetId:t})=>y.spawnVFX(e,t));o.on("shake",()=>y.shake());o.on("update-ui",()=>y.update());o.on("play-bgm",e=>y.playBGM(e));o.on("stop-bgm",()=>y.stopBGM());o.on("animate-card-play",e=>y.animateCardPlay(e));y.initArrow();const P={handlers:{dmg:async(e,t,a,s)=>{let n=t.hits||1;n>1&&h.relics.includes("liszt_bullet")&&(n+=1);const i=t._tempTargetIdx!==void 0?t._tempTargetIdx:0,l=i===0?"sprite-enemy":`sprite-enemy-${i}`,r=t.interval||150;for(let c=0;c<n;c++)e.dmgEnemy(a,t.pierce,i),t.vfx&&o.emit("spawn-vfx",{type:t.vfx,targetId:l}),c<n-1&&await window.wait(r)},heal:async(e,t,a,s)=>{t.target==="all"?e.healAll(a):e.healPlayer(a),t.vfx&&o.emit("spawn-vfx",{type:t.vfx,targetId:"party-container"})},block:async(e,t,a,s)=>{if(t.target==="all")e.addBlockAll(a);else{const n=e.getFrontAlly();n&&(n.block+=a,o.emit("log",{msg:`[æŠ¤ç›¾] ${n.name} è·å¾— ${a} æŠ¤ç›¾`,type:"block"}),o.emit("play-sound","assets/BGM/shield.wav"),o.emit("float-text",{text:`æŠ¤ç›¾+${a}`,targetId:`char-${n.role}`,color:"#3498db"}),t.vfx&&o.emit("spawn-vfx",{type:t.vfx,targetId:`char-${n.role}`}))}},draw:async(e,t,a,s)=>{await e.drawCards(a)},mana:async(e,t,a,s)=>{e.manaData.current+=a;let n="party-container";s&&(n=`char-${s.role}`),y.spawnManaParticle(n,a),o.emit("float-text",{text:`+${a} çµæ„Ÿ`,targetId:n,color:"#4dabf7"})},status:async(e,t,a,s)=>{const n=t._tempTargetIdx!==void 0?t._tempTargetIdx:0,i=e.enemies[n];if(!i)return;const l=n===0?"sprite-enemy":`sprite-enemy-${n}`;if(t.id==="stunned")i.stunned=!0,o.emit("toast",t.msg||`${i.name} è¢«å‡»æ™•!`);else if(t.id==="vuln")i.buffs.vuln+=a,o.emit("float-text",{text:`æ˜“ä¼¤+${a}`,targetId:l,color:"#e67e22"}),o.emit("log",{msg:`[Debuff] ${i.name} è¢«æ–½åŠ  ${a} å±‚æ˜“ä¼¤`,type:"debuff"});else if(t.id==="res")i.buffs.res+=a,o.emit("float-text",{text:`å…±é¸£+${a}`,targetId:l,color:"#9b59b6"}),o.emit("log",{msg:`[Buff] ${i.name} å…±é¸£ +${a}`,type:"buff"});else if(t.id==="str"){i.buffs.str+=a;let r=a>0?"#e74c3c":"#bdc3c7";o.emit("float-text",{text:`åŠ›é‡ ${a>0?"+":""}${a}`,targetId:l,color:r})}t.msg&&t.id!=="stunned"&&o.emit("toast",t.msg)},vfx:async(e,t,a,s)=>{const n=t._tempTargetIdx!==void 0?t._tempTargetIdx:0;let i=n===0?"sprite-enemy":`sprite-enemy-${n}`;if(t.target==="self"&&s&&(i=`char-${s.role}`),t.target==="front"){const l=e.getFrontAlly();l&&(i=`char-${l.role}`)}t.target==="all"&&(i="party-container"),o.emit("spawn-vfx",{type:t.id,targetId:i})},toast:async(e,t,a,s)=>{o.emit("toast",t.msg)},custom:async(e,t,a,s)=>{if(typeof t.fn=="function"){const n=t._tempTargetIdx!==void 0?t._tempTargetIdx:0;await t.fn(e,s,a,t._tempMult||1,n)}}},async execute(e,t,a,s,n){const i=this.handlers[t.type];i?(t.type==="custom"&&(t._tempMult=n),await i(e,t,s,a)):console.warn(`EffectProcessor: Unknown effect type '${t.type}'`)}};class V{constructor(){this.timers=[]}add(t,a){const s=setTimeout(t,a);return this.timers.push(s),s}clearAll(){this.timers.forEach(t=>clearTimeout(t)),this.timers=[]}}const j={get allies(){return d.allies},get enemies(){return d.enemies},get enemy(){return d.enemies[0]},get manaData(){return d.mana},get playerDeck(){return d.deck},set playerDeck(e){d.setDeck(e)},get hand(){return d.hand},set hand(e){d.setHand(e)},get discard(){return d.discard},set discard(e){d.setDiscard(e)},get phase(){return d.phase},set phase(e){d.setPhase(e)},get turnCount(){return d.turnCount},get selectedCard(){return d.state.selectedCardIdx},set selectedCard(e){d.selectCard(e)},get attacksPlayed(){return d.state.attacksPlayed},set attacksPlayed(e){d.state.attacksPlayed=e},get crescendoStacks(){return d.state.crescendoStacks},get variationBonus(){return d.state.variationBonus},set variationBonus(e){d.state.variationBonus=e},get manaSpentTurn(){return d.state.manaSpentTurn},get firstCardPlayed(){return d.state.firstCardPlayed},get tempStrDebuff(){return d.state.tempStrDebuff},set tempStrDebuff(e){d.state.tempStrDebuff=e},get lastCardType(){return d.state.relicState.lastCardType},set lastCardType(e){d.state.relicState.lastCardType=e},get bachCounter(){return d.state.relicState.bachCounter},set bachCounter(e){d.state.relicState.bachCounter=e},get mozartTriggered(){return d.state.relicState.mozartTriggered},set mozartTriggered(e){d.state.relicState.mozartTriggered=e},tm:new V,reset(){this.tm.clearAll(),o.emit("clear-log"),d.reset()},getFrontAlly(){for(let e=this.allies.length-1;e>=0;e--)if(!this.allies[e].dead)return this.allies[e];return null},getCardCost(e){const t=I[e];if(!t)return 0;let a=t.cost;return!this.firstCardPlayed&&h.partyRoles.includes("flutist")?0:(!this.firstCardPlayed&&t.type==="atk"&&h.relics.includes("paganini_string")&&(a=Math.max(0,a-1)),(t.type==="duo"||t.type==="trio")&&h.partyRoles.includes("conductor")&&(a=Math.max(0,a-1)),a)},isCardPlayable(e){if(e.type==="duo"||e.type==="trio")return e.req.every(t=>{const a=this.allies.find(s=>s.role===t);return a&&!a.dead});if(e.owner&&e.owner!=="common"){const t=this.allies.find(a=>a.role===e.owner);return t&&!t.dead}return!0},startActualBattle(){document.getElementById("prep-ui").style.display="none",document.getElementById("hand").style.display="flex",document.getElementById("btn-end").style.display="block",document.getElementById("party-container").classList.remove("interactive"),H.selectedIdx=-1,o.emit("render-battlefield"),this.startTurn()},async startTurn(){d.setProcessing(!0),d.setPhase("PLAYER"),d.nextTurn(),this.turnCount>1&&this.allies.forEach(e=>{let t=h.relics.includes("tuning_fork")?10:0;e.retainBlock&&(t=e.block,e.retainBlock=!1),e.block=Math.max(0,Math.floor(e.block/2),Math.min(e.block,t))}),o.emit("log",{msg:`=== ç¬¬ ${this.turnCount} å›åˆ ===`,type:"turn"}),d.resetMana(),this.turnCount===1&&h.relics.includes("baton")&&(d.modifyMana(1),o.emit("toast","æŒ‡æŒ¥æ£’: çµæ„Ÿ+1")),document.getElementById("btn-end").disabled=!0,await this.drawCards(this.manaData.draw),d.setProcessing(!1),document.getElementById("btn-end").disabled=!1,o.emit("update-ui")},async drawCards(e){const t=[];let a=this.playerDeck,s=this.discard,n=this.hand;for(let i=0;i<e;i++){if(!a.length){if(!s.length)break;a=s.sort(()=>Math.random()-.5),s=[],d.setDeck(a),d.setDiscard(s)}const l=a.pop();n.push(l),t.push(l),d.setHand(n),await window.wait(150)}return t},selectCard(e){if(this.phase!=="PLAYER")return;const t=this.hand[e],a=window.CARDS[t];if(!this.isCardPlayable(a)){o.emit("toast","è§’è‰²å·²é˜µäº¡!");return}const s=this.getCardCost(t);if(this.manaData.current<s){o.emit("toast","çµæ„Ÿä¸è¶³");return}a.type==="atk"||a.type==="debuff"||a.type==="spec"||a.eff==="boom"||a.eff==="bash"?this.selectedCard===e?this.deselect():(this.selectedCard=e,o.emit("update-ui")):this.playCard(e,0)},targetEnemy(e){if(this.selectedCard===-1)return;const t=this.hand[this.selectedCard],a=window.CARDS[t];if(typeof e=="number"){const s=this.enemies[e];if(!s||s.hp<=0){o.emit("toast","ç›®æ ‡å·²å€’ä¸‹");return}this.playCard(this.selectedCard,e)}else{const s=document.body.getAttribute("data-hover-enemy-idx");if(s!==null){const n=parseInt(s),i=this.enemies[n];if(i&&i.hp>0){this.playCard(this.selectedCard,n);return}}if(a.tag==="aoe"||a.type==="skill"||a.type==="power")this.playCard(this.selectedCard,0);else{const n=this.enemies.findIndex(i=>i.hp>0);n!==-1?this.playCard(this.selectedCard,n):this.deselect()}}},async playCard(e,t=0){if(d.state.processing)return;d.setProcessing(!0);const a=this.hand[e],s=window.CARDS[a],n=this.getCardCost(a);!this.firstCardPlayed&&h.partyRoles.includes("flutist")&&s.cost>0&&o.emit("float-text",{text:"çµé£ï¼š0è´¹å‡ºç‰Œ",targetId:"hand",color:"#4dabf7"}),d.recordCardPlay(s,n),o.emit("animate-card-play",{card:s,handIndex:e});let i=0;s.eff==="hand_scale"&&(i=this.hand.length*3);const l=this.hand;l.splice(e,1),d.setHand(l);const r=this.discard;r.push(a),d.setDiscard(r),this.deselect(),o.emit("log",{msg:`æ‰“å‡º: <b>${s.name}</b>`,type:"card"}),s.eff==="stun"&&o.emit("play-sound","assets/ç‰¹å¤§é¼“é‡å‡».mp3"),(s.eff==="catastrophe"||s.name==="æ¯ç­äº¤å“")&&o.emit("play-sound","assets/å·¨å¤§è½°é¸£çˆ†ç‚¸.mp3"),(s.name==="ä¼‘æ­¢ç¬¦"||s.name==="èµ·æ‹")&&o.emit("play-sound","assets/BGM/accordion-attack.wav"),(s.name==="å˜å¥"||s.name==="æ‹¨å¥")&&o.emit("play-sound","assets/BGM/unsheathed-blade.ogg"),(s.name==="æ€¥æ¿"||s.name==="è¿å¼“")&&o.emit("play-sound","assets/BGM/sword-01.wav"),(s.name==="éœ‡è¡å·è§’"||s.name==="é«˜çˆ†éŸ³ç¬¦")&&o.emit("play-sound","assets/BGM/shipboard_railgun.mp3"),(s.name==="çƒ­æƒ…"||s.name==="å°¾å£°")&&o.emit("play-sound","assets/BGM/horror-piano-chord.mp3"),s.name==="ä¸åå’Œ"&&o.emit("play-sound","assets/BGM/violin-scare.wav"),(s.name==="ä½åŸ"||s.name==="é‡å¥"||s.name==="ç´å¼¦å£å’")&&o.emit("play-sound","assets/BGM/piano-string-glissando-low-a.wav");let c=1;if(s.tag==="atk"&&h.relics.includes("metronome")&&this.attacksPlayed===1&&(c=2,o.emit("toast","èŠ‚æ‹å™¨: åŒé‡å¥!")),s.tag==="atk"&&h.relics.includes("rosin"))if(s.tag==="aoe")this.enemies.forEach(v=>v.buffs.vuln+=1);else{const v=this.enemies[t];v&&(v.buffs.vuln+=1)}let m=this.allies.find(v=>v.role===s.owner);m||(m=this.getFrontAlly());let p=1+.5*(h.cardLevels[a]||0);this.variationBonus>0&&(p+=this.variationBonus,o.emit("float-text",{text:`å˜å¥ +${Math.round(this.variationBonus*100)}%!`,targetId:`char-${m.role}`,color:"#f0c040"}),this.variationBonus=0);let u=s.val;h.relics.includes("beethoven_ear")&&m.hp<m.maxHp*.3&&s.type==="atk"&&(u*=2,o.emit("float-text",{text:"å‘½è¿å’†å“®!",targetId:`char-${m.role}`,color:"#e74c3c"})),s.eff==="crescendo"&&(u+=this.crescendoStacks),s.cost>=2&&h.partyRoles.includes("brass")&&s.type==="atk"&&(u+=5),s.type==="atk"&&h.partyRoles.includes("percussionist")&&(u+=2),u>0&&(u=Math.ceil(u*p));const w=[];for(let v=0;v<c;v++){const x=new Promise(C=>{setTimeout(async()=>{await this.executeCardEffect(s,m,u,p,i,t),C()},v*300)});w.push(x)}await Promise.all(w),this.attacksPlayed===1&&h.relics.includes("paganini_string")&&s.type==="atk"&&(m.hp-=2,o.emit("float-text",{text:"-2",targetId:`char-${m.role}`,color:"#888"}),m.hp<=0&&(m.hp=0,m.dead=!0)),h.relics.includes("bach_lens")&&(this.lastCardType===s.type?(this.bachCounter++,this.bachCounter>=3&&(await this.drawCards(1),this.manaData.current++,o.emit("toast","èµ‹æ ¼é€é•œ: å®Œç¾å¯¹ä½!"),this.bachCounter=0)):(this.lastCardType=s.type,this.bachCounter=1)),d.setProcessing(!1),o.emit("update-ui")},async executeCardEffect(e,t,a,s,n=0,i=0){if(e.effects&&Array.isArray(e.effects))for(const l of e.effects)await this.processEffect(l,t,s,a,n,i);else console.warn(`Card ${e.name} (ID: ${e.id}) has no effects configuration.`);o.emit("update-ui")},async processEffect(e,t,a,s,n,i){let l=e.val!==void 0?e.val:s;if(e.scale&&(e.val!==void 0?l=Math.ceil(l*a):(l=s,n>0&&(l+=n))),e.delay&&await window.wait(e.delay),e.target==="all"&&(e.type==="dmg"||e.type==="status")){for(let r=0;r<this.enemies.length;r++)if(this.enemies[r].hp>0){const c={...e,_tempTargetIdx:r};await P.execute(this,c,t,l,a)}return}e._tempTargetIdx=i,await P.execute(this,e,t,l,a)},dmgEnemy(e,t=!1,a=0){if(this.phase==="VICTORY")return;const s=this.enemies[a];if(!s||s.hp<=0)return;s.buffs.vuln>0&&(e=Math.floor(e*1.5));let n=e;if(!t&&s.block>0){let i=Math.min(s.block,n);s.block-=i,n-=i,i>0&&o.emit("float-text",{text:"æ ¼æŒ¡",targetId:a===0?"sprite-enemy":`sprite-enemy-${a}`,color:"#3498db"})}s.hp=Math.max(0,s.hp-n),n>0&&(o.emit("float-text",{text:`-${n}`,targetId:a===0?"sprite-enemy":`sprite-enemy-${a}`,color:"#ff6b6b"}),o.emit("log",{msg:`å¯¹ ${s.name} é€ æˆ ${n} ä¼¤å®³`,type:"dmg"})),n>10&&o.emit("shake"),s.hp<=0&&!s.dead&&(s.dead=!0,s.isDying=!0,setTimeout(()=>{s.isDying=!1,o.emit("update-ui")},1200)),o.emit("update-ui"),this.enemies.every(i=>i.hp<=0)&&this.win()},healAll(e){this.allies.forEach(t=>{t.dead||(t.hp=Math.min(t.maxHp,t.hp+e),o.emit("float-text",{text:`+${e}`,targetId:`char-${t.role}`,color:"#2ecc71"}))}),o.emit("log",{msg:`[æ²»ç–—] å…¨å‘˜æ¢å¤ ${e} HP`,type:"heal"}),o.emit("update-ui")},healPlayer(e){let t=this.allies.filter(a=>!a.dead).sort((a,s)=>a.hp/a.maxHp-s.hp/s.maxHp)[0];t&&(t.hp=Math.min(t.maxHp,t.hp+e),o.emit("float-text",{text:`+${e}`,targetId:`char-${t.role}`,color:"#2ecc71"}),o.emit("log",{msg:`[æ²»ç–—] ${t.name} æ¢å¤ ${e} HP`,type:"heal"})),o.emit("update-ui")},addBlockAll(e){this.allies.forEach(t=>{t.dead||(t.block+=e)}),o.emit("log",{msg:`[æŠ¤ç›¾] å…¨å‘˜è·å¾— ${e} æŠ¤ç›¾`,type:"block"}),o.emit("play-sound","assets/BGM/shield.wav"),o.emit("update-ui")},win(){this.phase="VICTORY",this.tm.clearAll(),o.emit("stop-bgm"),o.emit("play-sound","assets/BGM/victory.wav");const e=this.playerDeck.concat(this.hand,this.discard);d.setDeck(e),d.setHand([]),d.setDiscard([]);let t=20+Math.floor(Math.random()*10);this.enemy.type==="elite"&&(t=50+Math.floor(Math.random()*15)),this.enemy.type==="boss"&&(t=100),h.addGold(t),this.enemy.type==="boss"&&(window.game.mapGraph=[]),h.level%5===0&&o.emit("toast","BOSS å‡»ç ´! å®Œç¾æ¼”å‡º!"),setTimeout(()=>{this.enemy.type==="battle"?(y.switchScene("scene-reward"),y.renderUpgradeRewards(t)):(o.emit("toast",`è·å¾—é‡‘å¸: ${t}`),(this.enemy.type==="elite"||this.enemy.type==="boss")&&window.game.campAction("relic"))},1e3)},endTurn(){if(d.state.processing)return;this.phase="ENEMY_TURN",document.getElementById("btn-end").disabled=!0;const e=this.discard.concat(this.hand);d.setDiscard(e),d.setHand([]),o.emit("update-ui"),this.tm.add(()=>this.enemyAction(),800)},async enemyAction(){if(this.phase!=="VICTORY"){h.partyRoles.includes("vocalist")&&this.healAll(5);for(let e=0;e<this.enemies.length;e++){const t=this.enemies[e];if(t.hp<=0)continue;t.block=0;const a=e===0?"sprite-enemy":`sprite-enemy-${e}`,s=document.getElementById(a);if(t.stunned)o.emit("toast",`${t.name} è¢«å†°å†»!`),t.stunned=!1,await window.wait(800);else{let n=t.intent.type,i=t.intent.val;if(n==="atk"||n==="atk_heavy"||n==="atk_vuln"){if(s){let m="anim-enemy-atk";t.name==="å¤±å¾‹å«å£«"&&(m="anim-knight-attack"),t.name==="å¤±è¡¡èˆè€…"&&(m="anim-dancer-attack"),t.name==="å¯‚é™æŒ‡æŒ¥å®¶"&&(m="anim-demon-cast"),t.name==="æ¶æ„å…«éŸ³ç›’"&&(m="anim-bayinhe-attack"),t.name==="æ‚éŸ³å”±è¯—ç­"&&(m="anim-choir-attack"),t.name==="æ‚éŸ³å¾®ç²’"&&(m="anim-slime-atk");const f=this.getFrontAlly(),p=f?document.getElementById(`char-${f.role}`):null;if(p){const x=s.getBoundingClientRect(),S=p.getBoundingClientRect().left-x.left+60;s.style.setProperty("--attack-dist",`${S}px`)}s.classList.remove("anim-knight-attack","anim-dancer-attack","anim-demon-cast","anim-bayinhe-attack","anim-choir-attack","anim-enemy-atk","anim-slime-atk"),s.classList.remove("enemy-idle-breathe");const u=m!=="anim-enemy-atk",w=`url('${t.sprite}')`;u?s.style.backgroundImage="":s.style.backgroundImage=w,s.offsetWidth,s.classList.add(m);const v=t.name==="å¯‚é™æŒ‡æŒ¥å®¶"||t.name==="æ¶æ„å…«éŸ³ç›’"?1500:1200;setTimeout(()=>{s.classList.remove(m),s.classList.add("enemy-idle-breathe"),s.style.backgroundImage=w},v),t.name==="å¤±å¾‹å«å£«"&&o.emit("play-sound","assets/BGM/monster.wav")}let l=600;if(t.name==="å¤±å¾‹å«å£«"&&(l=710),t.name==="å¤±è¡¡èˆè€…"&&(l=450),t.name==="å¯‚é™æŒ‡æŒ¥å®¶"&&(l=750),t.name==="æ¶æ„å…«éŸ³ç›’"&&(l=750),t.name==="æ‚éŸ³å”±è¯—ç­"&&(l=480),t.name==="æ‚éŸ³å¾®ç²’"&&(l=600),await window.wait(l),this.phase==="VICTORY")return;let r=parseInt(i)+parseInt(t.buffs.str||0),c=this.getFrontAlly();if(c){t.name==="æ‚éŸ³å”±è¯—ç­"&&(o.emit("spawn-vfx",{type:"Psychic_Shriek",targetId:a}),o.emit("play-sound","assets/BGM/attack-cannibal-beast.wav")),t.name==="æ‚éŸ³å¾®ç²’"&&(o.emit("spawn-vfx",{type:"heavy_hit",targetId:`char-${c.role}`}),o.emit("play-sound","assets/BGM/shadowboss_attack.wav")),t.name==="å¤±å¾‹å«å£«"&&(o.emit("spawn-vfx",{type:"Heavy_Rending",targetId:`char-${c.role}`}),o.emit("spawn-vfx",{type:"Blood_Splatter",targetId:`char-${c.role}`})),t.name==="å¤±è¡¡èˆè€…"&&(o.emit("spawn-vfx",{type:"Sharp_Slash",targetId:`char-${c.role}`}),o.emit("spawn-vfx",{type:"Blood_Splatter",targetId:`char-${c.role}`})),t.name==="å¯‚é™æŒ‡æŒ¥å®¶"&&(o.emit("spawn-vfx",{type:"Boss_wave",targetId:`char-${c.role}`}),o.emit("play-sound","assets/BGM/nastyattack.wav")),t.name==="æ¶æ„å…«éŸ³ç›’"&&(o.emit("spawn-vfx",{type:"Heavy_Rending",targetId:`char-${c.role}`}),o.emit("spawn-vfx",{type:"Blood_Splatter",targetId:`char-${c.role}`}));const m=document.getElementById(`char-${c.role}`);if(m&&(m.classList.remove("anim-ally-hit"),m.offsetWidth,m.classList.add("anim-ally-hit")),c.block>0){let f=Math.min(c.block,r);c.block-=f,r-=f}if(r>0){if(c.hp=Math.max(0,c.hp-r),o.emit("float-text",{text:`-${r}`,targetId:`char-${c.role}`,color:"#cc0000"}),o.emit("log",{msg:`${t.name} æ”»å‡» ${c.name} é€ æˆ ${r} ä¼¤å®³`,type:"enemy"}),o.emit("shake"),c.hp<=0&&(c.hp=0,c.dead=!0,c.block=0,o.emit("toast",`${c.name} å€’ä¸‹äº†!`),h.relics.includes("mozart_quill")&&!this.mozartTriggered&&(this.dmgEnemy(30,!0,e),this.mozartTriggered=!0),this.allies.every(f=>f.dead))){this.lose();return}}else o.emit("float-text",{text:"æ ¼æŒ¡!",targetId:`char-${c.role}`,color:"#3498db"})}await window.wait(600)}else{let l=800;if(n==="def"||n==="def_block"){let r=Math.floor(n==="def_block"?t.maxHp*.25:t.maxHp*.1);t.block+=r,o.emit("float-text",{text:`æŠ¤ç›¾+${r}`,targetId:a,color:"#3498db"}),t.name==="å¤±å¾‹å«å£«"&&s&&(s.classList.remove("anim-knight-defend","enemy-idle-breathe"),s.offsetWidth,s.classList.add("anim-knight-defend"),o.emit("play-sound","assets/BGM/shield.wav"),setTimeout(()=>{s.classList.remove("anim-knight-defend"),s.classList.add("enemy-idle-breathe")},1200),l=1300)}else if(n==="buff"||n==="buff_str"){let r=n==="buff_str"?3:2;t.buffs.str+=r,o.emit("float-text",{text:`åŠ›é‡+${r}`,targetId:a,color:"#e74c3c"}),t.name==="å¯‚é™æŒ‡æŒ¥å®¶"&&s&&(s.classList.remove("anim-demon-buff","enemy-idle-breathe"),s.offsetWidth,s.classList.add("anim-demon-buff"),o.emit("play-sound","assets/BGM/piano-string-glissando-low-a.wav"),setTimeout(()=>{s.classList.remove("anim-demon-buff"),s.classList.add("enemy-idle-breathe")},1500),l=1600),t.name==="æ¶æ„å…«éŸ³ç›’"&&s&&(s.classList.remove("anim-bayinhe-buff","enemy-idle-breathe"),s.offsetWidth,s.classList.add("anim-bayinhe-buff"),o.emit("play-sound","assets/BGM/monster.wav"),setTimeout(()=>{s.classList.remove("anim-bayinhe-buff"),s.classList.add("enemy-idle-breathe")},1200),l=1300)}else n==="debuff"&&(t.buffs.vuln=0,o.emit("float-text",{text:"å‡€åŒ–",targetId:a,color:"#fff"}),t.name==="å¯‚é™æŒ‡æŒ¥å®¶"&&s&&(s.classList.remove("anim-demon-buff","enemy-idle-breathe"),s.offsetWidth,s.classList.add("anim-demon-buff"),o.emit("play-sound","assets/BGM/piano-string-glissando-low-a.wav"),setTimeout(()=>{s.classList.remove("anim-demon-buff"),s.classList.add("enemy-idle-breathe")},1500),l=1600));await window.wait(l)}}o.emit("update-ui"),await window.wait(400)}this.enemies.forEach(e=>{e.buffs.vuln>0&&e.buffs.vuln--}),this.tempStrDebuff>0&&(this.enemies.forEach(e=>e.buffs.str+=this.tempStrDebuff),this.tempStrDebuff=0),this.planEnemy(),await window.wait(600),this.startTurn()}},lose(){this.phase="DEFEAT",this.tm.clearAll(),o.emit("stop-bgm"),o.emit("play-sound","assets/BGM/horror-piano-chord.mp3"),o.emit("toast","ä¹ç« ç»ˆç»“... æ¼”å‡ºå¤±è´¥"),setTimeout(()=>{y.switchScene("scene-menu")},2e3)},planEnemy(){this.enemies.forEach(e=>{if(e.hp<=0)return;let t=5+Math.floor(h.level*1.5),s=[...e.acts||["atk"]];e.name==="å¯‚é™æŒ‡æŒ¥å®¶"&&e.buffs.vuln===0&&(s=s.filter(l=>l!=="debuff")),e.name==="æ¶æ„å…«éŸ³ç›’"&&(e.buffs.str||0)>=6&&(s=s.filter(l=>l!=="buff_str")),s.length===0&&(s=["atk"]);const n=s[Math.floor(Math.random()*s.length)],i={atk:{type:"atk",val:t,icon:"assets/UI/attack.png"},def:{type:"def",val:0,icon:"assets/UI/Defend.png"},buff:{type:"buff",val:0,icon:"assets/UI/Mana.png"},debuff:{type:"debuff",val:0,icon:"assets/UI/Debuff.png"},atk_heavy:{type:"atk_heavy",val:Math.floor(t*1.5),icon:"assets/UI/attack.png"},atk_vuln:{type:"atk_vuln",val:Math.floor(t*.8),icon:"assets/UI/Debuff.png"},buff_str:{type:"buff_str",val:0,icon:"assets/UI/Mana.png"},def_block:{type:"def_block",val:0,icon:"assets/UI/Defend.png"}};e.intent=i[n]||i.atk})},deselect(){this.selectedCard=-1,o.emit("update-ui")}},X={get partyRoles(){return h.partyRoles},get level(){return h.level},get relics(){return h.relics},get cardLevels(){return h.cardLevels},get gold(){return h.gold},set gold(e){console.warn("Use gameStore.addGold/spendGold instead")},start(){o.emit("update-ui"),y.switchScene("scene-select"),y.renderCharSelect("grid-start",e=>this.initParty(e)),o.emit("play-bgm","assets/BGM/Ravel_Gaspard de la Nuit.mp3")},initParty(e,t=!0){h.initGame(e),window.battle.reset(),this.mapGraph=[],this.currentMapPos={layer:-1,index:-1};const a=M[e];window.battle.manaData.current=3,window.battle.manaData.max=3,window.battle.manaData.draw=5,e==="pianist"&&(window.battle.manaData.max=4),e==="violinist"&&(window.battle.manaData.draw+=1),d.setAllies([this.createAlly(e)]);const s=[...A,...a.deck];d.setDeck([...s]),t&&this.mapSelect()},createAlly(e){const t=M[e];return{role:e,name:t.name,hp:t.hp,maxHp:t.hp,block:0,dead:!1}},mapSelect(){o.emit("play-bgm","assets/BGM/Ravel_Gaspard de la Nuit.mp3"),y.switchScene("scene-map"),o.emit("update-ui");const e=document.getElementById("map-level-num");e&&(e.innerText=h.level),this.mapGraph.length===0&&(this.generateSectorMap(),this.currentMapPos={layer:-1,index:-1}),y.renderMap(this.mapGraph,this.currentMapPos)},generateSectorMap(){const e=[];e.push([{type:"start",name:"èµ·ç‚¹",desc:"æ–°çš„ä¹ç« å¼€å§‹",next:[]}]);for(let a=1;a<5;a++){const s=2+Math.floor(Math.random()*2),n=[];for(let i=0;i<s;i++){let l="battle",r=Math.random();r<.15?l="camp":r<.35?l="shop":r<.45&&a>1?l="elite":r<.55&&h.partyRoles.length<4?l="recruit":l="battle";let c="é­é‡æˆ˜";l==="camp"&&(c="è¥åœ°"),l==="shop"&&(c="ä¹å™¨åº—"),l==="elite"&&(c="ç²¾è‹±æˆ˜"),l==="recruit"&&(c="éŸ³ä¹å…"),n.push({type:l,name:c,next:[]})}e.push(n)}e.push([{type:"boss",name:"å†³æˆ˜",desc:"æœ€ç»ˆè€ƒéªŒ",next:[]}]);for(let a=0;a<5;a++){const s=e[a],n=e[a+1];s.forEach(i=>{if(a===0)n.forEach((l,r)=>i.next.push(r));else{const l=1+(Math.random()>.5?1:0);for(let r=0;r<l;r++){const c=Math.floor(Math.random()*n.length);i.next.includes(c)||i.next.push(c)}}}),n.forEach((i,l)=>{if(!s.some(c=>c.next.includes(l))){const c=Math.floor(Math.random()*s.length);s[c].next.push(l)}}),s.forEach(i=>i.next.sort((l,r)=>l-r))}this.mapGraph=e},enterNode(e,t,a){if(this.currentMapPos={layer:t,index:a},e==="start"){this.mapSelect();return}e==="recruit"?(y.switchScene("scene-recruit"),setTimeout(()=>y.renderCharSelect("grid-recruit",s=>this.recruit(s)),100)):e==="camp"?this.showCamp():e==="shop"?this.showShop():this.startLevel(e)},shopData:{cards:[],relics:[],services:[]},showShop(){y.switchScene("scene-shop"),this.shopData={cards:[],relics:[],services:[]};const e=[...new Set(d.deck)].filter(s=>h.getCardLevel(s)<5);e.sort(()=>Math.random()-.5),e.slice(0,3).forEach(s=>{const n=h.getCardLevel(s),i=50+n*25;this.shopData.cards.push({id:s,price:i,sold:!1,level:n})});const a=Object.keys(T).filter(s=>!h.relics.includes(s));if(a.length>0){const s=a[Math.floor(Math.random()*a.length)];this.shopData.relics.push({key:s,price:160,sold:!1})}this.shopData.services.push({type:"remove",name:"å¿˜å´ä¹è°±",desc:"ä»ç‰Œç»„ä¸­ç§»é™¤ä¸€å¼ ç‰Œ",price:75,sold:!1,icon:"assets/UI/banish_icon.png"}),this.shopData.services.push({type:"heal",name:"èŒ¶æ­‡",desc:"å…¨å‘˜æ¢å¤ 30% ç”Ÿå‘½",price:50,sold:!1,icon:"assets/UI/heal_icon.png"}),window.UI.renderShop(this.shopData),o.emit("update-ui")},buyItem(e,t){let a=this.shopData[e][t];if(!a.sold){if(h.gold<a.price){o.emit("toast","é‡‘å¸ä¸è¶³!");return}if(e==="cards")h.spendGold(a.price),h.upgradeCard(a.id),o.emit("toast",`å¼ºåŒ–æˆåŠŸ: ${I[a.id].name} +${h.getCardLevel(a.id)}`),a.sold=!0;else if(e==="relics")h.spendGold(a.price),h.addRelic(a.key),o.emit("toast",`è´­ä¹°äº† ${T[a.key].name}`),a.sold=!0;else if(e==="services"){if(a.type==="heal")h.spendGold(a.price),window.battle.allies.forEach(s=>{s.dead?(s.dead=!1,s.hp=Math.floor(s.maxHp*.3)):s.hp=Math.min(s.maxHp,s.hp+Math.floor(s.maxHp*.3))}),o.emit("toast","å…¨å‘˜æ¢å¤!"),a.sold=!0;else if(a.type==="remove"){if(d.deck.length<=5){o.emit("toast","å¡ç»„è¿‡è–„ï¼Œæ— æ³•ç§»é™¤");return}y.showDeckModal(d.deck,"é€‰æ‹©è¦ç§»é™¤çš„å¡ç‰Œ",(s,n)=>{if(h.gold>=a.price){h.spendGold(a.price);const i=d.deck;i.splice(n,1),d.setDeck(i),o.emit("toast","ç§»é™¤æˆåŠŸ"),a.sold=!0,y.closeDeckModal(),y.renderShop(this.shopData),o.emit("update-ui")}});return}}y.renderShop(this.shopData),o.emit("update-ui")}},leaveShop(){this.mapSelect()},startLevel(e,t=null){try{window.battle.reset(),y.setBattleBackground(e),window.battle.allies.forEach(i=>{i.role==="cellist"&&(i.block=8)}),h.relics.includes("baton")&&window.battle.manaData.current++;let a=[],s=1;if(t){const i=Array.isArray(t)?t:[t];i.forEach(r=>{B[r]&&a.push({data:B[r],key:r})}),e=e==="debug"?"battle":e;const l=i[0];o.emit("stop-bgm"),l==="silence"?o.emit("play-bgm","assets/BGM/Scythian Suite.mp3"):l==="shihengwuzhe"?o.emit("play-bgm","assets/BGM/Shostakovich_String Quartet.mp3"):o.emit("play-bgm","assets/BGM/Bruckner.mp3")}else if(e==="boss")a.push({data:B.silence,key:"silence"}),s=3,o.emit("play-bgm","assets/BGM/Scythian Suite.mp3");else if(e==="elite"){const i=["discord","shihengwuzhe"],l=i[Math.floor(Math.random()*i.length)];a.push({data:B[l],key:l}),s=1.8,o.emit("stop-bgm"),l==="shihengwuzhe"?o.emit("play-bgm","assets/BGM/Shostakovich_String Quartet.mp3"):l==="discord"&&o.emit("play-bgm","assets/BGM/Mahler - Symphony.mp3")}else{const i=["noise","bayinhe","changshiban"],l=i[Math.floor(Math.random()*i.length)];a.push({data:B[l],key:l}),s=1,o.emit("stop-bgm"),l==="changshiban"?o.emit("play-bgm","assets/BGM/bin ich nun frei.m4a"):o.emit("play-bgm","assets/BGM/Bruckner.mp3")}const n=a.map(i=>{const l=i.data,r=(30+h.level*8)*s;return{type:e,name:l.name,sprite:l.sprite,hp:Math.floor(r*l.hpScale),maxHp:Math.floor(r*l.hpScale),block:0,intent:{type:"atk",val:0},stunned:!1,buffs:{vuln:0,res:0,str:0},acts:l.act}});if(d.setEnemies(n),typeof window.battle.planEnemy=="function")window.battle.planEnemy();else throw new Error("window.battle.planEnemy is missing!");y.switchScene("scene-battle"),window.battle.phase="PREPARE",o.emit("render-battlefield"),o.emit("update-ui"),document.getElementById("prep-ui").style.display="block",document.getElementById("hand").style.display="none",document.getElementById("btn-end").style.display="none",document.getElementById("party-container").classList.add("interactive")}catch(a){console.error("Start Level Error:",a),o.emit("toast","è¿›å…¥æˆ˜æ–—å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°")}},recruit(e){if(h.partyRoles.includes(e))return;h.recruitMember(e);const t=M[e];window.battle.manaData.max+=1,window.battle.manaData.draw+=1,e==="violinist"&&(window.battle.manaData.draw+=1);const a=d.allies;a.push(this.createAlly(e)),d.setAllies(a);const s=d.deck;s.push(...t.deck),d.setDeck(s),e==="vocalist"&&window.battle.allies.forEach(n=>n.maxHp+=15),this.checkDuo(),o.emit("toast",`${t.name} åŠ å…¥! æ‰‹ç‰Œä¸Šé™+1`),setTimeout(()=>this.mapSelect(),1e3),h.nextLevel()},checkDuo(){L.forEach(e=>{e.req.every(t=>h.partyRoles.includes(t))})},showCamp(){y.switchScene("scene-camp")},getSmartRewards(){const e=L.filter(s=>s.req.every(n=>h.partyRoles.includes(n))).map(s=>s.id);if(e.length===0)return[];const t=[],a=[...e];for(let s=0;s<3&&a.length!==0;s++){const n=Math.floor(Math.random()*a.length);t.push(a[n]),a.splice(n,1)}return t},campAction(e){if(e==="heal")window.battle.allies.forEach(t=>{t.dead?(t.dead=!1,t.hp=Math.floor(t.maxHp*.3)):t.hp=Math.min(t.maxHp,t.hp+Math.floor(t.maxHp*.3))}),o.emit("toast","ä¼‘æ•´å®Œæˆ");else if(e==="card"){y.switchScene("scene-reward"),y.renderRewards("new");return}else if(e==="upgrade"){let t=[...new Set([...d.deck])],a=[];if(t.length>0){for(let s=0;s<2&&t.length!==0;s++){const n=Math.floor(Math.random()*t.length),i=t[n];if(h.getCardLevel(i)>=5){t.splice(n,1),s--;continue}h.upgradeCard(i);const l=h.getCardLevel(i);a.push(I[i].name+(l>0?`+${l}`:"")),t.splice(n,1)}a.length>0?o.emit("toast",`æŠ€è‰ºç²¾è¿›: ${a.join(", ")}`):o.emit("toast","æ‰€æœ‰æŠ€èƒ½å·²è¾¾åŒ–å¢ƒ (Max 5)")}}else if(e==="relic"){const a=Object.keys(T).filter(s=>!h.relics.includes(s));if(a.length>0){const s=a[Math.floor(Math.random()*a.length)];h.addRelic(s),o.emit("toast",`è·å¾—åœ£ç‰©: ${T[s].name}`)}else window.battle.allies.forEach(s=>{s.maxHp+=10,s.hp+=10}),o.emit("toast","è·å¾—: å¤©ä½¿ä¹‹ç¾½ (å…¨å±æ€§æå‡)")}setTimeout(()=>{h.nextLevel(),this.mapSelect()},1200)},finishReward(){h.nextLevel(),this.mapSelect()},showDeck(){const e=document.getElementById("scene-battle").classList.contains("active");let t=[];e?t=[...d.deck,...d.hand,...d.discard]:t=d.deck,y.showDeckModal(t,`å½“å‰å¡ç»„ (${t.length})`)},closeDeck(){y.closeDeckModal()},previewDeck(e,t){const a=M[e];let s=[];t==="start"?s=[...A,...a.deck]:s=[...a.deck],y.showDeckModal(s,`${a.name} - æŠ€èƒ½é¢„è§ˆ`)},debugEnemiesQueue:[],openDebugMenu(){if(y.switchScene("scene-debug"),h.partyRoles.length===0){h.initGame("pianist"),d.reset(),d.setAllies([this.createAlly("pianist")]);const e=M.pianist;d.setDeck([...A,...e.deck])}this.renderDebugUI()},renderDebugUI(){const e=document.getElementById("debug-party-list");e.innerHTML="",h.partyRoles.forEach(n=>{const i=M[n],l=document.createElement("div");l.className="relic",l.style.width="50px",l.style.height="50px",l.style.fontSize="1.5em",l.innerHTML=`<img src="${i.sprite}" style="width:100%;height:100%;object-fit:contain;filter:brightness(1.5);">`,l.title=i.name,e.appendChild(l)});const t=document.getElementById("debug-role-pool");t.innerHTML="",Object.keys(M).forEach(n=>{if(h.partyRoles.includes(n))return;const i=M[n],l=document.createElement("button");l.className="top-btn",l.style.fontSize="0.8em",l.innerText=`+ ${i.name}`,l.onclick=()=>{this.debugAddRole(n)},t.appendChild(l)});const a=document.getElementById("debug-enemy-queue");a.innerHTML="",this.debugEnemiesQueue.forEach((n,i)=>{const l=B[n],r=document.createElement("div");r.className="relic",r.style.borderColor="#e67e22",r.innerHTML=`<img src="${l.sprite}" style="width:80%;height:80%;object-fit:contain;">`,r.onclick=()=>{this.debugEnemiesQueue.splice(i,1),this.renderDebugUI()},a.appendChild(r)});const s=document.getElementById("debug-enemy-pool");s.innerHTML="",Object.keys(B).forEach(n=>{const i=B[n],l=document.createElement("div");l.className="char-card",l.style.width="100px",l.style.height="120px",l.style.padding="5px",l.innerHTML=`
                <img src="${i.sprite}" style="height:60px; object-fit:contain;">
                <div style="font-size:0.7em; margin-top:5px;">${i.name}</div>
            `,l.onclick=()=>{this.debugEnemiesQueue.push(n),this.renderDebugUI()},s.appendChild(l)})},debugAddRole(e){if(h.partyRoles.length>=4){o.emit("toast","é˜Ÿä¼å·²æ»¡ (ä¸Šé™4äºº)");return}h.recruitMember(e);const t=M[e],a=d.allies;a.push(this.createAlly(e)),d.setAllies(a);const s=d.deck;s.push(...t.deck),d.setDeck(s),this.renderDebugUI()},debugClearParty(){h.clearParty(),d.setAllies([]),d.setDeck([]),this.renderDebugUI()},debugStartBattle(){if(h.partyRoles.length===0){o.emit("toast","è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€åæ¼”å¥è€…");return}if(this.debugEnemiesQueue.length===0){o.emit("toast","è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ªæ•Œäºº");return}this.startLevel("debug",this.debugEnemiesQueue)}};window.PATHS=g;window.COMMON_DECK=A;window.ROLES=M;window.ENEMIES=B;window.RELICS=T;window.CARDS=I;window.DUO_CARDS=L;window.UI=y;window.battle=j;window.game=X;document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("btn-start-game");e&&e.addEventListener("click",()=>{window.game?window.game.start():console.error("Game object not initialized!")})});
