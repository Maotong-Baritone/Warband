(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();window.TimerManager=class{constructor(){this.timers=[]}add(i,t){const n=setTimeout(i,t);return this.timers.push(n),n}clearAll(){this.timers.forEach(i=>clearTimeout(i)),this.timers=[]}};window.PATHS={roles:"assets/Roles/",enemies:"assets/Enemies/",vfx:"assets/vfx/",cards:"assets/Cards/"};window.COMMON_DECK=[2,3,4,6,7,17,18];window.ROLES={pianist:{id:"pianist",name:"å¹»å¥è£å†³è€…",hp:60,sprite:window.PATHS.roles+"pianist.png",deck:[1,19,30],buff:"çµæ„Ÿä¸Šé™ +1"},violinist:{id:"violinist",name:"é“¶å¼¦åœ£å¾’",hp:50,sprite:window.PATHS.roles+"violinist.png",deck:[5,20,31],buff:"æ‰‹ç‰Œä¸Šé™ +1"},vocalist:{id:"vocalist",name:"é•‡é­‚åŸå”±è€…",hp:45,sprite:window.PATHS.roles+"vocalist.png",deck:[8,9,10],buff:"å›åˆç»“æŸå› 5 HP"},cellist:{id:"cellist",name:"æ²‰éŸ³å®ˆæœ›è€…",hp:75,sprite:window.PATHS.roles+"cellist.png",deck:[11,12,13],buff:"åˆå§‹è·å¾— 8 æŠ¤ç›¾"},brass:{id:"brass",name:"ç ´æ™“å·æ‰‹",hp:70,sprite:window.PATHS.roles+"brass.png",deck:[14,15,16],buff:"é«˜è´¹å¡(>=2)é¢å¤–+5ä¼¤å®³"},flutist:{id:"flutist",name:"çµé£è¡Œè€…",hp:45,sprite:window.PATHS.roles+"flutist.png",deck:[24,25,26],buff:"æ¯å›åˆç¬¬ä¸€å¼ ç‰Œå˜ä¸ºæ— æ¶ˆè€—"},percussionist:{id:"percussionist",name:"é›·éœ†éœ‡å‡»è€…",hp:70,sprite:window.PATHS.roles+"percussionist.png",deck:[27,28,29],buff:"æ”»å‡»ä¼¤å®³ +2"},conductor:{id:"conductor",name:"çµé­‚ç»‡å¾‹è€…",hp:55,sprite:window.PATHS.roles+"conductor.png",deck:[21,22,23],buff:"åˆå¥ç‰Œæ¶ˆè€— -1"}};window.RELICS={metronome:{name:"èŠ‚æ‹å™¨",icon:"â°",desc:"æ¯å›åˆç¬¬ä¸€å¼ æ”»å‡»ç‰Œæ‰“å‡ºä¸¤æ¬¡"},rosin:{name:"æ¾é¦™",icon:"ğŸ§‚",desc:"æ¯æ¬¡é€ æˆä¼¤å®³æ—¶æ–½åŠ  1 å±‚æ˜“ä¼¤"},baton:{name:"æŒ‡æŒ¥æ£’",icon:"ğŸª„",desc:"æˆ˜æ–—å¼€å§‹æ—¶é¢å¤–è·å¾— 1 ç‚¹çµæ„Ÿ"},tuning_fork:{name:"éŸ³å‰",icon:"Y",desc:"å›åˆç»“æŸæ—¶ä¿ç•™ 10 ç‚¹æŠ¤ç›¾"},sheet_music:{name:"å¤è€ä¹è°±",icon:"ğŸ“œ",desc:"æ‰€æœ‰åˆå§‹å¡ç‰Œç­‰çº§+1"},beethoven_ear:{name:"è´å¤šèŠ¬çš„å¤±èªè€³èœ—",icon:"ğŸ‘‚",desc:"HP < 30% æ—¶ï¼Œé€ æˆä¼¤å®³ç¿»å€"},paganini_string:{name:"å¸•æ ¼å°¼å°¼çš„æ–­å¼¦",icon:"ğŸ»",desc:"é¦–å¼ æ”»å‡»ç‰Œè€—èƒ½-1ï¼Œä½†è‡ªä¼¤ 2 ç‚¹"},mozart_quill:{name:"è«æ‰ç‰¹çš„å®‰é­‚ç¾½ç¬”",icon:"âœ’ï¸",desc:"é˜Ÿå‹æ¿’æ­»æ—¶ï¼Œå¯¹æ•Œé€ æˆ 30 çœŸå®ä¼¤å®³"},bach_lens:{name:"å·´èµ«çš„èµ‹æ ¼é€é•œ",icon:"ğŸ”",desc:"è¿ç»­æ‰“å‡º 3 å¼ åŒç±»ç‰Œï¼ŒæŠ½1ç‰Œ+1è´¹"},liszt_bullet:{name:"ææ–¯ç‰¹çš„é­”å¼¹",icon:"ğŸ¹",desc:"æ‰€æœ‰å¤šæ®µæ”»å‡»æ¬¡æ•° +1"}};window.ENEMIES={noise:{name:"æ‚éŸ³å¾®ç²’",sprite:window.PATHS.enemies+"slime.png",hpScale:1,act:["atk"]},discord:{name:"å¤±å¾‹å«å£«",sprite:window.PATHS.enemies+"knight.png",hpScale:1.5,act:["atk","atk","atk","def"]},silence:{name:"å¯‚é™æŒ‡æŒ¥å®¶",sprite:window.PATHS.enemies+"demon.png",hpScale:2.5,act:["atk","atk","buff","debuff"]},bayinhe:{name:"æ¶æ„å…«éŸ³ç›’",sprite:window.PATHS.enemies+"bayinhe.png",hpScale:1.2,act:["buff_str","buff_str","atk_heavy"]},changshiban:{name:"æ‚éŸ³å”±è¯—ç­",sprite:window.PATHS.enemies+"changshiban.png",hpScale:1.8,act:["atk_vuln","atk","atk_vuln"]},shihengwuzhe:{name:"å¤±è¡¡èˆè€…",sprite:window.PATHS.enemies+"shihengwuzhe.png",hpScale:2,act:["atk_heavy","atk_heavy","def_block"]}};window.DUO_CARDS=[{id:101,name:"å†¬ä¹‹æ—…",cost:1,req:["pianist","vocalist"],val:12,desc:"{val} ä¼¤å®³ + å†°å†»ã€‚",img:window.PATHS.cards+"dongzhilv.png",type:"duo",act:(e,i)=>{e.dmgEnemy(Math.ceil(12*i)),window.UI.toast("å¯’å†¬é™ä¸´..."),e.enemy.stunned=!0,window.UI.spawnVFX("ice","sprite-enemy")}},{id:102,name:"å…‹é²é‡‡",cost:0,req:["pianist","violinist"],val:6,desc:"ç‹‚æš´ {val} ä¼¤å®³ x 4 æ¬¡ã€‚",img:window.PATHS.cards+"kelucai.png",type:"duo",act:(e,i)=>{for(let t=0;t<4;t++)e.tm.add(()=>{e.dmgEnemy(Math.ceil(6*i)),window.UI.spawnVFX("slash","sprite-enemy")},t*150)}},{id:103,name:"ç»¿æ ‘æˆè«",cost:1,req:["violinist","vocalist"],val:15,desc:"å…¨å‘˜å› {val} HP + 5 ç›¾ã€‚",img:window.PATHS.cards+"lvshuchengyin.png",type:"duo",act:(e,i)=>{e.healAll(Math.ceil(15*i)),e.addBlockAll(Math.ceil(5*i)),window.UI.toast("ç¥åœ£å®é™"),window.UI.spawnVFX("heal","party-container")}},{id:104,name:"å¼¦ä¹æŸ”æ¿",cost:1,req:["violinist","cellist"],val:30,desc:"å‰æ’è·å¾— {val} æŠ¤ç›¾å¹¶åä¼¤ã€‚",img:window.PATHS.cards+"adagio.png",type:"duo",act:(e,i)=>{let t=e.getFrontAlly();t&&(t.block+=Math.ceil(30*i),e.dmgEnemy(t.block),window.UI.spawnVFX("shield",`char-${t.role}`))}},{id:105,name:"ç‹‚æ¬¢èŠ‚",cost:2,req:["pianist","cellist"],val:8,desc:"éšæœº {val} ä¼¤å®³ x 5 æ¬¡ã€‚",img:window.PATHS.cards+"carnival.png",type:"duo",act:(e,i)=>{for(let t=0;t<5;t++)e.tm.add(()=>{e.dmgEnemy(Math.ceil(8*i)),window.UI.spawnVFX("heavy_hit","sprite-enemy")},t*120)}},{id:106,name:"æ‚²æ­Œ",cost:2,req:["pianist","vocalist","cellist"],val:30,desc:"{val} çœŸå®ä¼¤å®³ + å…¨å‘˜å›è¡€ã€‚",img:window.PATHS.cards+"elegie.png",type:"trio",act:(e,i)=>{e.dmgEnemy(Math.ceil(30*i)),e.healAll(Math.ceil(20*i)),window.UI.spawnVFX("soundwave","sprite-enemy"),window.UI.spawnVFX("heal","party-container")}}];window.CARDS={1:{name:"çƒ­æƒ…",cost:2,type:"atk",val:16,tag:"atk",img:window.PATHS.cards+"reqing.png",desc:"{val} ä¼¤å®³",vfx:"heavy_hit",owner:"pianist"},19:{name:"å¤è°ƒå±•å¼€",cost:1,type:"skill",val:0,tag:"buff",img:window.PATHS.cards+"fudiao.png",desc:"æŠ½ {draw} ç‰Œï¼Œè‹¥æœ‰éæ”»å‡»ç‰Œå›1è´¹",eff:"polyphony",vfx:"heal",owner:"pianist"},30:{name:"å°¾å£°",cost:1,type:"atk",val:6,tag:"atk",img:window.PATHS.cards+"weisheng.png",desc:"{val} ä¼¤å®³ (æ¯å¼ æ‰‹ç‰Œ+3ä¼¤å®³)",eff:"hand_scale",vfx:"heavy_hit",owner:"pianist"},2:{name:"ä¸åå’Œ",cost:1,type:"debuff",val:5,tag:"atk",img:window.PATHS.cards+"buxiehe.png",desc:"{val} ä¼¤å®³ + æ˜“ä¼¤",vfx:"dissonance",owner:"common"},3:{name:"ä¼‘æ­¢ç¬¦",cost:1,type:"def",val:7,tag:"def",img:window.PATHS.cards+"xiuzhifu.png",desc:"å‰æ’è·å¾— {val} æŠ¤ç›¾",vfx:"shield",owner:"common"},4:{name:"é¢¤éŸ³",cost:0,type:"atk",val:5,tag:"atk",img:window.PATHS.cards+"chanyin.png",desc:"{val} ä¼¤å®³, æŠ½1ç‰Œ",eff:"draw",vfx:"heavy_hit",owner:"common"},6:{name:"ç‹¬å¥",cost:2,type:"atk",val:14,tag:"atk",img:window.PATHS.cards+"duzou.png",desc:"{val} ç©¿é€ä¼¤å®³",pierce:!0,vfx:"slash",owner:"common"},7:{name:"æ€¥æ¿",cost:0,type:"atk",val:4,tag:"atk",img:window.PATHS.cards+"jiban.png",desc:"{val} ä¼¤å®³, å›1è´¹",eff:"mana",vfx:"slash",owner:"common"},17:{name:"æ¸å¼º",cost:1,type:"atk",val:6,tag:"atk",img:window.PATHS.cards+"jianqiang.png",desc:"{val} ä¼¤å®³(éšæœ¬åœºæ”»å‡»æ¬¡æ•°æˆé•¿)",eff:"crescendo",vfx:"soundwave",owner:"common"},18:{name:"å˜å¥",cost:1,type:"skill",val:0,tag:"buff",img:window.PATHS.cards+"bianzou.png",desc:"ä¸‹ä¸€å¼ ç‰Œæ•ˆæœ +50%",eff:"variation",vfx:"heal",owner:"common"},5:{name:"è¿å¼“",cost:1,type:"atk",val:6,hits:2,tag:"atk",img:window.PATHS.cards+"yungong.png",desc:"{val} ä¼¤å®³ x2",vfx:"slash",owner:"violinist"},20:{name:"åŒéŸ³",cost:1,type:"atk",val:4,tag:"atk",img:window.PATHS.cards+"shuangyin.png",desc:"é€ æˆ 3 + è´Ÿé¢çŠ¶æ€å±‚æ•°æ¬¡ {val} ç‚¹ä¼¤å®³",eff:"double_stop",vfx:"slash",owner:"violinist"},31:{name:"æ‹¨å¥",cost:0,type:"atk",val:3,tag:"atk",img:window.PATHS.cards+"bozou.png",desc:"{val} ä¼¤å®³ï¼Œæ–½åŠ  2 å±‚æ˜“ä¼¤",eff:"vuln2",vfx:"slash",owner:"violinist"},8:{name:"å°–å•¸",cost:1,type:"atk",val:10,tag:"atk",img:window.PATHS.cards+"jianxiao.png",desc:"{val} ä¼¤å®³ + 1å±‚å…±é¸£",eff:"screech",vfx:"soundwave",owner:"vocalist"},9:{name:"å…±é¸£",cost:1,type:"buff",val:3,tag:"buff",img:window.PATHS.cards+"gongming.png",desc:"{val} å±‚å…±é¸£",vfx:"dissonance",owner:"vocalist"},10:{name:"å’å¹è°ƒ",cost:2,type:"spec",val:10,tag:"atk",img:window.PATHS.cards+"yongtandiao.png",desc:"å¼•çˆ†å…±é¸£(å±‚æ•°x{val})",eff:"boom",vfx:"soundwave",owner:"vocalist"},11:{name:"ä½åŸ",cost:1,type:"def",val:12,tag:"def",img:window.PATHS.cards+"diyin.png",desc:"å‰æ’è·å¾— {val} æŠ¤ç›¾",vfx:"shield",owner:"cellist"},12:{name:"é‡å¥",cost:2,type:"spec",val:100,tag:"atk",img:window.PATHS.cards+"chongzou.png",desc:"é€ æˆç­‰åŒäºæŠ¤ç›¾ {val}% çš„ä¼¤å®³",eff:"bash",vfx:"heavy_hit",owner:"cellist"},13:{name:"ç´å¼¦å£å’",cost:1,type:"def",val:5,tag:"def",img:window.PATHS.cards+"qinxian.png",desc:"è·å¾— {val} æŠ¤ç›¾ï¼ŒæŠ½ä¸€å¼ ç‰Œ",eff:"draw",vfx:"shield",owner:"cellist"},14:{name:"éœ‡è¡å·è§’",cost:1,type:"atk",val:8,tag:"atk",img:window.PATHS.cards+"zhendanghaojiao.png",desc:"{val} ä¼¤å®³ï¼Œæ–½åŠ  2 å±‚æ˜“ä¼¤",vfx:"soundwave",owner:"brass",eff:"vuln2"},15:{name:"é«˜çˆ†éŸ³ç¬¦",cost:2,type:"atk",val:18,tag:"atk",img:window.PATHS.cards+"gaobaoyinfu.png",desc:"{val} çˆ†å‘ä¼¤å®³ (AOE)",vfx:"heavy_hit",owner:"brass"},16:{name:"æ¯ç­äº¤å“",cost:3,type:"atk",val:35,tag:"atk",img:window.PATHS.cards+"huimiejiaoxiang.png",desc:"{val} æ¯ç­æ€§æ‰“å‡»",eff:"catastrophe",vfx:"heavy_hit",owner:"brass"},21:{name:"èµ·æ‹",cost:0,type:"skill",val:0,tag:"buff",img:window.PATHS.cards+"qipai.png",desc:"è·å¾— {mana} çµæ„Ÿï¼ŒæŠ½1å¼ ç‰Œ",eff:"upbeat",vfx:"heal",owner:"conductor"},22:{name:"ç¼„é»˜",cost:1,type:"atk",val:8,tag:"atk",img:window.PATHS.cards+"jianmo.png",desc:"{val} ä¼¤å®³ï¼Œæœ¬å›åˆæ•ŒäººåŠ›é‡ -{str}",eff:"weaken",vfx:"dissonance",owner:"conductor"},23:{name:"å¤§åˆå¥",cost:2,type:"atk",val:15,tag:"atk",img:window.PATHS.cards+"dahezou.png",desc:"{val} ä¼¤å®³ï¼Œå…¨å‘˜è·å¾— 8 ç‚¹æŠ¤ç›¾",eff:"tutti",vfx:"soundwave",owner:"conductor"},24:{name:"èŠ±èˆŒ",cost:0,type:"atk",val:3,tag:"atk",img:window.PATHS.cards+"huashe.png",desc:"{val} ä¼¤å®³ (æ¬¡æ•°=æœ¬å›åˆå·²è€—çµæ„Ÿ)",eff:"flutter",vfx:"slash",owner:"flutist"},25:{name:"æ°”æ¯æ§åˆ¶",cost:1,type:"skill",val:0,tag:"buff",img:window.PATHS.cards+"qixikongzhi.png",desc:"è·å¾— {mana} ç‚¹çµæ„Ÿ",eff:"breath",vfx:"heal",owner:"flutist"},26:{name:"ç©¿é€éŸ³",cost:1,type:"atk",val:8,tag:"atk",img:window.PATHS.cards+"chuantouyin.png",desc:"{val} ç©¿é€ä¼¤å®³ï¼Œä¸”æŠ½ 1 å¼ ç‰Œ",pierce:!0,eff:"draw",vfx:"soundwave",owner:"flutist"},27:{name:"æ»šå¥",cost:1,type:"atk",val:4,hits:4,tag:"atk",img:window.PATHS.cards+"gunzou.png",desc:"{val} ä¼¤å®³ x4",vfx:"heavy_hit",owner:"percussionist"},28:{name:"ç‚¸é•²",cost:2,type:"atk",val:10,tag:"atk",img:window.PATHS.cards+"zhacha.png",desc:"{val} ä¼¤å®³ï¼Œå‡»æ™•æ•Œäºº(è·³è¿‡å›åˆ)",eff:"stun",vfx:"heavy_hit",owner:"percussionist"},29:{name:"å®šéŸ³",cost:1,type:"def",val:10,tag:"def",img:window.PATHS.cards+"dingyin.png",desc:"å‰æ’è·å¾— {val} æŠ¤ç›¾ï¼Œä¸‹å›åˆä¿ç•™æŠ¤ç›¾",eff:"retain_block",vfx:"shield",owner:"percussionist"},101:window.DUO_CARDS[0],102:window.DUO_CARDS[1],103:window.DUO_CARDS[2],104:window.DUO_CARDS[3],105:window.DUO_CARDS[4],106:window.DUO_CARDS[5]};window.UI={switchScene(e){document.querySelectorAll(".scene").forEach(i=>i.classList.remove("active")),document.getElementById(e).classList.add("active")},renderCharSelect(e,i){const t=document.getElementById(e);t&&(t.innerHTML="",Object.keys(window.ROLES).forEach(n=>{if(e==="grid-recruit"&&window.game.partyRoles.includes(n))return;const o=window.ROLES[n],a=document.createElement("div");a.className="char-card";const s=e==="grid-start"?"start":"recruit";a.innerHTML=`
                <img src="${o.sprite}" class="char-img" onerror="this.style.backgroundColor='#333';this.alt='å›¾ç‰‡ä¸¢å¤±'">
                <div class="char-info">
                    <div style="color:#f0c040;font-weight:bold;font-size:1.2em">${o.name}</div>
                    <div class="bonus-text">
                        <div>â¤ï¸ HP: ${o.hp}</div>
                        <div>ğŸŒŸ ${o.buff}</div>
                    </div>
                    <button class="btn-preview" onclick="window.game.previewDeck('${n}', '${s}')">ğŸ” é¢„è§ˆå¡ç»„</button>
                </div>`,a.onclick=c=>{c.target.tagName!=="BUTTON"&&(c.stopPropagation(),e==="grid-recruit"&&a.classList.add("joined"),i(n))},t.appendChild(a)}))},renderBattleField(){const e=document.getElementById("party-container");e.innerHTML="",window.battle.allies.forEach((i,t)=>{const n=document.createElement("div");n.className="char-unit",n.id=`char-${i.role}`,n.onclick=()=>window.TacticManager.handleClick(t),n.style.zIndex=t+1,n.innerHTML=`
                <div class="mini-status">
                    <div class="mini-hp-text">
                        <img src="assets/UI/hp_icon.png" class="ui-icon" onerror="this.style.display='none'"> <span id="hp-text-${i.role}">${i.hp}</span>
                    </div>
                    <div class="mini-block" id="block-${i.role}" style="display:none">
                        <div class="block-bg"></div>
                        <div class="block-val" id="block-val-${i.role}"></div>
                    </div>
                </div>
                <div class="musician-sprite" style="background-image:url('${window.ROLES[i.role].sprite}')"></div>
            `,e.appendChild(n)})},highlightUnit(e,i){document.querySelectorAll(".char-unit").forEach((n,o)=>{n.classList.remove("swap-selected","swap-target"),i&&(o===e?n.classList.add("swap-selected"):n.classList.add("swap-target"))})},renderRewards(e="new"){const i=document.getElementById("reward-list");if(i.innerHTML="",e==="new"){document.getElementById("reward-title").innerText="é¢†æ‚Ÿæ–°ä¹è°±",document.getElementById("reward-text").innerText="é€‰æ‹©ä¸€å¼ åŠ å…¥ç‰Œç»„ (è‹¥å·²æœ‰åˆ™å¼ºåŒ–)";const t=window.game.getSmartRewards();for(let n of t){const o=window.CARDS[n],a=document.createElement("div");a.className="char-card",a.style.height="250px";const s=window.battle.playerDeck.includes(parseInt(n));let c=o.desc;o.val!==void 0&&(c=c.replace("{val}",o.val));let r=s?'<span style="color:#2ecc71">â˜… çªç ´ (å…¨å±€+1)</span>':'<span style="color:#f0c040">âœ¨ æ–°è·å–</span>',l=window.game.cardLevels[n]||0,d=l>0?` +${l}`:"";a.innerHTML=`
                    <img src="${o.img}" class="char-img" onerror="this.src=''">
                    <div class="char-info">
                        <b>${o.name}${d}</b>
                        <div style="margin:5px 0;">${r}</div>
                        <div class="card-desc"><span>${c}</span></div>
                    </div>`,a.onclick=()=>{if(s){if((window.game.cardLevels[n]||0)>=5){window.UI.toast(`${o.name} å·²è¾¾ç­‰çº§ä¸Šé™!`);return}window.game.cardLevels[n]=(window.game.cardLevels[n]||0)+1,window.UI.toast(`${o.name} çªç ´æˆåŠŸ!`)}else window.battle.playerDeck.push(parseInt(n)),window.UI.toast(`ä¹ å¾—: ${o.name}`);window.game.finishReward()},i.appendChild(a)}}},renderUpgradeRewards(e=0){const i=document.getElementById("reward-list");i.innerHTML="",document.getElementById("reward-title").innerText="æˆ˜ç«æ·¬ç‚¼",document.getElementById("reward-text").innerHTML=`è·å¾—é‡‘å¸: <img src="assets/UI/gold_icon.png" class="gold-icon-small"> <span style="color:#f0c040; font-weight:bold;">${e}</span><br>é€‰æ‹©ä¸€ç§æŠ€è‰ºè¿›è¡Œã€é’»ç ”ã€‘(ä¸Šé™ç­‰çº§ 5)`;const t=[...new Set(window.battle.playerDeck)].filter(a=>(window.game.cardLevels[a]||0)<5);if(t.length===0){i.innerHTML="<div style='color:#888'>æ‰€æœ‰æŠ€è‰ºå·²è¾¾åŒ–å¢ƒ</div>";return}const n=[...t],o=[];for(let a=0;a<3&&n.length!==0;a++){const s=Math.floor(Math.random()*n.length);o.push(n[s]),n.splice(s,1)}o.forEach(a=>{const s=window.CARDS[a],c=document.createElement("div");c.className="char-card",c.style.height="250px";const r=window.game.cardLevels[a]||0,l=r+1;s.val;let d=s.desc;if(s.eff==="variation"){const w=50+10*l;d=d.replace("50%",`${w}%`)}if(s.eff==="polyphony"){const w=2+Math.floor(l/2);d=d.replace("{draw}",`<span class="highlight-val">${w}</span>`)}if(s.eff==="upbeat"){const w=1+Math.floor(l/2);d=d.replace("{mana}",`<span class="highlight-val">${w}</span>`)}if(s.eff==="breath"){const w=2+l;d=d.replace("{mana}",`<span class="highlight-val">${w}</span>`)}if(s.eff==="weaken"){const w=2+l;d=d.replace("{str}",`<span class="highlight-val">${w}</span>`)}if(s.val!==void 0){const w=Math.ceil(s.val*(1+.5*l));d=d.replace("{val}",`<span class="highlight-val">${w}</span>`)}c.innerHTML=`
                <img src="${s.img}" class="char-img" onerror="this.src=''">
                <div class="char-info">
                    <b style="color:${r>0?"#2ecc71":"#eee"}">${s.name} ${r>0?"+"+r:""}</b>
                    <div style="font-size:2em; color:#f0c040; margin:2px 0;">â®• +${l}</div>
                    <div class="card-desc"><span>${d}</span></div>
                </div>`,c.onclick=()=>{window.game.cardLevels[a]=(window.game.cardLevels[a]||0)+1,window.UI.toast(`${s.name} é’»ç ”æˆåŠŸ!`),window.game.finishReward()},i.appendChild(c)})},renderMap(e,i){if(!e||e.length===0){console.warn("MapGraph is empty!");return}const t=parseInt(i.layer),n=parseInt(i.index);console.log("RenderMap:",t,n,"Graph Layers:",e.length);const o=document.getElementById("map-nodes"),a=document.getElementById("map-lines");!o||!a||(o.innerHTML="",a.innerHTML="",e.forEach((s,c)=>{const r=document.createElement("div");r.className="map-layer",r.id=`layer-${c}`,s.forEach((l,d)=>{var p;const w=document.createElement("div");w.className="map-node-v2",w.id=`node-${c}-${d}`;let h="locked";if(t===-1)c===0&&(h="reachable");else if(c<t)h="passed";else if(c===t)d===n?h="current":h="locked";else if(c===t+1){const m=(p=e[t])==null?void 0:p[n];m&&m.next&&m.next.includes(d)&&(h="reachable")}w.classList.add(h),l.type==="boss"&&w.classList.add("boss");let f="assets/UI/Battle.png";l.type==="elite"&&(f="assets/UI/Elite.png"),l.type==="camp"&&(f="assets/UI/camp.png"),l.type==="recruit"&&(f="assets/UI/Recruit.png"),l.type==="shop"&&(f="assets/UI/shop_icon.png"),l.type==="boss"&&(f="assets/UI/BossBattle.png"),l.type==="start"&&(f="assets/UI/common_button.png"),w.innerHTML=`<img src="${f}"><div class="node-name">${l.name}</div>`,h==="reachable"&&(w.onclick=()=>{console.log("Clicked Node:",l.type,c,d),window.game.enterNode(l.type,c,d)}),r.appendChild(w)}),o.appendChild(r)}),setTimeout(()=>{var r;const s=(r=document.getElementById("map-container"))==null?void 0:r.getBoundingClientRect();if(!s)return;e.forEach((l,d)=>{d>=e.length-1||l.forEach((w,h)=>{const f=document.getElementById(`node-${d}-${h}`);if(!f)return;const p=f.getBoundingClientRect();if(p.width===0)return;const m=p.left-s.left+p.width/2,y=p.top-s.top+p.height/2;w.next.forEach(u=>{const I=document.getElementById(`node-${d+1}-${u}`);if(!I)return;const v=I.getBoundingClientRect(),g=v.left-s.left+v.width/2,k=v.top-s.top+v.height/2,b=document.createElementNS("http://www.w3.org/2000/svg","line");b.setAttribute("x1",m),b.setAttribute("y1",y),b.setAttribute("x2",g),b.setAttribute("y2",k),b.setAttribute("stroke","#555"),b.setAttribute("stroke-width","2"),a.appendChild(b)})})});const c=document.getElementById("map-scroll-area");if(t===-1&&c)c.scrollTo({left:0,behavior:"smooth"});else{const l=document.getElementById(`layer-${t}`);if(c&&l){const d=l.offsetLeft-c.clientWidth/2+l.clientWidth/2;c.scrollTo({left:d,behavior:"smooth"})}}},100))},renderShop(e){const i=document.getElementById("shop-cards");i.innerHTML="";const t=document.getElementById("shop-relics");t.innerHTML="";const n=document.getElementById("shop-services");n.innerHTML="";const o=i.parentElement.querySelector("h3");o&&(o.innerHTML='<img src="assets/UI/upgrade_icon.png" class="icon-title"> æŠ€è‰ºç£¨ç‚¼ <span style="font-size:0.6em;color:#2ecc71">(å¼ºåŒ–)</span>'),e.cards.forEach((s,c)=>{const r=window.CARDS[s.id],l=document.createElement("div");l.className="shop-item"+(s.sold?" sold":"");const d=s.level,w=d+1;l.innerHTML=`
                <div style="position:relative; width:80px; height:80px;">
                    <img src="${r.img}" style="width:100%; height:100%; object-fit:contain;">
                    <div style="position:absolute; bottom:0; right:0; background:#2ecc71; color:#000; font-size:0.8em; padding:2px 4px; border-radius:4px; font-weight:bold;">
                        Lv.${d} -> ${w}
                    </div>
                </div>
                <div class="shop-item-name">${r.name}</div>
                <div class="shop-item-desc" style="color:#2ecc71">ç‚¹å‡»å¼ºåŒ–</div>
                <div class="shop-price"><img src="assets/UI/gold_icon.png" class="gold-icon-small"> ${s.price}</div>
            `,l.onclick=()=>window.game.buyItem("cards",c),i.appendChild(l)});const a=t.parentElement.querySelector("h3");a&&(a.innerHTML='<img src="assets/UI/mystery_relic_icon.png" class="icon-title"> ä¼ ä¸–åœ£ç‰©'),e.relics.forEach((s,c)=>{const r=window.RELICS[s.key],l=document.createElement("div");l.className="shop-item"+(s.sold?" sold":""),l.innerHTML=`
                <div style="position:relative; width:80px; height:80px; display:flex; align-items:center; justify-content:center;">
                    <img src="assets/UI/mystery_relic_icon.png" style="width:100%; height:100%; position:absolute; opacity:0.3;">
                    <span style="font-size:2.5em; position:relative; z-index:2;">${r.icon}</span>
                </div>
                <div class="shop-item-name">${r.name}</div>
                <div class="shop-item-desc">${r.desc}</div>
                <div class="shop-price"><img src="assets/UI/gold_icon.png" class="gold-icon-small"> ${s.price}</div>
            `,l.onclick=()=>window.game.buyItem("relics",c),t.appendChild(l)}),e.services.forEach((s,c)=>{const r=document.createElement("div");r.className="shop-item"+(s.sold?" sold":""),r.innerHTML=`
                <div style="width:80px; height:80px;"><img src="${s.icon}" style="width:100%; height:100%; object-fit:contain;"></div>
                <div class="shop-item-name">${s.name}</div>
                <div class="shop-item-desc">${s.desc}</div>
                <div class="shop-price"><img src="assets/UI/gold_icon.png" class="gold-icon-small"> ${s.price}</div>
            `,r.onclick=()=>window.game.buyItem("services",c),n.appendChild(r)})},showDeckModal(e,i,t=null){const n=document.getElementById("modal-overlay"),o=document.getElementById("modal-card-list");document.getElementById("modal-title").innerText=i,o.innerHTML="",n.classList.add("active");const a=t?e.map((s,c)=>({id:s,originalIdx:c})):[...e].sort((s,c)=>s-c).map(s=>({id:s}));if(a.length===0){o.innerHTML='<div style="color:#666; margin-top:50px;">æš‚æ— å¡ç‰Œ</div>';return}a.forEach(s=>{const c=s.id,r=window.CARDS[c],l=document.createElement("div");l.className="card-display",r.type==="duo"&&l.classList.add("duet"),r.type==="trio"&&l.classList.add("trio");const d=window.game.cardLevels[c]||0;d>0&&l.classList.add("upgraded");let w=r.desc;if(r.eff==="variation"){const p=50+10*d;w=w.replace("50%",`${p}%`)}if(r.eff==="polyphony"){const p=2+Math.floor(d/2);w=w.replace("{draw}",`<span class="highlight-val">${p}</span>`)}if(r.eff==="upbeat"){const p=1+Math.floor(d/2);w=w.replace("{mana}",`<span class="highlight-val">${p}</span>`)}if(r.eff==="breath"){const p=2+d;w=w.replace("{mana}",`<span class="highlight-val">${p}</span>`)}if(r.eff==="weaken"){const p=2+d;w=w.replace("{str}",`<span class="highlight-val">${p}</span>`)}let h=r.val;if(h!==void 0){d>0&&h>0&&(h=Math.ceil(h*(1+.5*d)));const p=r.type==="duo"||r.type==="trio"?"#4dabf7":"#2ecc71";w=w.replace("{val}",`<span class="highlight-val" style="color:${p}">${h}</span>`)}const f=d>0?` +${d}`:"";l.innerHTML=`
                <div class="card-cost">${r.cost}</div>
                <img src="${r.img}" class="card-art" onerror="this.src=''">
                <div class="card-text">
                    <div class="card-name">${r.name}${f}</div>
                    <div class="card-desc"><span>${w}</span></div>
                </div>
            `,t&&(l.style.cursor="pointer",l.style.border="2px dashed #e74c3c",l.onmouseover=()=>l.style.borderColor="#f0c040",l.onmouseout=()=>l.style.border="2px dashed #e74c3c",l.onclick=()=>t(c,s.originalIdx)),o.appendChild(l)})},closeDeckModal(){document.getElementById("modal-overlay").classList.remove("active")},update(){const e=document.getElementById("map-gold");e&&(e.innerText=window.game.gold);const i=document.getElementById("battle-gold");i&&(i.innerText=window.game.gold);const t=document.getElementById("shop-gold");t&&(t.innerText=window.game.gold);const n=document.getElementById("mana-ui");if(n){n.innerHTML="";for(let l=0;l<window.battle.manaData.max;l++){const d=document.createElement("div");d.className="mana-dot"+(l<window.battle.manaData.current?"":" empty"),n.appendChild(d)}}const o=document.getElementById("draw-ui");o&&(o.innerHTML=`<img src="assets/UI/draw.png" class="ui-icon" style="width:32px;height:32px;" onerror="this.style.display='none'"> æ‰‹ç‰Œ: ${window.battle.manaData.draw}`);const a=document.getElementById("level-ui");a&&(a.innerText=window.game.level);const s=document.getElementById("map-level-num");s&&(s.innerText=window.game.level);const c=document.getElementById("relic-bar");if(c&&(c.innerHTML="",window.game.relics.forEach(l=>{const d=document.createElement("div");d.className="relic",d.innerText=window.RELICS[l].icon,d.setAttribute("data-desc",`${window.RELICS[l].name}: ${window.RELICS[l].desc}`),c.appendChild(d)})),window.battle.allies.forEach(l=>{const d=document.getElementById(`char-${l.role}`);if(d){l.dead?d.classList.add("dead"):d.classList.remove("dead");const w=document.getElementById(`hp-text-${l.role}`);w&&(w.innerText=`${l.hp}`);const h=document.getElementById(`block-${l.role}`),f=document.getElementById(`block-val-${l.role}`);h&&f&&(l.block>0?(h.style.display="flex",f.innerText=l.block):h.style.display="none")}}),window.battle.enemy&&window.battle.enemy.maxHp){const l=window.battle.enemy.hp/window.battle.enemy.maxHp*100,d=document.getElementById("e-hp-bar");d&&(d.style.width=l+"%");const w=document.getElementById("e-hp-text");w&&(w.innerText=`${window.battle.enemy.hp}/${window.battle.enemy.maxHp}`);const h=document.getElementById("e-name");h&&(h.innerText=window.battle.enemy.name);const f=document.getElementById("sprite-enemy");f&&(f.classList.contains("anim-knight-attack")||f.classList.contains("anim-dancer-attack")||f.classList.contains("anim-demon-cast")?f.style.backgroundImage="":f.style.backgroundImage=`url('${window.battle.enemy.sprite}')`);const p=document.getElementById("e-intent");if(p)if(window.battle.enemy.stunned)p.innerHTML='<span class="intent-icon">â„ï¸</span> æ— æ³•è¡ŒåŠ¨',f&&f.classList.add("frozen-effect");else{const y=window.battle.enemy.intent.icon||"assets/UI/attack.png";let u=window.battle.enemy.intent.val>0?window.battle.enemy.intent.val:"";const I=["atk","atk_heavy","atk_vuln"];let v=!1;if(I.includes(window.battle.enemy.intent.type)&&u!==""){const k=window.battle.enemy.buffs.str||0;k>0&&(v=!0),u=parseInt(u)+k}const g=v?`<span style="color:#e74c3c; font-weight:bold; text-shadow:0 0 5px rgba(231,76,60,0.5);">${u}</span>`:u;p.innerHTML=`<img src="${y}" class="intent-icon-img" onerror="this.src='assets/UI/attack.png'"> ${g}`,f&&f.classList.remove("frozen-effect")}const m=document.getElementById("e-status");m&&(m.innerHTML="",window.battle.enemy.block>0&&(m.innerHTML+=`<div style="display:flex;align-items:center;background:rgba(0,0,0,0.8);border-radius:4px;padding:4px 8px;margin-right:5px;"><img src="assets/UI/block.png" class="ui-icon" style="width:28px;height:28px;" onerror="this.style.display='none'"> <span style="font-weight:bold;margin-left:6px;color:#3498db;font-size:1.2em;">${window.battle.enemy.block}</span></div>`),window.battle.enemy.buffs.vuln>0&&(m.innerHTML+=`<div style="display:flex;align-items:center;background:rgba(0,0,0,0.8);border-radius:4px;padding:4px 8px;margin-right:5px;"><img src="assets/UI/Vulnerable.png" class="ui-icon" style="width:28px;height:28px;" onerror="this.style.display='none'"> <span style="font-weight:bold;margin-left:6px;color:#e67e22;font-size:1.2em;">${window.battle.enemy.buffs.vuln}</span></div>`),window.battle.enemy.buffs.res>0&&(m.innerHTML+=`<div class="status-icon" style="background:#9b59b6">å…±é¸£ ${window.battle.enemy.buffs.res}</div>`),window.battle.enemy.buffs.str>0&&(m.innerHTML+=`<div class="status-icon" style="background:#e74c3c">åŠ›é‡ ${window.battle.enemy.buffs.str}</div>`))}const r=document.getElementById("hand");if(r){r.innerHTML="";const l=document.getElementById("btn-cancel");l&&(l.style.display=window.battle.selectedCard===-1?"none":"block"),window.battle.hand.forEach((d,w)=>{const h=window.CARDS[d];if(!h)return;const f=window.battle.isCardPlayable(h),p=document.createElement("div"),m=window.game.cardLevels[d]||0;if(p.className="card"+(w===window.battle.selectedCard?" selected":"")+(h.type==="duo"?" duet":"")+(h.type==="trio"?" trio":"")+(f?"":" disabled")+(m>0?" upgraded":""),w!==window.battle.selectedCard&&f){const g=(w-(window.battle.hand.length-1)/2)*5;p.style.transform=`rotate(${g}deg) translateY(${Math.abs(g)*2}px)`}let y=h.val,u=h.desc;if(h.eff==="variation"){const g=50+10*m;u=u.replace("50%",`${g}%`)}if(h.eff==="polyphony"){const g=2+Math.floor(m/2);u=u.replace("{draw}",`<span class="highlight-val">${g}</span>`)}if(h.eff==="upbeat"){const g=1+Math.floor(m/2);u=u.replace("{mana}",`<span class="highlight-val">${g}</span>`)}if(h.eff==="breath"){const g=2+m;u=u.replace("{mana}",`<span class="highlight-val">${g}</span>`)}if(h.eff==="weaken"){const g=2+m;u=u.replace("{str}",`<span class="highlight-val">${g}</span>`)}y!==void 0&&(m>0&&y>0&&(y=Math.ceil(y*(1+.5*m))),u=u.replace("{val}",`<span class="highlight-val">${y}</span>`));const I=m>0?` +${m}`:"",v=window.battle.getCardCost?window.battle.getCardCost(d):h.cost;p.innerHTML=`
                    <div class="card-cost">${v}</div>
                    <img src="${h.img}" class="card-art" onerror="this.src=''">
                    <div class="card-text">
                        <div class="card-name">${h.name}${I}</div>
                        <div class="card-desc"><span>${u}</span></div>
                    </div>
                `,p.onclick=g=>{g.stopPropagation(),f&&window.battle.selectCard(w)},r.appendChild(p)})}},toast(e){const i=document.createElement("div");i.className="toast",i.innerText=e,document.getElementById("game-window").appendChild(i),setTimeout(()=>i.remove(),1e3)},floatText(e,i,t){const n=document.createElement("div");n.className="float-text",n.innerText=e,n.style.color=t;const o=document.getElementById(i);if(!o)return;const a=o.getBoundingClientRect(),s=document.getElementById("game-window").getBoundingClientRect(),c=(Math.random()-.5)*20;n.style.left=a.left-s.left+a.width/2-20+c+"px",n.style.top=a.top-s.top+"px",document.getElementById("game-window").appendChild(n),setTimeout(()=>n.remove(),1e3)},spawnVFX(e,i){const t=document.getElementById(i);if(!t)return;const n=t.getBoundingClientRect(),o=document.getElementById("game-window").getBoundingClientRect(),a=document.createElement("img");a.src=`assets/vfx/vfx_${e}.png`,a.className=`vfx-particle vfx-${e}`;const s=n.left-o.left+n.width/2,c=n.top-o.top+n.height/2,r=(Math.random()-.5)*40,l=(Math.random()-.5)*40;a.style.left=s+r+"px",a.style.top=c+l+"px",a.style.filter=`hue-rotate(${Math.random()*20}deg)`,document.getElementById("game-window").appendChild(a),setTimeout(()=>a.remove(),500)},shake(){const e=document.getElementById("game-window");e&&(e.classList.remove("shake"),e.offsetWidth,e.classList.add("shake"))},playSound(e){const i=new Audio(e);i.volume=.6,i.play().catch(t=>console.warn("Audio error:",t))},playBGM(e){this.currentBGM&&this.currentBGM.src.endsWith(encodeURI(e))||(this.currentBGM&&this.currentBGM.pause(),this.currentBGM=new Audio(e),this.currentBGM.loop=!0,this.currentBGM.volume=.5,this.currentBGM.play().catch(i=>console.warn("BGM error:",i)))},stopBGM(){this.currentBGM&&(this.currentBGM.pause(),this.currentBGM=null)},log(e,i=""){const t=document.getElementById("battle-log");if(!t)return;const n=document.createElement("div");n.innerHTML=e,n.className=`log-line log-${i}`,t.appendChild(n),t.scrollTop=t.scrollHeight},clearLog(){const e=document.getElementById("battle-log");e&&(e.innerHTML="")}};window.TacticManager={selectedIdx:-1,handleClick(e){window.battle.phase==="PREPARE"&&(this.selectedIdx===-1?(this.selectedIdx=e,window.UI.highlightUnit(e,!0)):this.selectedIdx===e?(window.UI.highlightUnit(e,!1),this.selectedIdx=-1):(this.swap(this.selectedIdx,e),window.UI.highlightUnit(this.selectedIdx,!1),this.selectedIdx=-1))},swap(e,i){const t=window.battle.allies[e];window.battle.allies[e]=window.battle.allies[i],window.battle.allies[i]=t,window.UI.renderBattleField()}};window.battle={allies:[],playerDeck:[],hand:[],discard:[],manaData:{current:3,max:3,draw:5},enemy:{},tm:new window.TimerManager,phase:"IDLE",selectedCard:-1,attacksPlayed:0,turnCount:0,variationBonus:0,crescendoStacks:0,manaSpentTurn:0,firstCardPlayed:!1,tempStrDebuff:0,lastCardType:null,bachCounter:0,mozartTriggered:!1,reset(){this.tm.clearAll(),window.UI.clearLog(),this.phase="IDLE",this.playerDeck=this.playerDeck.concat(this.hand,this.discard),this.hand=[],this.discard=[],this.playerDeck.sort(()=>Math.random()-.5),this.allies.forEach(e=>e.block=0),this.turnCount=0,this.variationBonus=0,this.crescendoStacks=0,this.manaSpentTurn=0,this.firstCardPlayed=!1,this.tempStrDebuff=0,this.lastCardType=null,this.bachCounter=0,this.mozartTriggered=!1},getFrontAlly(){for(let e=this.allies.length-1;e>=0;e--)if(!this.allies[e].dead)return this.allies[e];return null},getCardCost(e){const i=window.CARDS[e];if(!i)return 0;let t=i.cost;return!this.firstCardPlayed&&window.game.partyRoles.includes("flutist")?0:(!this.firstCardPlayed&&i.type==="atk"&&window.game.relics.includes("paganini_string")&&(t=Math.max(0,t-1)),(i.type==="duo"||i.type==="trio")&&window.game.partyRoles.includes("conductor")&&(t=Math.max(0,t-1)),t)},isCardPlayable(e){if(e.type==="duo"||e.type==="trio")return e.req.every(i=>{const t=this.allies.find(n=>n.role===i);return t&&!t.dead});if(e.owner&&e.owner!=="common"){const i=this.allies.find(t=>t.role===e.owner);return i&&!i.dead}return!0},startActualBattle(){document.getElementById("prep-ui").style.display="none",document.getElementById("hand").style.display="flex",document.getElementById("btn-end").style.display="block",document.getElementById("party-container").classList.remove("interactive"),window.TacticManager.selectedIdx=-1,window.UI.renderBattleField(),this.startTurn()},startTurn(){this.phase="PLAYER",this.turnCount++,this.attacksPlayed=0,this.manaSpentTurn=0,this.firstCardPlayed=!1,this.turnCount>1&&this.allies.forEach(e=>{let i=window.game.relics.includes("tuning_fork")?10:0;e.retainBlock&&(i=e.block,e.retainBlock=!1),e.block=Math.max(0,Math.floor(e.block/2),Math.min(e.block,i))}),window.UI.log(`=== ç¬¬ ${this.turnCount} å›åˆ ===`,"turn"),this.manaData.current=this.manaData.max,this.turnCount===1&&window.game.relics.includes("baton")&&(this.manaData.current+=1,window.UI.toast("æŒ‡æŒ¥æ£’: çµæ„Ÿ+1")),document.getElementById("btn-end").disabled=!1,this.drawCards(this.manaData.draw),window.UI.update()},drawCards(e){const i=[];for(let t=0;t<e;t++){if(!this.playerDeck.length){if(!this.discard.length)break;this.playerDeck=this.discard.sort(()=>Math.random()-.5),this.discard=[]}const n=this.playerDeck.pop();this.hand.push(n),i.push(n)}return i},selectCard(e){if(this.phase!=="PLAYER")return;const i=this.hand[e],t=window.CARDS[i];if(!this.isCardPlayable(t)){window.UI.toast("è§’è‰²å·²é˜µäº¡!");return}const n=this.getCardCost(i);if(this.manaData.current<n){window.UI.toast("çµæ„Ÿä¸è¶³");return}t.type==="atk"||t.type==="debuff"||t.eff==="boom"||t.eff==="bash"?this.selectedCard===e?this.deselect():(this.selectedCard=e,window.UI.update()):this.playCard(e)},targetEnemy(){this.selectedCard!==-1&&this.playCard(this.selectedCard)},playCard(e){const i=this.hand[e],t=window.CARDS[i],n=this.getCardCost(i);!this.firstCardPlayed&&window.game.partyRoles.includes("flutist")&&t.cost>0&&window.UI.floatText("çµé£ï¼š0è´¹å‡ºç‰Œ","hand","#4dabf7"),this.manaData.current-=n,this.manaSpentTurn+=n,this.firstCardPlayed=!0;let o=0;t.eff==="hand_scale"&&(o=this.hand.length*3),this.hand.splice(e,1),this.discard.push(i),this.deselect(),window.UI.log(`æ‰“å‡º: <b>${t.name}</b>`,"card"),t.eff==="stun"&&window.UI.playSound("assets/ç‰¹å¤§é¼“é‡å‡».mp3"),t.eff==="catastrophe"&&window.UI.playSound("assets/å·¨å¤§è½°é¸£çˆ†ç‚¸.mp3"),(t.name==="ä¼‘æ­¢ç¬¦"||t.name==="èµ·æ‹")&&window.UI.playSound("assets/BGM/accordion-attack.wav"),(t.name==="å˜å¥"||t.name==="æ‹¨å¥")&&window.UI.playSound("assets/BGM/unsheathed-blade.ogg"),(t.name==="æ€¥æ¿"||t.name==="è¿å¼“")&&window.UI.playSound("assets/BGM/sword-01.wav"),(t.name==="éœ‡è¡å·è§’"||t.name==="é«˜çˆ†éŸ³ç¬¦")&&window.UI.playSound("assets/BGM/shipboard_railgun.mp3"),(t.name==="çƒ­æƒ…"||t.name==="å°¾å£°")&&window.UI.playSound("assets/BGM/horror-piano-chord.mp3"),t.name==="ä¸åå’Œ"&&window.UI.playSound("assets/BGM/violin-scare.wav"),(t.name==="ä½åŸ"||t.name==="é‡å¥"||t.name==="ç´å¼¦å£å’")&&window.UI.playSound("assets/BGM/piano-string-glissando-low-a.wav");let a=1;t.tag==="atk"&&window.game.relics.includes("metronome")&&this.attacksPlayed===0&&(a=2,window.UI.toast("èŠ‚æ‹å™¨: åŒé‡å¥!")),t.tag==="atk"&&(this.attacksPlayed++,window.game.relics.includes("rosin")&&(this.enemy.buffs.vuln+=1));let s=this.allies.find(d=>d.role===t.owner);if(s||(s=this.getFrontAlly()),s){const d=document.getElementById(`char-${s.role}`);if(d){const w=d.querySelector(".musician-sprite");if(w){let h=null,f=0;t.owner===s.role&&(s.role==="brass"&&t.type==="atk"?(h="anim-brass-atk",f=800):s.role==="cellist"&&(h="anim-cellist-buff",f=1200)),!h&&t.type==="atk"&&(h="anim-generic-atk",f=300),h&&(w.classList.remove("anim-brass-atk","anim-generic-atk","anim-cellist-buff"),w.offsetWidth,w.classList.add(h),setTimeout(()=>{w.classList.remove(h)},f))}}}const c=window.game.cardLevels[i]||0;let r=1+.5*c;this.variationBonus>0&&(r+=this.variationBonus,window.UI.floatText(`å˜å¥ +${Math.round(this.variationBonus*100)}%!`,`char-${s.role}`,"#f0c040"),this.variationBonus=0);let l=t.val;window.game.relics.includes("beethoven_ear")&&s.hp<s.maxHp*.3&&t.type==="atk"&&(l*=2,window.UI.floatText("å‘½è¿å’†å“®!",`char-${s.role}`,"#e74c3c")),t.eff==="crescendo"&&(l+=this.crescendoStacks),t.cost>=2&&window.game.partyRoles.includes("brass")&&t.type==="atk"&&(l+=5),t.type==="atk"&&window.game.partyRoles.includes("percussionist")&&(l+=2),l>0&&(l=Math.ceil(l*r));for(let d=0;d<a;d++)setTimeout(()=>{this.executeCardEffect(t,s,l,r,o)},d*300);if(t.eff==="draw"&&this.drawCards(1),t.eff==="mana"&&this.manaData.current++,t.type==="atk"&&this.crescendoStacks++,t.eff==="variation"&&(this.variationBonus=.5+.1*c,window.UI.toast(`ä¸‹ä¸€å¼ ç‰Œæ•ˆæœ +${Math.round(this.variationBonus*100)}%`)),t.eff==="polyphony"){let d=2+Math.floor(c/2);this.drawCards(d).some(f=>CARDS[f].type!=="atk")&&(this.manaData.current++,window.UI.floatText("+1 çµæ„Ÿ",`char-${s.role}`,"#4dabf7"))}if(t.eff==="screech"&&(this.enemy.buffs.res+=1,window.UI.floatText("å…±é¸£+1","sprite-enemy","#9b59b6"),window.UI.log("[Buff] æ•Œäººå…±é¸£ +1","buff")),t.eff==="upbeat"){let d=1+Math.floor(c/2);if(this.manaData.current+=d,window.UI.floatText(`+${d} çµæ„Ÿ`,`char-${s.role}`,"#4dabf7"),window.UI.spawnVFX("conductor",`char-${s.role}`),this.drawCards(1),c>0){let w=this.getFrontAlly();w&&(w.block+=4,window.UI.floatText("æŠ¤ç›¾+4",`char-${w.role}`,"#3498db"),window.UI.log(`[æŠ¤ç›¾] ${w.name} è·å¾— 4 æŠ¤ç›¾`,"block"),window.UI.playSound("assets/BGM/shield.wav"))}}if(t.eff==="weaken"){const d=2+c;this.enemy.buffs.str-=d,this.tempStrDebuff+=d,window.UI.floatText(`åŠ›é‡ -${d}`,"sprite-enemy","#bdc3c7"),window.UI.log(`[Debuff] æ•ŒäººåŠ›é‡æœ¬å›åˆ -${d}`,"debuff")}if(t.eff==="tutti"&&this.addBlockAll(8*r),t.eff==="breath"){let d=2+c;this.manaData.current+=d,window.UI.floatText(`+${d} çµæ„Ÿ`,`char-${s.role}`,"#4dabf7"),window.UI.spawnVFX("conductor",`char-${s.role}`),c>0&&(this.drawCards(1),window.UI.floatText("é¢å¤–æŠ½ç‰Œ",`char-${s.role}`,"#2ecc71"))}t.eff==="stun"&&(this.enemy.stunned=!0,window.UI.toast("æ•Œäººè¢«å‡»æ™•!"),window.UI.spawnVFX("Heavy_Rending","sprite-enemy"),window.UI.log("[æ§åˆ¶] æ•Œäººè¢«å‡»æ™•","debuff")),this.attacksPlayed===1&&window.game.relics.includes("paganini_string")&&t.type==="atk"&&(s.hp-=2,window.UI.floatText("-2",`char-${s.role}`,"#888"),s.hp<=0&&(s.hp=0,s.dead=!0)),window.game.relics.includes("bach_lens")&&(this.lastCardType===t.type?(this.bachCounter++,this.bachCounter>=3&&(this.drawCards(1),this.manaData.current++,window.UI.toast("èµ‹æ ¼é€é•œ: å®Œç¾å¯¹ä½!"),this.bachCounter=0)):(this.lastCardType=t.type,this.bachCounter=1)),window.UI.update()},executeCardEffect(e,i,t,n,o=0){if(e.type==="duo"||e.type==="trio")e.act(this,n);else{let a=t;if(o>0&&(a+=o),e.vfx)if(e.type==="def"){let s=this.getFrontAlly();s&&window.UI.spawnVFX(e.vfx,`char-${s.role}`)}else e.type==="buff"?window.UI.spawnVFX(e.vfx,`char-${i.role}`):window.UI.spawnVFX(e.vfx,"sprite-enemy");if(e.type==="def"){let s=this.getFrontAlly();s&&(s.block+=a,window.UI.log(`[æŠ¤ç›¾] ${s.name} è·å¾— ${a} æŠ¤ç›¾`,"block"),window.UI.playSound("assets/BGM/shield.wav"),window.UI.floatText(`æŠ¤ç›¾+${a}`,`char-${s.role}`,"#3498db"))}else if(e.type==="buff")this.enemy.buffs.res+=a,window.UI.log(`[Buff] æ•Œäººè·å¾— ${a} å±‚å…±é¸£`,"buff");else if(e.eff==="bash"){let s=i.block;s=Math.ceil(s*n),this.dmgEnemy(s,e.pierce),window.UI.shake()}else if(e.eff==="boom"){let s=e.val;s=Math.ceil(s*n);let c=this.enemy.buffs.res*s;this.dmgEnemy(c,e.pierce),this.enemy.buffs.res=0,window.UI.log(`[å¼•çˆ†] æ¶ˆè€—å…±é¸£é€ æˆ ${c} ä¼¤å®³`,"dmg"),window.UI.shake()}else if(e.type==="atk"||e.type==="debuff"){let s=e.hits||1;e.eff==="double_stop"&&(s=3+((this.enemy.buffs.vuln>0?1:0)+(this.enemy.stunned?1:0))),s>1&&window.game.relics.includes("liszt_bullet")&&(s+=1),e.eff==="flutter"&&(s=Math.max(1,this.manaSpentTurn));for(let c=0;c<s;c++)this.tm.add(()=>{this.dmgEnemy(a,e.pierce),e.eff==="flutter"?window.UI.spawnVFX("Multi-Thrust","sprite-enemy"):e.vfx==="slash"&&window.UI.spawnVFX("slash","sprite-enemy"),c===s-1&&setTimeout(()=>{e.eff==="vuln2"?(this.enemy.buffs.vuln+=2,window.UI.log("[Debuff] æ•Œäººè¢«æ–½åŠ  2 å±‚æ˜“ä¼¤","debuff"),window.UI.floatText("æ˜“ä¼¤+2","sprite-enemy","#e67e22")):e.type==="debuff"&&(this.enemy.buffs.vuln+=1,window.UI.log("[Debuff] æ•Œäººè¢«æ–½åŠ  1 å±‚æ˜“ä¼¤","debuff"),window.UI.floatText("æ˜“ä¼¤+1","sprite-enemy","#e67e22")),window.UI.update()},350)},c*150)}}window.UI.update()},dmgEnemy(e,i=!1){if(this.phase==="VICTORY")return;this.enemy.buffs.vuln>0&&(e=Math.floor(e*1.5));let t=e;if(!i&&this.enemy.block>0){let n=Math.min(this.enemy.block,t);this.enemy.block-=n,t-=n,n>0&&window.UI.floatText("æ ¼æŒ¡","sprite-enemy","#3498db")}this.enemy.hp=Math.max(0,this.enemy.hp-t),t>0&&(window.UI.floatText(`-${t}`,"sprite-enemy","#ff6b6b"),window.UI.log(`é€ æˆ ${t} ä¼¤å®³`,"dmg")),t>10&&window.UI.shake(),window.UI.update(),this.enemy.hp<=0&&this.win()},healAll(e){this.allies.forEach(i=>{i.dead||(i.hp=Math.min(i.maxHp,i.hp+e),window.UI.floatText(`+${e}`,`char-${i.role}`,"#2ecc71"))}),window.UI.log(`[æ²»ç–—] å…¨å‘˜æ¢å¤ ${e} HP`,"heal"),window.UI.update()},healPlayer(e){let i=this.allies.filter(t=>!t.dead).sort((t,n)=>t.hp/t.maxHp-n.hp/n.maxHp)[0];i&&(i.hp=Math.min(i.maxHp,i.hp+e),window.UI.floatText(`+${e}`,`char-${i.role}`,"#2ecc71"),window.UI.log(`[æ²»ç–—] ${i.name} æ¢å¤ ${e} HP`,"heal")),window.UI.update()},addBlockAll(e){this.allies.forEach(i=>{i.dead||(i.block+=e)}),window.UI.log(`[æŠ¤ç›¾] å…¨å‘˜è·å¾— ${e} æŠ¤ç›¾`,"block"),window.UI.playSound("assets/BGM/shield.wav"),window.UI.update()},win(){this.phase="VICTORY",this.tm.clearAll(),window.UI.stopBGM(),window.UI.playSound("assets/BGM/victory.wav"),this.playerDeck=this.playerDeck.concat(this.hand,this.discard),this.hand=[],this.discard=[];let e=20+Math.floor(Math.random()*10);this.enemy.type==="elite"&&(e=50+Math.floor(Math.random()*15)),this.enemy.type==="boss"&&(e=100),window.game.gold+=e,this.enemy.type==="boss"&&(window.game.mapGraph=[]),window.game.level%5===0&&window.UI.toast("BOSS å‡»ç ´! å®Œç¾æ¼”å‡º!"),setTimeout(()=>{this.enemy.type==="battle"?(window.UI.switchScene("scene-reward"),window.UI.renderUpgradeRewards(e)):(window.UI.toast(`è·å¾—é‡‘å¸: ${e}`),(this.enemy.type==="elite"||this.enemy.type==="boss")&&window.game.campAction("relic"))},1e3)},endTurn(){this.phase="ENEMY_TURN",document.getElementById("btn-end").disabled=!0,this.discard.push(...this.hand),this.hand=[],window.UI.update(),this.tm.add(()=>this.enemyAction(),800)},enemyAction(){if(this.phase==="VICTORY")return;let e=400;if(this.enemy.block=0,window.game.partyRoles.includes("vocalist")&&this.healAll(5),this.enemy.stunned)window.UI.toast("æ•Œäººè¢«å†°å†»!"),this.enemy.stunned=!1,window.UI.update();else{let i=this.enemy.intent.type,t=this.enemy.intent.val;if(i==="atk"||i==="atk_heavy"||i==="atk_vuln"){const n=document.getElementById("sprite-enemy"),o=this.enemy.name==="å¤±å¾‹å«å£«",a=this.enemy.name==="å¤±è¡¡èˆè€…",s=this.enemy.name==="å¯‚é™æŒ‡æŒ¥å®¶",c=this.enemy.name==="æ¶æ„å…«éŸ³ç›’",r=this.enemy.name==="æ‚éŸ³å”±è¯—ç­",l=this.enemy.name==="æ‚éŸ³å¾®ç²’";if(n){let h="anim-enemy-atk";if(o&&(h="anim-knight-attack"),a&&(h="anim-dancer-attack"),s&&(h="anim-demon-cast"),c&&(h="anim-bayinhe-attack"),r&&(h="anim-choir-attack"),l&&(h="anim-slime-atk"),o||a||c||l){const f=this.getFrontAlly(),p=f?document.getElementById(`char-${f.role}`):null;if(p){const m=n.getBoundingClientRect(),u=p.getBoundingClientRect().left-m.left+60;n.style.setProperty("--attack-dist",`${u}px`)}}n.classList.remove("anim-knight-attack","anim-dancer-attack","anim-demon-cast","anim-bayinhe-attack","anim-choir-attack","anim-enemy-atk","anim-slime-atk"),n.offsetWidth,n.classList.add(h),o&&window.UI.playSound("assets/BGM/monster.wav")}let d=300;o&&(d=710),a&&(d=450),s&&(d=750),c&&(d=750),r&&(d=480),l&&(d=600),setTimeout(()=>{let h=parseInt(t),f=parseInt(this.enemy.buffs.str||0),p=h+f;console.log(`[Damage Debug] Turn: ${this.turnCount}, Enemy: ${this.enemy.name}, Base: ${h}, Str: ${f}, Final: ${p}`);let m=this.getFrontAlly();if(m){this.enemy.name==="æ‚éŸ³å”±è¯—ç­"&&(window.UI.spawnVFX("Psychic_Shriek","sprite-enemy"),window.UI.playSound("assets/BGM/attack-cannibal-beast.wav")),this.enemy.name==="æ‚éŸ³å¾®ç²’"&&(window.UI.spawnVFX("heavy_hit",`char-${m.role}`),window.UI.playSound("assets/BGM/shadowboss_attack.wav")),o&&(window.UI.spawnVFX("Heavy_Rending",`char-${m.role}`),window.UI.spawnVFX("Blood_Splatter",`char-${m.role}`)),a&&(window.UI.spawnVFX("Sharp_Slash",`char-${m.role}`),window.UI.spawnVFX("Blood_Splatter",`char-${m.role}`)),s&&(window.UI.spawnVFX("Boss_wave",`char-${m.role}`),window.UI.playSound("assets/BGM/nastyattack.wav")),c&&(window.UI.spawnVFX("Heavy_Rending",`char-${m.role}`),window.UI.spawnVFX("Blood_Splatter",`char-${m.role}`));const y=document.getElementById(`char-${m.role}`);if(y&&(y.classList.remove("anim-ally-hit"),y.offsetWidth,y.classList.add("anim-ally-hit")),m.block>0){let u=Math.min(m.block,p);m.block-=u,p-=u}p>0?(p=Math.floor(p),m.hp=Math.floor(m.hp-p),window.UI.floatText(`-${p}`,`char-${m.role}`,"#cc0000"),window.UI.log(`${this.enemy.name} æ”»å‡» ${m.name} é€ æˆ ${p} ä¼¤å®³`,"enemy"),window.UI.shake(),m.hp<=0&&(m.hp=0,m.dead=!0,m.block=0,window.UI.toast(`${m.name} å€’ä¸‹äº†!`),window.UI.log(`${m.name} é˜µäº¡`,"enemy"),window.game.relics.includes("mozart_quill")&&!this.mozartTriggered&&(this.dmgEnemy(30,!0),window.UI.toast("å®‰é­‚æ›²: ç»å”±!"),window.UI.spawnVFX("Psychic_Shriek","sprite-enemy"),this.mozartTriggered=!0))):(window.UI.floatText("æ ¼æŒ¡!",`char-${m.role}`,"#3498db"),window.UI.log(`${m.name} æ ¼æŒ¡äº†æ”»å‡»`,"block")),i==="atk_vuln"&&window.UI.floatText("å‹åˆ¶!",`char-${m.role}`,"#e67e22")}window.UI.update()},d);let w=600;o&&(w=1200),a&&(w=1e3),s&&(w=1500),c&&(w=1500),r&&(w=1200),l&&(w=1200),setTimeout(()=>{n&&(n.style.backgroundImage=`url('${this.enemy.sprite}')`,n.classList.remove("anim-knight-attack","anim-dancer-attack","anim-demon-cast","anim-bayinhe-attack","anim-choir-attack","anim-enemy-atk","anim-slime-atk"),window.UI.update())},w),e=Math.max(e,s||c?1600:r||o||l?1300:800)}else{if(i==="def"){let n=Math.floor(this.enemy.maxHp*.1);if(this.enemy.block+=n,window.UI.floatText(`æŠ¤ç›¾+${n}`,"sprite-enemy","#3498db"),this.enemy.name==="å¤±å¾‹å«å£«"){const o=document.getElementById("sprite-enemy");o&&(o.classList.remove("anim-knight-defend"),o.offsetWidth,o.classList.add("anim-knight-defend"),window.UI.playSound("assets/BGM/shield.wav"),setTimeout(()=>o.classList.remove("anim-knight-defend"),1200)),e=1300}}else if(i==="def_block"){let n=Math.floor(this.enemy.maxHp*.25);this.enemy.block+=n,window.UI.floatText(`å¼ºåŠ›æŠ¤ç›¾+${n}`,"sprite-enemy","#3498db")}else if(i==="buff"){if(this.enemy.buffs.str+=2,window.UI.floatText("åŠ›é‡UP!","sprite-enemy","#e74c3c"),this.enemy.name==="å¯‚é™æŒ‡æŒ¥å®¶"){const n=document.getElementById("sprite-enemy");n&&(n.classList.remove("anim-demon-buff"),n.offsetWidth,n.classList.add("anim-demon-buff"),window.UI.playSound("assets/BGM/piano-string-glissando-low-a.wav"),setTimeout(()=>n.classList.remove("anim-demon-buff"),1500)),e=1600}}else if(i==="buff_str"){if(this.enemy.buffs.str+=3,window.UI.floatText("è“„åŠ›!","sprite-enemy","#e74c3c"),this.enemy.name==="æ¶æ„å…«éŸ³ç›’"){const n=document.getElementById("sprite-enemy");n&&(n.classList.remove("anim-bayinhe-buff"),n.offsetWidth,n.classList.add("anim-bayinhe-buff"),window.UI.playSound("assets/BGM/monster.wav"),setTimeout(()=>n.classList.remove("anim-bayinhe-buff"),1200)),e=1300}}else if(i==="debuff"&&(this.enemy.buffs.vuln=0,window.UI.floatText("å‡€åŒ–","sprite-enemy","#fff"),this.enemy.name==="å¯‚é™æŒ‡æŒ¥å®¶")){const n=document.getElementById("sprite-enemy");n&&(n.classList.remove("anim-demon-buff"),n.offsetWidth,n.classList.add("anim-demon-buff"),window.UI.playSound("assets/BGM/piano-string-glissando-low-a.wav"),setTimeout(()=>n.classList.remove("anim-demon-buff"),1500)),e=1600}window.UI.update()}}this.enemy.buffs.vuln>0&&this.enemy.buffs.vuln--,this.tempStrDebuff>0&&(this.enemy.buffs.str+=this.tempStrDebuff,window.UI.floatText("åŠ›é‡æ¢å¤","sprite-enemy","#e74c3c"),this.tempStrDebuff=0),setTimeout(()=>{window.UI.update(),this.planEnemy(),this.tm.add(()=>this.startTurn(),800)},e)},planEnemy(){let e=5+Math.floor(window.game.level*1.5),t=[...window.battle.enemy.acts||["atk"]];this.enemy.name==="å¯‚é™æŒ‡æŒ¥å®¶"&&(this.enemy.buffs.vuln>0||(t=t.filter(a=>a!=="debuff"))),this.enemy.name==="æ¶æ„å…«éŸ³ç›’"&&(this.enemy.buffs.str||0)>=6&&(t=t.filter(a=>a!=="buff_str")),t.length===0&&(t=["atk"]);const n=t[Math.floor(Math.random()*t.length)];n==="atk"?this.enemy.intent={type:"atk",val:e,icon:"assets/UI/attack.png"}:n==="def"?this.enemy.intent={type:"def",val:0,icon:"assets/UI/Defend.png"}:n==="buff"?this.enemy.intent={type:"buff",val:0,icon:"assets/UI/Mana.png"}:n==="debuff"?this.enemy.intent={type:"debuff",val:0,icon:"assets/UI/Debuff.png"}:n==="atk_heavy"?this.enemy.intent={type:"atk_heavy",val:Math.floor(e*1.5),icon:"assets/UI/attack.png"}:n==="atk_vuln"?this.enemy.intent={type:"atk_vuln",val:Math.floor(e*.8),icon:"assets/UI/Debuff.png"}:n==="buff_str"?this.enemy.intent={type:"buff_str",val:0,icon:"assets/UI/Mana.png"}:n==="def_block"&&(this.enemy.intent={type:"def_block",val:0,icon:"assets/UI/Defend.png"})},deselect(){this.selectedCard=-1,window.UI.update()}};window.game={partyRoles:[],level:1,relics:[],cardLevels:{},start(){window.UI.switchScene("scene-select"),window.UI.renderCharSelect("grid-start",e=>this.initParty(e)),window.UI.playBGM("assets/BGM/Ravel_Gaspard de la Nuit.mp3")},initParty(e,i=!0){this.partyRoles=[e],this.level=1,this.gold=100,this.relics=[],this.cardLevels={},this.mapGraph=[],this.currentMapPos={layer:-1,index:-1};const t=window.ROLES[e];window.battle.manaData={current:3,max:3,draw:5},e==="pianist"&&(window.battle.manaData.max=4),e==="violinist"&&(window.battle.manaData.draw+=1),window.battle.allies=[this.createAlly(e)];const n=[...window.COMMON_DECK,...t.deck];window.battle.playerDeck=[...n],i&&this.mapSelect()},createAlly(e){const i=window.ROLES[e];return{role:e,name:i.name,hp:i.hp,maxHp:i.hp,block:0,dead:!1}},mapSelect(){window.UI.playBGM("assets/BGM/Ravel_Gaspard de la Nuit.mp3"),window.UI.switchScene("scene-map"),window.UI.update();const e=document.getElementById("map-level-num");e&&(e.innerText=this.level),this.mapGraph.length===0&&(this.generateSectorMap(),this.currentMapPos={layer:-1,index:-1}),window.UI.renderMap(this.mapGraph,this.currentMapPos)},generateSectorMap(){const e=[];e.push([{type:"start",name:"èµ·ç‚¹",desc:"æ–°çš„ä¹ç« å¼€å§‹",next:[]}]);for(let t=1;t<5;t++){const n=2+Math.floor(Math.random()*2),o=[];for(let a=0;a<n;a++){let s="battle",c=Math.random();c<.15?s="camp":c<.35?s="shop":c<.45&&t>1?s="elite":c<.55&&this.partyRoles.length<4?s="recruit":s="battle";let r="é­é‡æˆ˜";s==="camp"&&(r="è¥åœ°"),s==="shop"&&(r="ä¹å™¨åº—"),s==="elite"&&(r="ç²¾è‹±æˆ˜"),s==="recruit"&&(r="éŸ³ä¹å…"),o.push({type:s,name:r,next:[]})}e.push(o)}e.push([{type:"boss",name:"å†³æˆ˜",desc:"æœ€ç»ˆè€ƒéªŒ",next:[]}]);for(let t=0;t<5;t++){const n=e[t],o=e[t+1];n.forEach(a=>{if(t===0)o.forEach((s,c)=>a.next.push(c));else{const s=1+(Math.random()>.5?1:0);for(let c=0;c<s;c++){const r=Math.floor(Math.random()*o.length);a.next.includes(r)||a.next.push(r)}}}),o.forEach((a,s)=>{if(!n.some(r=>r.next.includes(s))){const r=Math.floor(Math.random()*n.length);n[r].next.push(s)}}),n.forEach(a=>a.next.sort((s,c)=>s-c))}this.mapGraph=e},enterNode(e,i,t){if(this.currentMapPos={layer:i,index:t},e==="start"){this.mapSelect();return}e==="recruit"?(window.UI.switchScene("scene-recruit"),setTimeout(()=>window.UI.renderCharSelect("grid-recruit",n=>this.recruit(n)),100)):e==="camp"?this.showCamp():e==="shop"?this.showShop():this.startLevel(e)},shopData:{cards:[],relics:[],services:[]},showShop(){window.UI.switchScene("scene-shop"),this.shopData={cards:[],relics:[],services:[]};const e=[...new Set(window.battle.playerDeck)].filter(n=>(this.cardLevels[n]||0)<5);e.sort(()=>Math.random()-.5),e.slice(0,3).forEach(n=>{const o=this.cardLevels[n]||0,a=50+o*25;this.shopData.cards.push({id:n,price:a,sold:!1,level:o})});const t=Object.keys(window.RELICS).filter(n=>!this.relics.includes(n));if(t.length>0){const n=t[Math.floor(Math.random()*t.length)];this.shopData.relics.push({key:n,price:160,sold:!1})}this.shopData.services.push({type:"remove",name:"å¿˜å´ä¹è°±",desc:"ä»ç‰Œç»„ä¸­ç§»é™¤ä¸€å¼ ç‰Œ",price:75,sold:!1,icon:"assets/UI/banish_icon.png"}),this.shopData.services.push({type:"heal",name:"èŒ¶æ­‡",desc:"å…¨å‘˜æ¢å¤ 30% ç”Ÿå‘½",price:50,sold:!1,icon:"assets/UI/heal_icon.png"}),window.UI.renderShop(this.shopData),window.UI.update()},buyItem(e,i){let t=this.shopData[e][i];if(!t.sold){if(this.gold<t.price){window.UI.toast("é‡‘å¸ä¸è¶³!");return}if(e==="cards")this.gold-=t.price,this.cardLevels[t.id]=(this.cardLevels[t.id]||0)+1,window.UI.toast(`å¼ºåŒ–æˆåŠŸ: ${window.CARDS[t.id].name} +${this.cardLevels[t.id]}`),t.sold=!0;else if(e==="relics")this.gold-=t.price,this.relics.push(t.key),window.UI.toast(`è´­ä¹°äº† ${window.RELICS[t.key].name}`),t.key==="sheet_music"&&Object.keys(window.game.cardLevels).forEach(n=>window.game.cardLevels[n]++),t.sold=!0;else if(e==="services"){if(t.type==="heal")this.gold-=t.price,window.battle.allies.forEach(n=>{n.dead?(n.dead=!1,n.hp=Math.floor(n.maxHp*.3)):n.hp=Math.min(n.maxHp,n.hp+Math.floor(n.maxHp*.3))}),window.UI.toast("å…¨å‘˜æ¢å¤!"),t.sold=!0;else if(t.type==="remove"){if(window.battle.playerDeck.length<=5){window.UI.toast("å¡ç»„è¿‡è–„ï¼Œæ— æ³•ç§»é™¤");return}window.UI.showDeckModal(window.battle.playerDeck,"é€‰æ‹©è¦ç§»é™¤çš„å¡ç‰Œ",(n,o)=>{this.gold>=t.price&&(this.gold-=t.price,window.battle.playerDeck.splice(o,1),window.UI.toast("ç§»é™¤æˆåŠŸ"),t.sold=!0,window.UI.closeDeckModal(),window.UI.renderShop(this.shopData),window.UI.update())});return}}window.UI.renderShop(this.shopData),window.UI.update()}},leaveShop(){this.mapSelect()},startLevel(e){window.battle.reset(),window.battle.allies.forEach(o=>{o.role==="cellist"&&(o.block=8)}),this.relics.includes("baton")&&window.battle.manaData.current++;let i=window.ENEMIES.noise,t=1;if(e==="boss")i=window.ENEMIES.silence,t=3,window.UI.playBGM("assets/BGM/Scythian Suite.mp3");else if(e==="elite"){const o=["discord","shihengwuzhe"],a=o[Math.floor(Math.random()*o.length)];i=window.ENEMIES[a],t=1.8,window.UI.stopBGM(),a==="shihengwuzhe"?window.UI.playBGM("assets/BGM/Shostakovich_String Quartet.mp3"):a==="discord"&&window.UI.playBGM("assets/BGM/Mahler - Symphony.mp3")}else{const o=["noise","bayinhe","changshiban"],a=o[Math.floor(Math.random()*o.length)];i=window.ENEMIES[a],t=1,window.UI.stopBGM(),a==="changshiban"?window.UI.playBGM("assets/BGM/bin ich nun frei.m4a"):window.UI.playBGM("assets/BGM/Bruckner.mp3")}const n=(30+this.level*8)*t;window.battle.enemy={type:e,name:i.name,sprite:i.sprite,hp:Math.floor(n*i.hpScale),maxHp:Math.floor(n*i.hpScale),block:0,intent:{type:"atk",val:0},stunned:!1,buffs:{vuln:0,res:0,str:0},acts:i.act},window.battle.planEnemy(),window.UI.switchScene("scene-battle"),window.battle.phase="PREPARE",window.UI.renderBattleField(),window.UI.update(),document.getElementById("prep-ui").style.display="block",document.getElementById("hand").style.display="none",document.getElementById("btn-end").style.display="none",document.getElementById("party-container").classList.add("interactive")},recruit(e){if(this.partyRoles.includes(e))return;this.partyRoles.push(e);const i=window.ROLES[e];window.battle.manaData.max+=1,window.battle.manaData.draw+=1,e==="violinist"&&(window.battle.manaData.draw+=1),window.battle.allies.push(this.createAlly(e)),window.battle.playerDeck.push(...i.deck),e==="vocalist"&&window.battle.allies.forEach(t=>t.maxHp+=15),this.checkDuo(),window.UI.toast(`${i.name} åŠ å…¥! æ‰‹ç‰Œä¸Šé™+1`),setTimeout(()=>this.mapSelect(),1e3),this.level++},checkDuo(){window.DUO_CARDS.forEach(e=>{e.req.every(i=>this.partyRoles.includes(i))})},showCamp(){window.UI.switchScene("scene-camp")},getSmartRewards(){const e=window.DUO_CARDS.filter(n=>n.req.every(o=>this.partyRoles.includes(o))).map(n=>n.id);if(e.length===0)return[];const i=[],t=[...e];for(let n=0;n<3&&t.length!==0;n++){const o=Math.floor(Math.random()*t.length);i.push(t[o]),t.splice(o,1)}return i},campAction(e){if(e==="heal")window.battle.allies.forEach(i=>{i.dead?(i.dead=!1,i.hp=Math.floor(i.maxHp*.3)):i.hp=Math.min(i.maxHp,i.hp+Math.floor(i.maxHp*.3))}),window.UI.toast("ä¼‘æ•´å®Œæˆ");else if(e==="card"){window.UI.switchScene("scene-reward"),window.UI.renderRewards("new");return}else if(e==="upgrade"){let i=[...new Set([...window.battle.playerDeck])],t=[];if(i.length>0){for(let n=0;n<2&&i.length!==0;n++){const o=Math.floor(Math.random()*i.length),a=i[o];if((window.game.cardLevels[a]||0)>=5){i.splice(o,1),n--;continue}window.game.cardLevels[a]=(window.game.cardLevels[a]||0)+1;const s=window.game.cardLevels[a];t.push(window.CARDS[a].name+(s>0?`+${s}`:"")),i.splice(o,1)}t.length>0?window.UI.toast(`æŠ€è‰ºç²¾è¿›: ${t.join(", ")}`):window.UI.toast("æ‰€æœ‰æŠ€èƒ½å·²è¾¾åŒ–å¢ƒ (Max 5)")}}else if(e==="relic"){const t=Object.keys(window.RELICS).filter(n=>!this.relics.includes(n));if(t.length>0){const n=t[Math.floor(Math.random()*t.length)];this.relics.push(n),window.UI.toast(`è·å¾—åœ£ç‰©: ${window.RELICS[n].name}`),n==="sheet_music"&&Object.keys(window.game.cardLevels).forEach(o=>window.game.cardLevels[o]++)}else window.battle.allies.forEach(n=>{n.maxHp+=10,n.hp+=10}),window.UI.toast("è·å¾—: å¤©ä½¿ä¹‹ç¾½ (å…¨å±æ€§æå‡)")}setTimeout(()=>{this.level++,this.mapSelect()},1200)},finishReward(){this.level++,this.mapSelect()},showDeck(){const e=document.getElementById("scene-battle").classList.contains("active");let i=[];e?i=[...window.battle.playerDeck,...window.battle.hand,...window.battle.discard]:i=window.battle.playerDeck,window.UI.showDeckModal(i,`å½“å‰å¡ç»„ (${i.length})`)},closeDeck(){window.UI.closeDeckModal()},previewDeck(e,i){const t=window.ROLES[e];let n=[];i==="start"?n=[...window.COMMON_DECK,...t.deck]:n=[...t.deck],window.UI.showDeckModal(n,`${t.name} - æŠ€èƒ½é¢„è§ˆ`)},openDebugMenu(){window.UI.switchScene("scene-debug");const e=document.getElementById("debug-enemy-list");e.innerHTML="",this.partyRoles.length===0&&this.initParty("pianist",!1),Object.keys(window.ENEMIES).forEach(i=>{const t=window.ENEMIES[i],n=document.createElement("div");n.className="char-card",n.style.height="auto",n.style.padding="15px",n.innerHTML=`
                <img src="${t.sprite}" class="char-img" style="height:100px; object-fit:contain;">
                <div style="margin-top:10px; font-weight:bold;">${t.name}</div>
                <div style="font-size:0.8em; color:#888;">HP x ${t.hpScale}</div>
            `,n.onclick=()=>{this.startLevel("debug",i)},e.appendChild(n)})},startLevel(e,i=null){window.battle.reset(),window.battle.allies.forEach(a=>{a.role==="cellist"&&(a.block=8)}),this.relics.includes("baton")&&window.battle.manaData.current++;let t=window.ENEMIES.noise,n=1;if(i&&window.ENEMIES[i])t=window.ENEMIES[i],e="battle",i==="silence"?(e="boss",n=3):["discord","shihengwuzhe"].includes(i)?(e="elite",n=1.8):n=1,window.UI.stopBGM(),i==="silence"?window.UI.playBGM("assets/BGM/Scythian Suite.mp3"):i==="shihengwuzhe"?window.UI.playBGM("assets/BGM/Shostakovich_String Quartet.mp3"):i==="discord"?window.UI.playBGM("assets/BGM/Mahler - Symphony.mp3"):i==="changshiban"?window.UI.playBGM("assets/BGM/bin ich nun frei.m4a"):window.UI.playBGM("assets/BGM/Bruckner.mp3");else if(e==="boss")t=window.ENEMIES.silence,n=3,window.UI.playBGM("assets/BGM/Scythian Suite.mp3");else if(e==="elite"){const a=["discord","shihengwuzhe"],s=a[Math.floor(Math.random()*a.length)];t=window.ENEMIES[s],n=1.8,window.UI.stopBGM(),s==="shihengwuzhe"?window.UI.playBGM("assets/BGM/Shostakovich_String Quartet.mp3"):s==="discord"&&window.UI.playBGM("assets/BGM/Mahler - Symphony.mp3")}else{const a=["noise","bayinhe","changshiban"],s=a[Math.floor(Math.random()*a.length)];t=window.ENEMIES[s],n=1,window.UI.stopBGM(),s==="changshiban"?window.UI.playBGM("assets/BGM/bin ich nun frei.m4a"):window.UI.playBGM("assets/BGM/Bruckner.mp3")}const o=(30+this.level*8)*n;window.battle.enemy={type:e,name:t.name,sprite:t.sprite,hp:Math.floor(o*t.hpScale),maxHp:Math.floor(o*t.hpScale),block:0,intent:{type:"atk",val:0},stunned:!1,buffs:{vuln:0,res:0,str:0},acts:t.act},window.battle.planEnemy(),window.UI.switchScene("scene-battle"),window.battle.phase="PREPARE",window.UI.renderBattleField(),window.UI.update(),document.getElementById("prep-ui").style.display="block",document.getElementById("hand").style.display="none",document.getElementById("btn-end").style.display="none",document.getElementById("party-container").classList.add("interactive")}};
