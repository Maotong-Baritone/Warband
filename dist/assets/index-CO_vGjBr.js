(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();window.TimerManager=class{constructor(){this.timers=[]}add(s,t){const n=setTimeout(s,t);return this.timers.push(n),n}clearAll(){this.timers.forEach(s=>clearTimeout(s)),this.timers=[]}};const w={roles:"assets/Roles/",enemies:"assets/Enemies/",vfx:"assets/vfx/",cards:"assets/Cards/"},E=[2,3,4,6,7,17,18],x={pianist:{id:"pianist",name:"å¹»å¥è£å†³è€…",hp:60,sprite:w.roles+"pianist.png",deck:[1,19,30],buff:"çµæ„Ÿä¸Šé™ +1"},violinist:{id:"violinist",name:"é“¶å¼¦åœ£å¾’",hp:50,sprite:w.roles+"violinist.png",deck:[5,20,31],buff:"æ‰‹ç‰Œä¸Šé™ +1"},vocalist:{id:"vocalist",name:"é•‡é­‚åŸå”±è€…",hp:45,sprite:w.roles+"vocalist.png",deck:[8,9,10],buff:"å›åˆç»“æŸå› 5 HP"},cellist:{id:"cellist",name:"æ²‰éŸ³å®ˆæœ›è€…",hp:75,sprite:w.roles+"cellist.png",deck:[11,12,13],buff:"åˆå§‹è·å¾— 8 æŠ¤ç›¾"},brass:{id:"brass",name:"ç ´æ™“å·æ‰‹",hp:70,sprite:w.roles+"brass.png",deck:[14,15,16],buff:"é«˜è´¹å¡(>=2)é¢å¤–+5ä¼¤å®³"},flutist:{id:"flutist",name:"çµé£è¡Œè€…",hp:45,sprite:w.roles+"flutist.png",deck:[24,25,26],buff:"æ¯å›åˆç¬¬ä¸€å¼ ç‰Œå˜ä¸ºæ— æ¶ˆè€—"},percussionist:{id:"percussionist",name:"é›·éœ†éœ‡å‡»è€…",hp:70,sprite:w.roles+"percussionist.png",deck:[27,28,29],buff:"æ”»å‡»ä¼¤å®³ +2"},conductor:{id:"conductor",name:"çµé­‚ç»‡å¾‹è€…",hp:55,sprite:w.roles+"conductor.png",deck:[21,22,23],buff:"åˆå¥ç‰Œæ¶ˆè€— -1"}},B={noise:{name:"æ‚éŸ³å¾®ç²’",sprite:w.enemies+"slime.png",hpScale:1,act:["atk"]},discord:{name:"å¤±å¾‹å«å£«",sprite:w.enemies+"knight.png",hpScale:1.5,act:["atk","atk","atk","def"]},silence:{name:"å¯‚é™æŒ‡æŒ¥å®¶",sprite:w.enemies+"demon.png",hpScale:2.5,act:["atk","atk","buff","debuff"]},bayinhe:{name:"æ¶æ„å…«éŸ³ç›’",sprite:w.enemies+"bayinhe.png",hpScale:1.2,act:["buff_str","buff_str","atk_heavy"]},changshiban:{name:"æ‚éŸ³å”±è¯—ç­",sprite:w.enemies+"changshiban.png",hpScale:1.8,act:["atk_vuln","atk","atk_vuln"]},shihengwuzhe:{name:"å¤±è¡¡èˆè€…",sprite:w.enemies+"shihengwuzhe.png",hpScale:2,act:["atk_heavy","atk_heavy","def_block"]}},$={metronome:{name:"èŠ‚æ‹å™¨",icon:"â°",desc:"æ¯å›åˆç¬¬ä¸€å¼ æ”»å‡»ç‰Œæ‰“å‡ºä¸¤æ¬¡"},rosin:{name:"æ¾é¦™",icon:"ğŸ§‚",desc:"æ¯æ¬¡é€ æˆä¼¤å®³æ—¶æ–½åŠ  1 å±‚æ˜“ä¼¤"},baton:{name:"æŒ‡æŒ¥æ£’",icon:"ğŸª„",desc:"æˆ˜æ–—å¼€å§‹æ—¶é¢å¤–è·å¾— 1 ç‚¹çµæ„Ÿ"},tuning_fork:{name:"éŸ³å‰",icon:"Y",desc:"å›åˆç»“æŸæ—¶ä¿ç•™ 10 ç‚¹æŠ¤ç›¾"},sheet_music:{name:"å¤è€ä¹è°±",icon:"ğŸ“œ",desc:"æ‰€æœ‰åˆå§‹å¡ç‰Œç­‰çº§+1"},beethoven_ear:{name:"è´å¤šèŠ¬çš„å¤±èªè€³èœ—",icon:"ğŸ‘‚",desc:"HP < 30% æ—¶ï¼Œé€ æˆä¼¤å®³ç¿»å€"},paganini_string:{name:"å¸•æ ¼å°¼å°¼çš„æ–­å¼¦",icon:"ğŸ»",desc:"é¦–å¼ æ”»å‡»ç‰Œè€—èƒ½-1ï¼Œä½†è‡ªä¼¤ 2 ç‚¹"},mozart_quill:{name:"è«æ‰ç‰¹çš„å®‰é­‚ç¾½ç¬”",icon:"âœ’ï¸",desc:"é˜Ÿå‹æ¿’æ­»æ—¶ï¼Œå¯¹æ•Œé€ æˆ 30 çœŸå®ä¼¤å®³"},bach_lens:{name:"å·´èµ«çš„èµ‹æ ¼é€é•œ",icon:"ğŸ”",desc:"è¿ç»­æ‰“å‡º 3 å¼ åŒç±»ç‰Œï¼ŒæŠ½1ç‰Œ+1è´¹"},liszt_bullet:{name:"ææ–¯ç‰¹çš„é­”å¼¹",icon:"ğŸ¹",desc:"æ‰€æœ‰å¤šæ®µæ”»å‡»æ¬¡æ•° +1"}},k=[{id:101,name:"å†¬ä¹‹æ—…",cost:1,req:["pianist","vocalist"],val:12,desc:"{val} ä¼¤å®³ + å†°å†»ã€‚",img:w.cards+"dongzhilv.png",type:"duo",act:(e,s)=>{e.dmgEnemy(Math.ceil(12*s)),window.UI.toast("å¯’å†¬é™ä¸´..."),e.enemy.stunned=!0,window.UI.spawnVFX("ice","sprite-enemy")}},{id:102,name:"å…‹é²é‡‡",cost:0,req:["pianist","violinist"],val:6,desc:"ç‹‚æš´ {val} ä¼¤å®³ x 4 æ¬¡ã€‚",img:w.cards+"kelucai.png",type:"duo",act:(e,s)=>{for(let t=0;t<4;t++)e.tm.add(()=>{e.dmgEnemy(Math.ceil(6*s)),window.UI.spawnVFX("slash","sprite-enemy")},t*150)}},{id:103,name:"ç»¿æ ‘æˆè«",cost:1,req:["violinist","vocalist"],val:15,desc:"å…¨å‘˜å› {val} HP + 5 ç›¾ã€‚",img:w.cards+"lvshuchengyin.png",type:"duo",act:(e,s)=>{e.healAll(Math.ceil(15*s)),e.addBlockAll(Math.ceil(5*s)),window.UI.toast("ç¥åœ£å®é™"),window.UI.spawnVFX("heal","party-container")}},{id:104,name:"å¼¦ä¹æŸ”æ¿",cost:1,req:["violinist","cellist"],val:30,desc:"å‰æ’è·å¾— {val} æŠ¤ç›¾å¹¶åä¼¤ã€‚",img:w.cards+"adagio.png",type:"duo",act:(e,s)=>{let t=e.getFrontAlly();t&&(t.block+=Math.ceil(30*s),e.dmgEnemy(t.block),window.UI.spawnVFX("shield",`char-${t.role}`))}},{id:105,name:"ç‹‚æ¬¢èŠ‚",cost:2,req:["pianist","cellist"],val:8,desc:"éšæœº {val} ä¼¤å®³ x 5 æ¬¡ã€‚",img:w.cards+"carnival.png",type:"duo",act:(e,s)=>{for(let t=0;t<5;t++)e.tm.add(()=>{e.dmgEnemy(Math.ceil(8*s)),window.UI.spawnVFX("heavy_hit","sprite-enemy")},t*120)}},{id:106,name:"æ‚²æ­Œ",cost:2,req:["pianist","vocalist","cellist"],val:30,desc:"{val} çœŸå®ä¼¤å®³ + å…¨å‘˜å›è¡€ã€‚",img:w.cards+"elegie.png",type:"trio",act:(e,s)=>{e.dmgEnemy(Math.ceil(30*s)),e.healAll(Math.ceil(20*s)),window.UI.spawnVFX("soundwave","sprite-enemy"),window.UI.spawnVFX("heal","party-container")}}],S={1:{name:"çƒ­æƒ…",cost:2,type:"atk",val:16,tag:"atk",img:w.cards+"reqing.png",desc:"{val} ä¼¤å®³",vfx:"heavy_hit",owner:"pianist"},19:{name:"å¤è°ƒå±•å¼€",cost:1,type:"skill",val:0,tag:"buff",img:w.cards+"fudiao.png",desc:"æŠ½ {draw} ç‰Œï¼Œè‹¥æœ‰éæ”»å‡»ç‰Œå›1è´¹",eff:"polyphony",vfx:"heal",owner:"pianist"},30:{name:"å°¾å£°",cost:1,type:"atk",val:6,tag:"atk",img:w.cards+"weisheng.png",desc:"{val} ä¼¤å®³ (æ¯å¼ æ‰‹ç‰Œ+3ä¼¤å®³)",eff:"hand_scale",vfx:"heavy_hit",owner:"pianist"},2:{name:"ä¸åå’Œ",cost:1,type:"debuff",val:5,tag:"atk",img:w.cards+"buxiehe.png",desc:"{val} ä¼¤å®³ + æ˜“ä¼¤",vfx:"dissonance",owner:"common"},3:{name:"ä¼‘æ­¢ç¬¦",cost:1,type:"def",val:7,tag:"def",img:w.cards+"xiuzhifu.png",desc:"å‰æ’è·å¾— {val} æŠ¤ç›¾",vfx:"shield",owner:"common"},4:{name:"é¢¤éŸ³",cost:0,type:"atk",val:5,tag:"atk",img:w.cards+"chanyin.png",desc:"{val} ä¼¤å®³, æŠ½1ç‰Œ",eff:"draw",vfx:"heavy_hit",owner:"common"},6:{name:"ç‹¬å¥",cost:2,type:"atk",val:14,tag:"atk",img:w.cards+"duzou.png",desc:"{val} ç©¿é€ä¼¤å®³",pierce:!0,vfx:"slash",owner:"common"},7:{name:"æ€¥æ¿",cost:0,type:"atk",val:4,tag:"atk",img:w.cards+"jiban.png",desc:"{val} ä¼¤å®³, å›1è´¹",eff:"mana",vfx:"slash",owner:"common"},17:{name:"æ¸å¼º",cost:1,type:"atk",val:6,tag:"atk",img:w.cards+"jianqiang.png",desc:"{val} ä¼¤å®³(éšæœ¬åœºæ”»å‡»æ¬¡æ•°æˆé•¿)",eff:"crescendo",vfx:"soundwave",owner:"common"},18:{name:"å˜å¥",cost:1,type:"skill",val:0,tag:"buff",img:w.cards+"bianzou.png",desc:"ä¸‹ä¸€å¼ ç‰Œæ•ˆæœ +50%",eff:"variation",vfx:"heal",owner:"common"},5:{name:"è¿å¼“",cost:1,type:"atk",val:6,hits:2,tag:"atk",img:w.cards+"yungong.png",desc:"{val} ä¼¤å®³ x2",vfx:"slash",owner:"violinist"},20:{name:"åŒéŸ³",cost:1,type:"atk",val:4,tag:"atk",img:w.cards+"shuangyin.png",desc:"é€ æˆ 3 + è´Ÿé¢çŠ¶æ€å±‚æ•°æ¬¡ {val} ç‚¹ä¼¤å®³",eff:"double_stop",vfx:"slash",owner:"violinist"},31:{name:"æ‹¨å¥",cost:0,type:"atk",val:3,tag:"atk",img:w.cards+"bozou.png",desc:"{val} ä¼¤å®³ï¼Œæ–½åŠ  2 å±‚æ˜“ä¼¤",eff:"vuln2",vfx:"slash",owner:"violinist"},8:{name:"å°–å•¸",cost:1,type:"atk",val:10,tag:"atk",img:w.cards+"jianxiao.png",desc:"{val} ä¼¤å®³ + 1å±‚å…±é¸£",eff:"screech",vfx:"soundwave",owner:"vocalist"},9:{name:"å…±é¸£",cost:1,type:"buff",val:3,tag:"buff",img:w.cards+"gongming.png",desc:"{val} å±‚å…±é¸£",vfx:"dissonance",owner:"vocalist"},10:{name:"å’å¹è°ƒ",cost:2,type:"spec",val:10,tag:"atk",img:w.cards+"yongtandiao.png",desc:"å¼•çˆ†å…±é¸£(å±‚æ•°x{val})",eff:"boom",vfx:"soundwave",owner:"vocalist"},11:{name:"ä½åŸ",cost:1,type:"def",val:12,tag:"def",img:w.cards+"diyin.png",desc:"å‰æ’è·å¾— {val} æŠ¤ç›¾",vfx:"shield",owner:"cellist"},12:{name:"é‡å¥",cost:2,type:"spec",val:100,tag:"atk",img:w.cards+"chongzou.png",desc:"é€ æˆç­‰åŒäºæŠ¤ç›¾ {val}% çš„ä¼¤å®³",eff:"bash",vfx:"heavy_hit",owner:"cellist"},13:{name:"ç´å¼¦å£å’",cost:1,type:"def",val:5,tag:"def",img:w.cards+"qinxian.png",desc:"è·å¾— {val} æŠ¤ç›¾ï¼ŒæŠ½ä¸€å¼ ç‰Œ",eff:"draw",vfx:"shield",owner:"cellist"},14:{name:"éœ‡è¡å·è§’",cost:1,type:"atk",val:8,tag:"atk",img:w.cards+"zhendanghaojiao.png",desc:"{val} ä¼¤å®³ï¼Œæ–½åŠ  2 å±‚æ˜“ä¼¤",vfx:"soundwave",owner:"brass",eff:"vuln2"},15:{name:"é«˜çˆ†éŸ³ç¬¦",cost:2,type:"atk",val:18,tag:"atk",img:w.cards+"gaobaoyinfu.png",desc:"{val} çˆ†å‘ä¼¤å®³ (AOE)",vfx:"heavy_hit",owner:"brass"},16:{name:"æ¯ç­äº¤å“",cost:3,type:"atk",val:35,tag:"atk",img:w.cards+"huimiejiaoxiang.png",desc:"{val} æ¯ç­æ€§æ‰“å‡»",eff:"catastrophe",vfx:"heavy_hit",owner:"brass"},21:{name:"èµ·æ‹",cost:0,type:"skill",val:0,tag:"buff",img:w.cards+"qipai.png",desc:"è·å¾— {mana} çµæ„Ÿï¼ŒæŠ½1å¼ ç‰Œ",eff:"upbeat",vfx:"heal",owner:"conductor"},22:{name:"ç¼„é»˜",cost:1,type:"atk",val:8,tag:"atk",img:w.cards+"jianmo.png",desc:"{val} ä¼¤å®³ï¼Œæœ¬å›åˆæ•ŒäººåŠ›é‡ -{str}",eff:"weaken",vfx:"dissonance",owner:"conductor"},23:{name:"å¤§åˆå¥",cost:2,type:"atk",val:15,tag:"atk",img:w.cards+"dahezou.png",desc:"{val} ä¼¤å®³ï¼Œå…¨å‘˜è·å¾— 8 ç‚¹æŠ¤ç›¾",eff:"tutti",vfx:"soundwave",owner:"conductor"},24:{name:"èŠ±èˆŒ",cost:0,type:"atk",val:3,tag:"atk",img:w.cards+"huashe.png",desc:"{val} ä¼¤å®³ (æ¬¡æ•°=æœ¬å›åˆå·²è€—çµæ„Ÿ)",eff:"flutter",vfx:"slash",owner:"flutist"},25:{name:"æ°”æ¯æ§åˆ¶",cost:1,type:"skill",val:0,tag:"buff",img:w.cards+"qixikongzhi.png",desc:"è·å¾— {mana} ç‚¹çµæ„Ÿ",eff:"breath",vfx:"heal",owner:"flutist"},26:{name:"ç©¿é€éŸ³",cost:1,type:"atk",val:8,tag:"atk",img:w.cards+"chuantouyin.png",desc:"{val} ç©¿é€ä¼¤å®³ï¼Œä¸”æŠ½ 1 å¼ ç‰Œ",pierce:!0,eff:"draw",vfx:"soundwave",owner:"flutist"},27:{name:"æ»šå¥",cost:1,type:"atk",val:4,hits:4,tag:"atk",img:w.cards+"gunzou.png",desc:"{val} ä¼¤å®³ x4",vfx:"heavy_hit",owner:"percussionist"},28:{name:"ç‚¸é•²",cost:2,type:"atk",val:10,tag:"atk",img:w.cards+"zhacha.png",desc:"{val} ä¼¤å®³ï¼Œå‡»æ™•æ•Œäºº(è·³è¿‡å›åˆ)",eff:"stun",vfx:"heavy_hit",owner:"percussionist"},29:{name:"å®šéŸ³",cost:1,type:"def",val:10,tag:"def",img:w.cards+"dingyin.png",desc:"å‰æ’è·å¾— {val} æŠ¤ç›¾ï¼Œä¸‹å›åˆä¿ç•™æŠ¤ç›¾",eff:"retain_block",vfx:"shield",owner:"percussionist"},101:k[0],102:k[1],103:k[2],104:k[3],105:k[4],106:k[5]};window.UI={switchScene(e){document.querySelectorAll(".scene").forEach(s=>s.classList.remove("active")),document.getElementById(e).classList.add("active")},renderCharSelect(e,s){const t=document.getElementById(e);t&&(t.innerHTML="",Object.keys(window.ROLES).forEach(n=>{if(e==="grid-recruit"&&window.game.partyRoles.includes(n))return;const o=window.ROLES[n],a=document.createElement("div");a.className="char-card";const i=e==="grid-start"?"start":"recruit";a.innerHTML=`
                <img src="${o.sprite}" class="char-img" onerror="this.style.backgroundColor='#333';this.alt='å›¾ç‰‡ä¸¢å¤±'">
                <div class="char-info">
                    <div style="color:#f0c040;font-weight:bold;font-size:1.2em">${o.name}</div>
                    <div class="bonus-text">
                        <div>â¤ï¸ HP: ${o.hp}</div>
                        <div>ğŸŒŸ ${o.buff}</div>
                    </div>
                    <button class="btn-preview" onclick="window.game.previewDeck('${n}', '${i}')">ğŸ” é¢„è§ˆå¡ç»„</button>
                </div>`,a.onclick=c=>{c.target.tagName!=="BUTTON"&&(c.stopPropagation(),e==="grid-recruit"&&a.classList.add("joined"),s(n))},t.appendChild(a)}))},renderBattleField(){const e=document.getElementById("party-container");e.innerHTML="",window.battle.allies.forEach((s,t)=>{const n=document.createElement("div");n.className="char-unit",n.id=`char-${s.role}`,n.onclick=()=>window.TacticManager.handleClick(t),n.style.zIndex=t+1,n.innerHTML=`
                <div class="mini-status">
                    <div class="mini-hp-text">
                        <img src="assets/UI/hp_icon.png" class="ui-icon" onerror="this.style.display='none'"> <span id="hp-text-${s.role}">${s.hp}</span>
                    </div>
                    <div class="mini-block" id="block-${s.role}" style="display:none">
                        <div class="block-bg"></div>
                        <div class="block-val" id="block-val-${s.role}"></div>
                    </div>
                </div>
                <div class="musician-sprite" style="background-image:url('${window.ROLES[s.role].sprite}')"></div>
            `,e.appendChild(n)})},highlightUnit(e,s){document.querySelectorAll(".char-unit").forEach((n,o)=>{n.classList.remove("swap-selected","swap-target"),s&&(o===e?n.classList.add("swap-selected"):n.classList.add("swap-target"))})},renderRewards(e="new"){const s=document.getElementById("reward-list");if(s.innerHTML="",e==="new"){document.getElementById("reward-title").innerText="é¢†æ‚Ÿæ–°ä¹è°±",document.getElementById("reward-text").innerText="é€‰æ‹©ä¸€å¼ åŠ å…¥ç‰Œç»„ (è‹¥å·²æœ‰åˆ™å¼ºåŒ–)";const t=window.game.getSmartRewards();for(let n of t){const o=window.CARDS[n],a=document.createElement("div");a.className="char-card",a.style.height="250px";const i=window.battle.playerDeck.includes(parseInt(n));let c=o.desc;o.val!==void 0&&(c=c.replace("{val}",o.val));let r=i?'<span style="color:#2ecc71">â˜… çªç ´ (å…¨å±€+1)</span>':'<span style="color:#f0c040">âœ¨ æ–°è·å–</span>',l=window.game.cardLevels[n]||0,d=l>0?` +${l}`:"";a.innerHTML=`
                    <img src="${o.img}" class="char-img" onerror="this.src=''">
                    <div class="char-info">
                        <b>${o.name}${d}</b>
                        <div style="margin:5px 0;">${r}</div>
                        <div class="card-desc"><span>${c}</span></div>
                    </div>`,a.onclick=()=>{if(i){if((window.game.cardLevels[n]||0)>=5){window.UI.toast(`${o.name} å·²è¾¾ç­‰çº§ä¸Šé™!`);return}window.game.cardLevels[n]=(window.game.cardLevels[n]||0)+1,window.UI.toast(`${o.name} çªç ´æˆåŠŸ!`)}else window.battle.playerDeck.push(parseInt(n)),window.UI.toast(`ä¹ å¾—: ${o.name}`);window.game.finishReward()},s.appendChild(a)}}},renderUpgradeRewards(e=0){const s=document.getElementById("reward-list");s.innerHTML="",document.getElementById("reward-title").innerText="æˆ˜ç«æ·¬ç‚¼",document.getElementById("reward-text").innerHTML=`è·å¾—é‡‘å¸: <img src="assets/UI/gold_icon.png" class="gold-icon-small"> <span style="color:#f0c040; font-weight:bold;">${e}</span><br>é€‰æ‹©ä¸€ç§æŠ€è‰ºè¿›è¡Œã€é’»ç ”ã€‘(ä¸Šé™ç­‰çº§ 5)`;const t=[...new Set(window.battle.playerDeck)].filter(a=>(window.game.cardLevels[a]||0)<5);if(t.length===0){s.innerHTML="<div style='color:#888'>æ‰€æœ‰æŠ€è‰ºå·²è¾¾åŒ–å¢ƒ</div>";return}const n=[...t],o=[];for(let a=0;a<3&&n.length!==0;a++){const i=Math.floor(Math.random()*n.length);o.push(n[i]),n.splice(i,1)}o.forEach(a=>{const i=window.CARDS[a],c=document.createElement("div");c.className="char-card",c.style.height="250px";const r=window.game.cardLevels[a]||0,l=r+1;i.val;let d=i.desc;if(i.eff==="variation"){const h=50+10*l;d=d.replace("50%",`${h}%`)}if(i.eff==="polyphony"){const h=2+Math.floor(l/2);d=d.replace("{draw}",`<span class="highlight-val">${h}</span>`)}if(i.eff==="upbeat"){const h=1+Math.floor(l/2);d=d.replace("{mana}",`<span class="highlight-val">${h}</span>`)}if(i.eff==="breath"){const h=2+l;d=d.replace("{mana}",`<span class="highlight-val">${h}</span>`)}if(i.eff==="weaken"){const h=2+l;d=d.replace("{str}",`<span class="highlight-val">${h}</span>`)}if(i.val!==void 0){const h=Math.ceil(i.val*(1+.5*l));d=d.replace("{val}",`<span class="highlight-val">${h}</span>`)}c.innerHTML=`
                <img src="${i.img}" class="char-img" onerror="this.src=''">
                <div class="char-info">
                    <b style="color:${r>0?"#2ecc71":"#eee"}">${i.name} ${r>0?"+"+r:""}</b>
                    <div style="font-size:2em; color:#f0c040; margin:2px 0;">â®• +${l}</div>
                    <div class="card-desc"><span>${d}</span></div>
                </div>`,c.onclick=()=>{window.game.cardLevels[a]=(window.game.cardLevels[a]||0)+1,window.UI.toast(`${i.name} é’»ç ”æˆåŠŸ!`),window.game.finishReward()},s.appendChild(c)})},renderMap(e,s){if(!e||e.length===0){console.warn("MapGraph is empty!");return}const t=parseInt(s.layer),n=parseInt(s.index);console.log("RenderMap:",t,n,"Graph Layers:",e.length);const o=document.getElementById("map-nodes"),a=document.getElementById("map-lines");!o||!a||(o.innerHTML="",a.innerHTML="",e.forEach((i,c)=>{const r=document.createElement("div");r.className="map-layer",r.id=`layer-${c}`,i.forEach((l,d)=>{var u;const h=document.createElement("div");h.className="map-node-v2",h.id=`node-${c}-${d}`;let m="locked";if(t===-1)c===0&&(m="reachable");else if(c<t)m="passed";else if(c===t)d===n?m="current":m="locked";else if(c===t+1){const f=(u=e[t])==null?void 0:u[n];f&&f.next&&f.next.includes(d)&&(m="reachable")}h.classList.add(m),l.type==="boss"&&h.classList.add("boss");let p="assets/UI/Battle.png";l.type==="elite"&&(p="assets/UI/Elite.png"),l.type==="camp"&&(p="assets/UI/camp.png"),l.type==="recruit"&&(p="assets/UI/Recruit.png"),l.type==="shop"&&(p="assets/UI/shop_icon.png"),l.type==="boss"&&(p="assets/UI/BossBattle.png"),l.type==="start"&&(p="assets/UI/common_button.png"),h.innerHTML=`<img src="${p}"><div class="node-name">${l.name}</div>`,m==="reachable"&&(h.onclick=()=>{console.log("Clicked Node:",l.type,c,d),window.game.enterNode(l.type,c,d)}),r.appendChild(h)}),o.appendChild(r)}),setTimeout(()=>{var r;const i=(r=document.getElementById("map-container"))==null?void 0:r.getBoundingClientRect();if(!i)return;e.forEach((l,d)=>{d>=e.length-1||l.forEach((h,m)=>{const p=document.getElementById(`node-${d}-${m}`);if(!p)return;const u=p.getBoundingClientRect();if(u.width===0)return;const f=u.left-i.left+u.width/2,v=u.top-i.top+u.height/2;h.next.forEach(g=>{const M=document.getElementById(`node-${d+1}-${g}`);if(!M)return;const b=M.getBoundingClientRect(),y=b.left-i.left+b.width/2,U=b.top-i.top+b.height/2,I=document.createElementNS("http://www.w3.org/2000/svg","line");I.setAttribute("x1",f),I.setAttribute("y1",v),I.setAttribute("x2",y),I.setAttribute("y2",U),I.setAttribute("stroke","#555"),I.setAttribute("stroke-width","2"),a.appendChild(I)})})});const c=document.getElementById("map-scroll-area");if(t===-1&&c)c.scrollTo({left:0,behavior:"smooth"});else{const l=document.getElementById(`layer-${t}`);if(c&&l){const d=l.offsetLeft-c.clientWidth/2+l.clientWidth/2;c.scrollTo({left:d,behavior:"smooth"})}}},100))},renderShop(e){const s=document.getElementById("shop-cards");s.innerHTML="";const t=document.getElementById("shop-relics");t.innerHTML="";const n=document.getElementById("shop-services");n.innerHTML="";const o=s.parentElement.querySelector("h3");o&&(o.innerHTML='<img src="assets/UI/upgrade_icon.png" class="icon-title"> æŠ€è‰ºç£¨ç‚¼ <span style="font-size:0.6em;color:#2ecc71">(å¼ºåŒ–)</span>'),e.cards.forEach((i,c)=>{const r=window.CARDS[i.id],l=document.createElement("div");l.className="shop-item"+(i.sold?" sold":"");const d=i.level,h=d+1;l.innerHTML=`
                <div style="position:relative; width:80px; height:80px;">
                    <img src="${r.img}" style="width:100%; height:100%; object-fit:contain;">
                    <div style="position:absolute; bottom:0; right:0; background:#2ecc71; color:#000; font-size:0.8em; padding:2px 4px; border-radius:4px; font-weight:bold;">
                        Lv.${d} -> ${h}
                    </div>
                </div>
                <div class="shop-item-name">${r.name}</div>
                <div class="shop-item-desc" style="color:#2ecc71">ç‚¹å‡»å¼ºåŒ–</div>
                <div class="shop-price"><img src="assets/UI/gold_icon.png" class="gold-icon-small"> ${i.price}</div>
            `,l.onclick=()=>window.game.buyItem("cards",c),s.appendChild(l)});const a=t.parentElement.querySelector("h3");a&&(a.innerHTML='<img src="assets/UI/mystery_relic_icon.png" class="icon-title"> ä¼ ä¸–åœ£ç‰©'),e.relics.forEach((i,c)=>{const r=window.RELICS[i.key],l=document.createElement("div");l.className="shop-item"+(i.sold?" sold":""),l.innerHTML=`
                <div style="position:relative; width:80px; height:80px; display:flex; align-items:center; justify-content:center;">
                    <img src="assets/UI/mystery_relic_icon.png" style="width:100%; height:100%; position:absolute; opacity:0.3;">
                    <span style="font-size:2.5em; position:relative; z-index:2;">${r.icon}</span>
                </div>
                <div class="shop-item-name">${r.name}</div>
                <div class="shop-item-desc">${r.desc}</div>
                <div class="shop-price"><img src="assets/UI/gold_icon.png" class="gold-icon-small"> ${i.price}</div>
            `,l.onclick=()=>window.game.buyItem("relics",c),t.appendChild(l)}),e.services.forEach((i,c)=>{const r=document.createElement("div");r.className="shop-item"+(i.sold?" sold":""),r.innerHTML=`
                <div style="width:80px; height:80px;"><img src="${i.icon}" style="width:100%; height:100%; object-fit:contain;"></div>
                <div class="shop-item-name">${i.name}</div>
                <div class="shop-item-desc">${i.desc}</div>
                <div class="shop-price"><img src="assets/UI/gold_icon.png" class="gold-icon-small"> ${i.price}</div>
            `,r.onclick=()=>window.game.buyItem("services",c),n.appendChild(r)})},showDeckModal(e,s,t=null){const n=document.getElementById("modal-overlay"),o=document.getElementById("modal-card-list");document.getElementById("modal-title").innerText=s,o.innerHTML="",n.classList.add("active");const a=t?e.map((i,c)=>({id:i,originalIdx:c})):[...e].sort((i,c)=>i-c).map(i=>({id:i}));if(a.length===0){o.innerHTML='<div style="color:#666; margin-top:50px;">æš‚æ— å¡ç‰Œ</div>';return}a.forEach(i=>{const c=i.id,r=window.CARDS[c],l=document.createElement("div");l.className="card-display",r.type==="duo"&&l.classList.add("duet"),r.type==="trio"&&l.classList.add("trio");const d=window.game.cardLevels[c]||0;d>0&&l.classList.add("upgraded");let h=r.desc;if(r.eff==="variation"){const u=50+10*d;h=h.replace("50%",`${u}%`)}if(r.eff==="polyphony"){const u=2+Math.floor(d/2);h=h.replace("{draw}",`<span class="highlight-val">${u}</span>`)}if(r.eff==="upbeat"){const u=1+Math.floor(d/2);h=h.replace("{mana}",`<span class="highlight-val">${u}</span>`)}if(r.eff==="breath"){const u=2+d;h=h.replace("{mana}",`<span class="highlight-val">${u}</span>`)}if(r.eff==="weaken"){const u=2+d;h=h.replace("{str}",`<span class="highlight-val">${u}</span>`)}let m=r.val;if(m!==void 0){d>0&&m>0&&(m=Math.ceil(m*(1+.5*d)));const u=r.type==="duo"||r.type==="trio"?"#4dabf7":"#2ecc71";h=h.replace("{val}",`<span class="highlight-val" style="color:${u}">${m}</span>`)}const p=d>0?` +${d}`:"";l.innerHTML=`
                <div class="card-cost">${r.cost}</div>
                <img src="${r.img}" class="card-art" onerror="this.src=''">
                <div class="card-text">
                    <div class="card-name">${r.name}${p}</div>
                    <div class="card-desc"><span>${h}</span></div>
                </div>
            `,t&&(l.style.cursor="pointer",l.style.border="2px dashed #e74c3c",l.onmouseover=()=>l.style.borderColor="#f0c040",l.onmouseout=()=>l.style.border="2px dashed #e74c3c",l.onclick=()=>t(c,i.originalIdx)),o.appendChild(l)})},closeDeckModal(){document.getElementById("modal-overlay").classList.remove("active")},update(){const e=document.getElementById("map-gold");e&&(e.innerText=window.game.gold);const s=document.getElementById("battle-gold");s&&(s.innerText=window.game.gold);const t=document.getElementById("shop-gold");t&&(t.innerText=window.game.gold);const n=document.getElementById("mana-ui");if(n){n.innerHTML="";for(let l=0;l<window.battle.manaData.max;l++){const d=document.createElement("div");d.className="mana-dot"+(l<window.battle.manaData.current?"":" empty"),n.appendChild(d)}}const o=document.getElementById("draw-ui");o&&(o.innerHTML=`<img src="assets/UI/draw.png" class="ui-icon" style="width:32px;height:32px;" onerror="this.style.display='none'"> æ‰‹ç‰Œ: ${window.battle.manaData.draw}`);const a=document.getElementById("level-ui");a&&(a.innerText=window.game.level);const i=document.getElementById("map-level-num");i&&(i.innerText=window.game.level);const c=document.getElementById("relic-bar");if(c&&(c.innerHTML="",window.game.relics.forEach(l=>{const d=document.createElement("div");d.className="relic",d.innerText=window.RELICS[l].icon,d.setAttribute("data-desc",`${window.RELICS[l].name}: ${window.RELICS[l].desc}`),c.appendChild(d)})),window.battle.allies.forEach(l=>{const d=document.getElementById(`char-${l.role}`);if(d){l.dead?d.classList.add("dead"):d.classList.remove("dead");const h=document.getElementById(`hp-text-${l.role}`);h&&(h.innerText=`${l.hp}`);const m=document.getElementById(`block-${l.role}`),p=document.getElementById(`block-val-${l.role}`);m&&p&&(l.block>0?(m.style.display="flex",p.innerText=l.block):m.style.display="none")}}),window.battle.enemy&&window.battle.enemy.maxHp){const l=window.battle.enemy.hp/window.battle.enemy.maxHp*100,d=document.getElementById("e-hp-bar");d&&(d.style.width=l+"%");const h=document.getElementById("e-hp-text");h&&(h.innerText=`${window.battle.enemy.hp}/${window.battle.enemy.maxHp}`);const m=document.getElementById("e-name");m&&(m.innerText=window.battle.enemy.name);const p=document.getElementById("sprite-enemy");p&&(p.classList.contains("anim-knight-attack")||p.classList.contains("anim-dancer-attack")||p.classList.contains("anim-demon-cast")?p.style.backgroundImage="":p.style.backgroundImage=`url('${window.battle.enemy.sprite}')`);const u=document.getElementById("e-intent");if(u)if(window.battle.enemy.stunned)u.innerHTML='<span class="intent-icon">â„ï¸</span> æ— æ³•è¡ŒåŠ¨',p&&p.classList.add("frozen-effect");else{const v=window.battle.enemy.intent.icon||"assets/UI/attack.png";let g=window.battle.enemy.intent.val>0?window.battle.enemy.intent.val:"";const M=["atk","atk_heavy","atk_vuln"];let b=!1;if(M.includes(window.battle.enemy.intent.type)&&g!==""){const U=window.battle.enemy.buffs.str||0;U>0&&(b=!0),g=parseInt(g)+U}const y=b?`<span style="color:#e74c3c; font-weight:bold; text-shadow:0 0 5px rgba(231,76,60,0.5);">${g}</span>`:g;u.innerHTML=`<img src="${v}" class="intent-icon-img" onerror="this.src='assets/UI/attack.png'"> ${y}`,p&&p.classList.remove("frozen-effect")}const f=document.getElementById("e-status");f&&(f.innerHTML="",window.battle.enemy.block>0&&(f.innerHTML+=`<div style="display:flex;align-items:center;background:rgba(0,0,0,0.8);border-radius:4px;padding:4px 8px;margin-right:5px;"><img src="assets/UI/block.png" class="ui-icon" style="width:28px;height:28px;" onerror="this.style.display='none'"> <span style="font-weight:bold;margin-left:6px;color:#3498db;font-size:1.2em;">${window.battle.enemy.block}</span></div>`),window.battle.enemy.buffs.vuln>0&&(f.innerHTML+=`<div style="display:flex;align-items:center;background:rgba(0,0,0,0.8);border-radius:4px;padding:4px 8px;margin-right:5px;"><img src="assets/UI/Vulnerable.png" class="ui-icon" style="width:28px;height:28px;" onerror="this.style.display='none'"> <span style="font-weight:bold;margin-left:6px;color:#e67e22;font-size:1.2em;">${window.battle.enemy.buffs.vuln}</span></div>`),window.battle.enemy.buffs.res>0&&(f.innerHTML+=`<div class="status-icon" style="background:#9b59b6">å…±é¸£ ${window.battle.enemy.buffs.res}</div>`),window.battle.enemy.buffs.str>0&&(f.innerHTML+=`<div class="status-icon" style="background:#e74c3c">åŠ›é‡ ${window.battle.enemy.buffs.str}</div>`))}const r=document.getElementById("hand");if(r){r.innerHTML="";const l=document.getElementById("btn-cancel");l&&(l.style.display=window.battle.selectedCard===-1?"none":"block"),window.battle.hand.forEach((d,h)=>{const m=window.CARDS[d];if(!m)return;const p=window.battle.isCardPlayable(m),u=document.createElement("div"),f=window.game.cardLevels[d]||0;if(u.className="card"+(h===window.battle.selectedCard?" selected":"")+(m.type==="duo"?" duet":"")+(m.type==="trio"?" trio":"")+(p?"":" disabled")+(f>0?" upgraded":""),h!==window.battle.selectedCard&&p){const y=(h-(window.battle.hand.length-1)/2)*5;u.style.transform=`rotate(${y}deg) translateY(${Math.abs(y)*2}px)`}let v=m.val,g=m.desc;if(m.eff==="variation"){const y=50+10*f;g=g.replace("50%",`${y}%`)}if(m.eff==="polyphony"){const y=2+Math.floor(f/2);g=g.replace("{draw}",`<span class="highlight-val">${y}</span>`)}if(m.eff==="upbeat"){const y=1+Math.floor(f/2);g=g.replace("{mana}",`<span class="highlight-val">${y}</span>`)}if(m.eff==="breath"){const y=2+f;g=g.replace("{mana}",`<span class="highlight-val">${y}</span>`)}if(m.eff==="weaken"){const y=2+f;g=g.replace("{str}",`<span class="highlight-val">${y}</span>`)}v!==void 0&&(f>0&&v>0&&(v=Math.ceil(v*(1+.5*f))),g=g.replace("{val}",`<span class="highlight-val">${v}</span>`));const M=f>0?` +${f}`:"",b=window.battle.getCardCost?window.battle.getCardCost(d):m.cost;u.innerHTML=`
                    <div class="card-cost">${b}</div>
                    <img src="${m.img}" class="card-art" onerror="this.src=''">
                    <div class="card-text">
                        <div class="card-name">${m.name}${M}</div>
                        <div class="card-desc"><span>${g}</span></div>
                    </div>
                `,u.onclick=y=>{y.stopPropagation(),p&&window.battle.selectCard(h)},r.appendChild(u)})}},toast(e){const s=document.createElement("div");s.className="toast",s.innerText=e,document.getElementById("game-window").appendChild(s),setTimeout(()=>s.remove(),1e3)},floatText(e,s,t){const n=document.createElement("div");n.className="float-text",n.innerText=e,n.style.color=t;const o=document.getElementById(s);if(!o)return;const a=o.getBoundingClientRect(),i=document.getElementById("game-window").getBoundingClientRect(),c=(Math.random()-.5)*20;n.style.left=a.left-i.left+a.width/2-20+c+"px",n.style.top=a.top-i.top+"px",document.getElementById("game-window").appendChild(n),setTimeout(()=>n.remove(),1e3)},spawnVFX(e,s){const t=document.getElementById(s);if(!t)return;const n=t.getBoundingClientRect(),o=document.getElementById("game-window").getBoundingClientRect(),a=document.createElement("img");a.src=`assets/vfx/vfx_${e}.png`,a.className=`vfx-particle vfx-${e}`;const i=n.left-o.left+n.width/2,c=n.top-o.top+n.height/2,r=(Math.random()-.5)*40,l=(Math.random()-.5)*40;a.style.left=i+r+"px",a.style.top=c+l+"px",a.style.filter=`hue-rotate(${Math.random()*20}deg)`,document.getElementById("game-window").appendChild(a),setTimeout(()=>a.remove(),500)},shake(){const e=document.getElementById("game-window");e&&(e.classList.remove("shake"),e.offsetWidth,e.classList.add("shake"))},playSound(e){const s=new Audio(e);s.volume=.6,s.play().catch(t=>console.warn("Audio error:",t))},playBGM(e){this.currentBGM&&this.currentBGM.src.endsWith(encodeURI(e))||(this.currentBGM&&this.currentBGM.pause(),this.currentBGM=new Audio(e),this.currentBGM.loop=!0,this.currentBGM.volume=.5,this.currentBGM.play().catch(s=>console.warn("BGM error:",s)))},stopBGM(){this.currentBGM&&(this.currentBGM.pause(),this.currentBGM=null)},log(e,s=""){const t=document.getElementById("battle-log");if(!t)return;const n=document.createElement("div");n.innerHTML=e,n.className=`log-line log-${s}`,t.appendChild(n),t.scrollTop=t.scrollHeight},clearLog(){const e=document.getElementById("battle-log");e&&(e.innerHTML="")}};window.TacticManager={selectedIdx:-1,handleClick(e){window.battle.phase==="PREPARE"&&(this.selectedIdx===-1?(this.selectedIdx=e,window.UI.highlightUnit(e,!0)):this.selectedIdx===e?(window.UI.highlightUnit(e,!1),this.selectedIdx=-1):(this.swap(this.selectedIdx,e),window.UI.highlightUnit(this.selectedIdx,!1),this.selectedIdx=-1))},swap(e,s){const t=window.battle.allies[e];window.battle.allies[e]=window.battle.allies[s],window.battle.allies[s]=t,window.UI.renderBattleField()}};window.battle={allies:[],playerDeck:[],hand:[],discard:[],manaData:{current:3,max:3,draw:5},enemy:{},tm:new window.TimerManager,phase:"IDLE",selectedCard:-1,attacksPlayed:0,turnCount:0,variationBonus:0,crescendoStacks:0,manaSpentTurn:0,firstCardPlayed:!1,tempStrDebuff:0,lastCardType:null,bachCounter:0,mozartTriggered:!1,reset(){this.tm.clearAll(),window.UI.clearLog(),this.phase="IDLE",this.playerDeck=this.playerDeck.concat(this.hand,this.discard),this.hand=[],this.discard=[],this.playerDeck.sort(()=>Math.random()-.5),this.allies.forEach(e=>e.block=0),this.turnCount=0,this.variationBonus=0,this.crescendoStacks=0,this.manaSpentTurn=0,this.firstCardPlayed=!1,this.tempStrDebuff=0,this.lastCardType=null,this.bachCounter=0,this.mozartTriggered=!1},getFrontAlly(){for(let e=this.allies.length-1;e>=0;e--)if(!this.allies[e].dead)return this.allies[e];return null},getCardCost(e){const s=window.CARDS[e];if(!s)return 0;let t=s.cost;return!this.firstCardPlayed&&window.game.partyRoles.includes("flutist")?0:(!this.firstCardPlayed&&s.type==="atk"&&window.game.relics.includes("paganini_string")&&(t=Math.max(0,t-1)),(s.type==="duo"||s.type==="trio")&&window.game.partyRoles.includes("conductor")&&(t=Math.max(0,t-1)),t)},isCardPlayable(e){if(e.type==="duo"||e.type==="trio")return e.req.every(s=>{const t=this.allies.find(n=>n.role===s);return t&&!t.dead});if(e.owner&&e.owner!=="common"){const s=this.allies.find(t=>t.role===e.owner);return s&&!s.dead}return!0},startActualBattle(){document.getElementById("prep-ui").style.display="none",document.getElementById("hand").style.display="flex",document.getElementById("btn-end").style.display="block",document.getElementById("party-container").classList.remove("interactive"),window.TacticManager.selectedIdx=-1,window.UI.renderBattleField(),this.startTurn()},startTurn(){this.phase="PLAYER",this.turnCount++,this.attacksPlayed=0,this.manaSpentTurn=0,this.firstCardPlayed=!1,this.turnCount>1&&this.allies.forEach(e=>{let s=window.game.relics.includes("tuning_fork")?10:0;e.retainBlock&&(s=e.block,e.retainBlock=!1),e.block=Math.max(0,Math.floor(e.block/2),Math.min(e.block,s))}),window.UI.log(`=== ç¬¬ ${this.turnCount} å›åˆ ===`,"turn"),this.manaData.current=this.manaData.max,this.turnCount===1&&window.game.relics.includes("baton")&&(this.manaData.current+=1,window.UI.toast("æŒ‡æŒ¥æ£’: çµæ„Ÿ+1")),document.getElementById("btn-end").disabled=!1,this.drawCards(this.manaData.draw),window.UI.update()},drawCards(e){const s=[];for(let t=0;t<e;t++){if(!this.playerDeck.length){if(!this.discard.length)break;this.playerDeck=this.discard.sort(()=>Math.random()-.5),this.discard=[]}const n=this.playerDeck.pop();this.hand.push(n),s.push(n)}return s},selectCard(e){if(this.phase!=="PLAYER")return;const s=this.hand[e],t=window.CARDS[s];if(!this.isCardPlayable(t)){window.UI.toast("è§’è‰²å·²é˜µäº¡!");return}const n=this.getCardCost(s);if(this.manaData.current<n){window.UI.toast("çµæ„Ÿä¸è¶³");return}t.type==="atk"||t.type==="debuff"||t.eff==="boom"||t.eff==="bash"?this.selectedCard===e?this.deselect():(this.selectedCard=e,window.UI.update()):this.playCard(e)},targetEnemy(){this.selectedCard!==-1&&this.playCard(this.selectedCard)},playCard(e){const s=this.hand[e],t=window.CARDS[s],n=this.getCardCost(s);!this.firstCardPlayed&&window.game.partyRoles.includes("flutist")&&t.cost>0&&window.UI.floatText("çµé£ï¼š0è´¹å‡ºç‰Œ","hand","#4dabf7"),this.manaData.current-=n,this.manaSpentTurn+=n,this.firstCardPlayed=!0;let o=0;t.eff==="hand_scale"&&(o=this.hand.length*3),this.hand.splice(e,1),this.discard.push(s),this.deselect(),window.UI.log(`æ‰“å‡º: <b>${t.name}</b>`,"card"),t.eff==="stun"&&window.UI.playSound("assets/ç‰¹å¤§é¼“é‡å‡».mp3"),t.eff==="catastrophe"&&window.UI.playSound("assets/å·¨å¤§è½°é¸£çˆ†ç‚¸.mp3"),(t.name==="ä¼‘æ­¢ç¬¦"||t.name==="èµ·æ‹")&&window.UI.playSound("assets/BGM/accordion-attack.wav"),(t.name==="å˜å¥"||t.name==="æ‹¨å¥")&&window.UI.playSound("assets/BGM/unsheathed-blade.ogg"),(t.name==="æ€¥æ¿"||t.name==="è¿å¼“")&&window.UI.playSound("assets/BGM/sword-01.wav"),(t.name==="éœ‡è¡å·è§’"||t.name==="é«˜çˆ†éŸ³ç¬¦")&&window.UI.playSound("assets/BGM/shipboard_railgun.mp3"),(t.name==="çƒ­æƒ…"||t.name==="å°¾å£°")&&window.UI.playSound("assets/BGM/horror-piano-chord.mp3"),t.name==="ä¸åå’Œ"&&window.UI.playSound("assets/BGM/violin-scare.wav"),(t.name==="ä½åŸ"||t.name==="é‡å¥"||t.name==="ç´å¼¦å£å’")&&window.UI.playSound("assets/BGM/piano-string-glissando-low-a.wav");let a=1;t.tag==="atk"&&window.game.relics.includes("metronome")&&this.attacksPlayed===0&&(a=2,window.UI.toast("èŠ‚æ‹å™¨: åŒé‡å¥!")),t.tag==="atk"&&(this.attacksPlayed++,window.game.relics.includes("rosin")&&(this.enemy.buffs.vuln+=1));let i=this.allies.find(d=>d.role===t.owner);if(i||(i=this.getFrontAlly()),i){const d=document.getElementById(`char-${i.role}`);if(d){const h=d.querySelector(".musician-sprite");if(h){let m=null,p=0;t.owner===i.role&&(i.role==="brass"&&t.type==="atk"?(m="anim-brass-atk",p=800):i.role==="cellist"&&(m="anim-cellist-buff",p=1200)),!m&&t.type==="atk"&&(m="anim-generic-atk",p=300),m&&(h.classList.remove("anim-brass-atk","anim-generic-atk","anim-cellist-buff"),h.offsetWidth,h.classList.add(m),setTimeout(()=>{h.classList.remove(m)},p))}}}const c=window.game.cardLevels[s]||0;let r=1+.5*c;this.variationBonus>0&&(r+=this.variationBonus,window.UI.floatText(`å˜å¥ +${Math.round(this.variationBonus*100)}%!`,`char-${i.role}`,"#f0c040"),this.variationBonus=0);let l=t.val;window.game.relics.includes("beethoven_ear")&&i.hp<i.maxHp*.3&&t.type==="atk"&&(l*=2,window.UI.floatText("å‘½è¿å’†å“®!",`char-${i.role}`,"#e74c3c")),t.eff==="crescendo"&&(l+=this.crescendoStacks),t.cost>=2&&window.game.partyRoles.includes("brass")&&t.type==="atk"&&(l+=5),t.type==="atk"&&window.game.partyRoles.includes("percussionist")&&(l+=2),l>0&&(l=Math.ceil(l*r));for(let d=0;d<a;d++)setTimeout(()=>{this.executeCardEffect(t,i,l,r,o)},d*300);if(t.eff==="draw"&&this.drawCards(1),t.eff==="mana"&&this.manaData.current++,t.type==="atk"&&this.crescendoStacks++,t.eff==="variation"&&(this.variationBonus=.5+.1*c,window.UI.toast(`ä¸‹ä¸€å¼ ç‰Œæ•ˆæœ +${Math.round(this.variationBonus*100)}%`)),t.eff==="polyphony"){let d=2+Math.floor(c/2);this.drawCards(d).some(p=>CARDS[p].type!=="atk")&&(this.manaData.current++,window.UI.floatText("+1 çµæ„Ÿ",`char-${i.role}`,"#4dabf7"))}if(t.eff==="screech"&&(this.enemy.buffs.res+=1,window.UI.floatText("å…±é¸£+1","sprite-enemy","#9b59b6"),window.UI.log("[Buff] æ•Œäººå…±é¸£ +1","buff")),t.eff==="upbeat"){let d=1+Math.floor(c/2);if(this.manaData.current+=d,window.UI.floatText(`+${d} çµæ„Ÿ`,`char-${i.role}`,"#4dabf7"),window.UI.spawnVFX("conductor",`char-${i.role}`),this.drawCards(1),c>0){let h=this.getFrontAlly();h&&(h.block+=4,window.UI.floatText("æŠ¤ç›¾+4",`char-${h.role}`,"#3498db"),window.UI.log(`[æŠ¤ç›¾] ${h.name} è·å¾— 4 æŠ¤ç›¾`,"block"),window.UI.playSound("assets/BGM/shield.wav"))}}if(t.eff==="weaken"){const d=2+c;this.enemy.buffs.str-=d,this.tempStrDebuff+=d,window.UI.floatText(`åŠ›é‡ -${d}`,"sprite-enemy","#bdc3c7"),window.UI.log(`[Debuff] æ•ŒäººåŠ›é‡æœ¬å›åˆ -${d}`,"debuff")}if(t.eff==="tutti"&&this.addBlockAll(8*r),t.eff==="breath"){let d=2+c;this.manaData.current+=d,window.UI.floatText(`+${d} çµæ„Ÿ`,`char-${i.role}`,"#4dabf7"),window.UI.spawnVFX("conductor",`char-${i.role}`),c>0&&(this.drawCards(1),window.UI.floatText("é¢å¤–æŠ½ç‰Œ",`char-${i.role}`,"#2ecc71"))}t.eff==="stun"&&(this.enemy.stunned=!0,window.UI.toast("æ•Œäººè¢«å‡»æ™•!"),window.UI.spawnVFX("Heavy_Rending","sprite-enemy"),window.UI.log("[æ§åˆ¶] æ•Œäººè¢«å‡»æ™•","debuff")),this.attacksPlayed===1&&window.game.relics.includes("paganini_string")&&t.type==="atk"&&(i.hp-=2,window.UI.floatText("-2",`char-${i.role}`,"#888"),i.hp<=0&&(i.hp=0,i.dead=!0)),window.game.relics.includes("bach_lens")&&(this.lastCardType===t.type?(this.bachCounter++,this.bachCounter>=3&&(this.drawCards(1),this.manaData.current++,window.UI.toast("èµ‹æ ¼é€é•œ: å®Œç¾å¯¹ä½!"),this.bachCounter=0)):(this.lastCardType=t.type,this.bachCounter=1)),window.UI.update()},executeCardEffect(e,s,t,n,o=0){if(e.type==="duo"||e.type==="trio")e.act(this,n);else{let a=t;if(o>0&&(a+=o),e.vfx)if(e.type==="def"){let i=this.getFrontAlly();i&&window.UI.spawnVFX(e.vfx,`char-${i.role}`)}else e.type==="buff"?window.UI.spawnVFX(e.vfx,`char-${s.role}`):window.UI.spawnVFX(e.vfx,"sprite-enemy");if(e.type==="def"){let i=this.getFrontAlly();i&&(i.block+=a,window.UI.log(`[æŠ¤ç›¾] ${i.name} è·å¾— ${a} æŠ¤ç›¾`,"block"),window.UI.playSound("assets/BGM/shield.wav"),window.UI.floatText(`æŠ¤ç›¾+${a}`,`char-${i.role}`,"#3498db"))}else if(e.type==="buff")this.enemy.buffs.res+=a,window.UI.log(`[Buff] æ•Œäººè·å¾— ${a} å±‚å…±é¸£`,"buff");else if(e.eff==="bash"){let i=s.block;i=Math.ceil(i*n),this.dmgEnemy(i,e.pierce),window.UI.shake()}else if(e.eff==="boom"){let i=e.val;i=Math.ceil(i*n);let c=this.enemy.buffs.res*i;this.dmgEnemy(c,e.pierce),this.enemy.buffs.res=0,window.UI.log(`[å¼•çˆ†] æ¶ˆè€—å…±é¸£é€ æˆ ${c} ä¼¤å®³`,"dmg"),window.UI.shake()}else if(e.type==="atk"||e.type==="debuff"){let i=e.hits||1;e.eff==="double_stop"&&(i=3+((this.enemy.buffs.vuln>0?1:0)+(this.enemy.stunned?1:0))),i>1&&window.game.relics.includes("liszt_bullet")&&(i+=1),e.eff==="flutter"&&(i=Math.max(1,this.manaSpentTurn));for(let c=0;c<i;c++)this.tm.add(()=>{this.dmgEnemy(a,e.pierce),e.eff==="flutter"?window.UI.spawnVFX("Multi-Thrust","sprite-enemy"):e.vfx==="slash"&&window.UI.spawnVFX("slash","sprite-enemy"),c===i-1&&setTimeout(()=>{e.eff==="vuln2"?(this.enemy.buffs.vuln+=2,window.UI.log("[Debuff] æ•Œäººè¢«æ–½åŠ  2 å±‚æ˜“ä¼¤","debuff"),window.UI.floatText("æ˜“ä¼¤+2","sprite-enemy","#e67e22")):e.type==="debuff"&&(this.enemy.buffs.vuln+=1,window.UI.log("[Debuff] æ•Œäººè¢«æ–½åŠ  1 å±‚æ˜“ä¼¤","debuff"),window.UI.floatText("æ˜“ä¼¤+1","sprite-enemy","#e67e22")),window.UI.update()},350)},c*150)}}window.UI.update()},dmgEnemy(e,s=!1){if(this.phase==="VICTORY")return;this.enemy.buffs.vuln>0&&(e=Math.floor(e*1.5));let t=e;if(!s&&this.enemy.block>0){let n=Math.min(this.enemy.block,t);this.enemy.block-=n,t-=n,n>0&&window.UI.floatText("æ ¼æŒ¡","sprite-enemy","#3498db")}this.enemy.hp=Math.max(0,this.enemy.hp-t),t>0&&(window.UI.floatText(`-${t}`,"sprite-enemy","#ff6b6b"),window.UI.log(`é€ æˆ ${t} ä¼¤å®³`,"dmg")),t>10&&window.UI.shake(),window.UI.update(),this.enemy.hp<=0&&this.win()},healAll(e){this.allies.forEach(s=>{s.dead||(s.hp=Math.min(s.maxHp,s.hp+e),window.UI.floatText(`+${e}`,`char-${s.role}`,"#2ecc71"))}),window.UI.log(`[æ²»ç–—] å…¨å‘˜æ¢å¤ ${e} HP`,"heal"),window.UI.update()},healPlayer(e){let s=this.allies.filter(t=>!t.dead).sort((t,n)=>t.hp/t.maxHp-n.hp/n.maxHp)[0];s&&(s.hp=Math.min(s.maxHp,s.hp+e),window.UI.floatText(`+${e}`,`char-${s.role}`,"#2ecc71"),window.UI.log(`[æ²»ç–—] ${s.name} æ¢å¤ ${e} HP`,"heal")),window.UI.update()},addBlockAll(e){this.allies.forEach(s=>{s.dead||(s.block+=e)}),window.UI.log(`[æŠ¤ç›¾] å…¨å‘˜è·å¾— ${e} æŠ¤ç›¾`,"block"),window.UI.playSound("assets/BGM/shield.wav"),window.UI.update()},win(){this.phase="VICTORY",this.tm.clearAll(),window.UI.stopBGM(),window.UI.playSound("assets/BGM/victory.wav"),this.playerDeck=this.playerDeck.concat(this.hand,this.discard),this.hand=[],this.discard=[];let e=20+Math.floor(Math.random()*10);this.enemy.type==="elite"&&(e=50+Math.floor(Math.random()*15)),this.enemy.type==="boss"&&(e=100),window.game.gold+=e,this.enemy.type==="boss"&&(window.game.mapGraph=[]),window.game.level%5===0&&window.UI.toast("BOSS å‡»ç ´! å®Œç¾æ¼”å‡º!"),setTimeout(()=>{this.enemy.type==="battle"?(window.UI.switchScene("scene-reward"),window.UI.renderUpgradeRewards(e)):(window.UI.toast(`è·å¾—é‡‘å¸: ${e}`),(this.enemy.type==="elite"||this.enemy.type==="boss")&&window.game.campAction("relic"))},1e3)},endTurn(){this.phase="ENEMY_TURN",document.getElementById("btn-end").disabled=!0,this.discard.push(...this.hand),this.hand=[],window.UI.update(),this.tm.add(()=>this.enemyAction(),800)},enemyAction(){if(this.phase==="VICTORY")return;let e=400;if(this.enemy.block=0,window.game.partyRoles.includes("vocalist")&&this.healAll(5),this.enemy.stunned)window.UI.toast("æ•Œäººè¢«å†°å†»!"),this.enemy.stunned=!1,window.UI.update();else{let s=this.enemy.intent.type,t=this.enemy.intent.val;if(s==="atk"||s==="atk_heavy"||s==="atk_vuln"){const n=document.getElementById("sprite-enemy"),o=this.enemy.name==="å¤±å¾‹å«å£«",a=this.enemy.name==="å¤±è¡¡èˆè€…",i=this.enemy.name==="å¯‚é™æŒ‡æŒ¥å®¶",c=this.enemy.name==="æ¶æ„å…«éŸ³ç›’",r=this.enemy.name==="æ‚éŸ³å”±è¯—ç­",l=this.enemy.name==="æ‚éŸ³å¾®ç²’";if(n){let m="anim-enemy-atk";if(o&&(m="anim-knight-attack"),a&&(m="anim-dancer-attack"),i&&(m="anim-demon-cast"),c&&(m="anim-bayinhe-attack"),r&&(m="anim-choir-attack"),l&&(m="anim-slime-atk"),o||a||c||l){const p=this.getFrontAlly(),u=p?document.getElementById(`char-${p.role}`):null;if(u){const f=n.getBoundingClientRect(),g=u.getBoundingClientRect().left-f.left+60;n.style.setProperty("--attack-dist",`${g}px`)}}n.classList.remove("anim-knight-attack","anim-dancer-attack","anim-demon-cast","anim-bayinhe-attack","anim-choir-attack","anim-enemy-atk","anim-slime-atk"),n.offsetWidth,n.classList.add(m),o&&window.UI.playSound("assets/BGM/monster.wav")}let d=300;o&&(d=710),a&&(d=450),i&&(d=750),c&&(d=750),r&&(d=480),l&&(d=600),setTimeout(()=>{let m=parseInt(t),p=parseInt(this.enemy.buffs.str||0),u=m+p;console.log(`[Damage Debug] Turn: ${this.turnCount}, Enemy: ${this.enemy.name}, Base: ${m}, Str: ${p}, Final: ${u}`);let f=this.getFrontAlly();if(f){this.enemy.name==="æ‚éŸ³å”±è¯—ç­"&&(window.UI.spawnVFX("Psychic_Shriek","sprite-enemy"),window.UI.playSound("assets/BGM/attack-cannibal-beast.wav")),this.enemy.name==="æ‚éŸ³å¾®ç²’"&&(window.UI.spawnVFX("heavy_hit",`char-${f.role}`),window.UI.playSound("assets/BGM/shadowboss_attack.wav")),o&&(window.UI.spawnVFX("Heavy_Rending",`char-${f.role}`),window.UI.spawnVFX("Blood_Splatter",`char-${f.role}`)),a&&(window.UI.spawnVFX("Sharp_Slash",`char-${f.role}`),window.UI.spawnVFX("Blood_Splatter",`char-${f.role}`)),i&&(window.UI.spawnVFX("Boss_wave",`char-${f.role}`),window.UI.playSound("assets/BGM/nastyattack.wav")),c&&(window.UI.spawnVFX("Heavy_Rending",`char-${f.role}`),window.UI.spawnVFX("Blood_Splatter",`char-${f.role}`));const v=document.getElementById(`char-${f.role}`);if(v&&(v.classList.remove("anim-ally-hit"),v.offsetWidth,v.classList.add("anim-ally-hit")),f.block>0){let g=Math.min(f.block,u);f.block-=g,u-=g}u>0?(u=Math.floor(u),f.hp=Math.floor(f.hp-u),window.UI.floatText(`-${u}`,`char-${f.role}`,"#cc0000"),window.UI.log(`${this.enemy.name} æ”»å‡» ${f.name} é€ æˆ ${u} ä¼¤å®³`,"enemy"),window.UI.shake(),f.hp<=0&&(f.hp=0,f.dead=!0,f.block=0,window.UI.toast(`${f.name} å€’ä¸‹äº†!`),window.UI.log(`${f.name} é˜µäº¡`,"enemy"),window.game.relics.includes("mozart_quill")&&!this.mozartTriggered&&(this.dmgEnemy(30,!0),window.UI.toast("å®‰é­‚æ›²: ç»å”±!"),window.UI.spawnVFX("Psychic_Shriek","sprite-enemy"),this.mozartTriggered=!0))):(window.UI.floatText("æ ¼æŒ¡!",`char-${f.role}`,"#3498db"),window.UI.log(`${f.name} æ ¼æŒ¡äº†æ”»å‡»`,"block")),s==="atk_vuln"&&window.UI.floatText("å‹åˆ¶!",`char-${f.role}`,"#e67e22")}window.UI.update()},d);let h=600;o&&(h=1200),a&&(h=1e3),i&&(h=1500),c&&(h=1500),r&&(h=1200),l&&(h=1200),setTimeout(()=>{n&&(n.style.backgroundImage=`url('${this.enemy.sprite}')`,n.classList.remove("anim-knight-attack","anim-dancer-attack","anim-demon-cast","anim-bayinhe-attack","anim-choir-attack","anim-enemy-atk","anim-slime-atk"),window.UI.update())},h),e=Math.max(e,i||c?1600:r||o||l?1300:800)}else{if(s==="def"){let n=Math.floor(this.enemy.maxHp*.1);if(this.enemy.block+=n,window.UI.floatText(`æŠ¤ç›¾+${n}`,"sprite-enemy","#3498db"),this.enemy.name==="å¤±å¾‹å«å£«"){const o=document.getElementById("sprite-enemy");o&&(o.classList.remove("anim-knight-defend"),o.offsetWidth,o.classList.add("anim-knight-defend"),window.UI.playSound("assets/BGM/shield.wav"),setTimeout(()=>o.classList.remove("anim-knight-defend"),1200)),e=1300}}else if(s==="def_block"){let n=Math.floor(this.enemy.maxHp*.25);this.enemy.block+=n,window.UI.floatText(`å¼ºåŠ›æŠ¤ç›¾+${n}`,"sprite-enemy","#3498db")}else if(s==="buff"){if(this.enemy.buffs.str+=2,window.UI.floatText("åŠ›é‡UP!","sprite-enemy","#e74c3c"),this.enemy.name==="å¯‚é™æŒ‡æŒ¥å®¶"){const n=document.getElementById("sprite-enemy");n&&(n.classList.remove("anim-demon-buff"),n.offsetWidth,n.classList.add("anim-demon-buff"),window.UI.playSound("assets/BGM/piano-string-glissando-low-a.wav"),setTimeout(()=>n.classList.remove("anim-demon-buff"),1500)),e=1600}}else if(s==="buff_str"){if(this.enemy.buffs.str+=3,window.UI.floatText("è“„åŠ›!","sprite-enemy","#e74c3c"),this.enemy.name==="æ¶æ„å…«éŸ³ç›’"){const n=document.getElementById("sprite-enemy");n&&(n.classList.remove("anim-bayinhe-buff"),n.offsetWidth,n.classList.add("anim-bayinhe-buff"),window.UI.playSound("assets/BGM/monster.wav"),setTimeout(()=>n.classList.remove("anim-bayinhe-buff"),1200)),e=1300}}else if(s==="debuff"&&(this.enemy.buffs.vuln=0,window.UI.floatText("å‡€åŒ–","sprite-enemy","#fff"),this.enemy.name==="å¯‚é™æŒ‡æŒ¥å®¶")){const n=document.getElementById("sprite-enemy");n&&(n.classList.remove("anim-demon-buff"),n.offsetWidth,n.classList.add("anim-demon-buff"),window.UI.playSound("assets/BGM/piano-string-glissando-low-a.wav"),setTimeout(()=>n.classList.remove("anim-demon-buff"),1500)),e=1600}window.UI.update()}}this.enemy.buffs.vuln>0&&this.enemy.buffs.vuln--,this.tempStrDebuff>0&&(this.enemy.buffs.str+=this.tempStrDebuff,window.UI.floatText("åŠ›é‡æ¢å¤","sprite-enemy","#e74c3c"),this.tempStrDebuff=0),setTimeout(()=>{window.UI.update(),this.planEnemy(),this.tm.add(()=>this.startTurn(),800)},e)},planEnemy(){let e=5+Math.floor(window.game.level*1.5),t=[...window.battle.enemy.acts||["atk"]];this.enemy.name==="å¯‚é™æŒ‡æŒ¥å®¶"&&(this.enemy.buffs.vuln>0||(t=t.filter(a=>a!=="debuff"))),this.enemy.name==="æ¶æ„å…«éŸ³ç›’"&&(this.enemy.buffs.str||0)>=6&&(t=t.filter(a=>a!=="buff_str")),t.length===0&&(t=["atk"]);const n=t[Math.floor(Math.random()*t.length)];n==="atk"?this.enemy.intent={type:"atk",val:e,icon:"assets/UI/attack.png"}:n==="def"?this.enemy.intent={type:"def",val:0,icon:"assets/UI/Defend.png"}:n==="buff"?this.enemy.intent={type:"buff",val:0,icon:"assets/UI/Mana.png"}:n==="debuff"?this.enemy.intent={type:"debuff",val:0,icon:"assets/UI/Debuff.png"}:n==="atk_heavy"?this.enemy.intent={type:"atk_heavy",val:Math.floor(e*1.5),icon:"assets/UI/attack.png"}:n==="atk_vuln"?this.enemy.intent={type:"atk_vuln",val:Math.floor(e*.8),icon:"assets/UI/Debuff.png"}:n==="buff_str"?this.enemy.intent={type:"buff_str",val:0,icon:"assets/UI/Mana.png"}:n==="def_block"&&(this.enemy.intent={type:"def_block",val:0,icon:"assets/UI/Defend.png"})},deselect(){this.selectedCard=-1,window.UI.update()}};window.game={partyRoles:[],level:1,relics:[],cardLevels:{},start(){window.UI.switchScene("scene-select"),window.UI.renderCharSelect("grid-start",e=>this.initParty(e)),window.UI.playBGM("assets/BGM/Ravel_Gaspard de la Nuit.mp3")},initParty(e,s=!0){this.partyRoles=[e],this.level=1,this.gold=100,this.relics=[],this.cardLevels={},this.mapGraph=[],this.currentMapPos={layer:-1,index:-1};const t=window.ROLES[e];window.battle.manaData={current:3,max:3,draw:5},e==="pianist"&&(window.battle.manaData.max=4),e==="violinist"&&(window.battle.manaData.draw+=1),window.battle.allies=[this.createAlly(e)];const n=[...window.COMMON_DECK,...t.deck];window.battle.playerDeck=[...n],s&&this.mapSelect()},createAlly(e){const s=window.ROLES[e];return{role:e,name:s.name,hp:s.hp,maxHp:s.hp,block:0,dead:!1}},mapSelect(){window.UI.playBGM("assets/BGM/Ravel_Gaspard de la Nuit.mp3"),window.UI.switchScene("scene-map"),window.UI.update();const e=document.getElementById("map-level-num");e&&(e.innerText=this.level),this.mapGraph.length===0&&(this.generateSectorMap(),this.currentMapPos={layer:-1,index:-1}),window.UI.renderMap(this.mapGraph,this.currentMapPos)},generateSectorMap(){const e=[];e.push([{type:"start",name:"èµ·ç‚¹",desc:"æ–°çš„ä¹ç« å¼€å§‹",next:[]}]);for(let t=1;t<5;t++){const n=2+Math.floor(Math.random()*2),o=[];for(let a=0;a<n;a++){let i="battle",c=Math.random();c<.15?i="camp":c<.35?i="shop":c<.45&&t>1?i="elite":c<.55&&this.partyRoles.length<4?i="recruit":i="battle";let r="é­é‡æˆ˜";i==="camp"&&(r="è¥åœ°"),i==="shop"&&(r="ä¹å™¨åº—"),i==="elite"&&(r="ç²¾è‹±æˆ˜"),i==="recruit"&&(r="éŸ³ä¹å…"),o.push({type:i,name:r,next:[]})}e.push(o)}e.push([{type:"boss",name:"å†³æˆ˜",desc:"æœ€ç»ˆè€ƒéªŒ",next:[]}]);for(let t=0;t<5;t++){const n=e[t],o=e[t+1];n.forEach(a=>{if(t===0)o.forEach((i,c)=>a.next.push(c));else{const i=1+(Math.random()>.5?1:0);for(let c=0;c<i;c++){const r=Math.floor(Math.random()*o.length);a.next.includes(r)||a.next.push(r)}}}),o.forEach((a,i)=>{if(!n.some(r=>r.next.includes(i))){const r=Math.floor(Math.random()*n.length);n[r].next.push(i)}}),n.forEach(a=>a.next.sort((i,c)=>i-c))}this.mapGraph=e},enterNode(e,s,t){if(this.currentMapPos={layer:s,index:t},e==="start"){this.mapSelect();return}e==="recruit"?(window.UI.switchScene("scene-recruit"),setTimeout(()=>window.UI.renderCharSelect("grid-recruit",n=>this.recruit(n)),100)):e==="camp"?this.showCamp():e==="shop"?this.showShop():this.startLevel(e)},shopData:{cards:[],relics:[],services:[]},showShop(){window.UI.switchScene("scene-shop"),this.shopData={cards:[],relics:[],services:[]};const e=[...new Set(window.battle.playerDeck)].filter(n=>(this.cardLevels[n]||0)<5);e.sort(()=>Math.random()-.5),e.slice(0,3).forEach(n=>{const o=this.cardLevels[n]||0,a=50+o*25;this.shopData.cards.push({id:n,price:a,sold:!1,level:o})});const t=Object.keys(window.RELICS).filter(n=>!this.relics.includes(n));if(t.length>0){const n=t[Math.floor(Math.random()*t.length)];this.shopData.relics.push({key:n,price:160,sold:!1})}this.shopData.services.push({type:"remove",name:"å¿˜å´ä¹è°±",desc:"ä»ç‰Œç»„ä¸­ç§»é™¤ä¸€å¼ ç‰Œ",price:75,sold:!1,icon:"assets/UI/banish_icon.png"}),this.shopData.services.push({type:"heal",name:"èŒ¶æ­‡",desc:"å…¨å‘˜æ¢å¤ 30% ç”Ÿå‘½",price:50,sold:!1,icon:"assets/UI/heal_icon.png"}),window.UI.renderShop(this.shopData),window.UI.update()},buyItem(e,s){let t=this.shopData[e][s];if(!t.sold){if(this.gold<t.price){window.UI.toast("é‡‘å¸ä¸è¶³!");return}if(e==="cards")this.gold-=t.price,this.cardLevels[t.id]=(this.cardLevels[t.id]||0)+1,window.UI.toast(`å¼ºåŒ–æˆåŠŸ: ${window.CARDS[t.id].name} +${this.cardLevels[t.id]}`),t.sold=!0;else if(e==="relics")this.gold-=t.price,this.relics.push(t.key),window.UI.toast(`è´­ä¹°äº† ${window.RELICS[t.key].name}`),t.key==="sheet_music"&&Object.keys(window.game.cardLevels).forEach(n=>window.game.cardLevels[n]++),t.sold=!0;else if(e==="services"){if(t.type==="heal")this.gold-=t.price,window.battle.allies.forEach(n=>{n.dead?(n.dead=!1,n.hp=Math.floor(n.maxHp*.3)):n.hp=Math.min(n.maxHp,n.hp+Math.floor(n.maxHp*.3))}),window.UI.toast("å…¨å‘˜æ¢å¤!"),t.sold=!0;else if(t.type==="remove"){if(window.battle.playerDeck.length<=5){window.UI.toast("å¡ç»„è¿‡è–„ï¼Œæ— æ³•ç§»é™¤");return}window.UI.showDeckModal(window.battle.playerDeck,"é€‰æ‹©è¦ç§»é™¤çš„å¡ç‰Œ",(n,o)=>{this.gold>=t.price&&(this.gold-=t.price,window.battle.playerDeck.splice(o,1),window.UI.toast("ç§»é™¤æˆåŠŸ"),t.sold=!0,window.UI.closeDeckModal(),window.UI.renderShop(this.shopData),window.UI.update())});return}}window.UI.renderShop(this.shopData),window.UI.update()}},leaveShop(){this.mapSelect()},startLevel(e){window.battle.reset(),window.battle.allies.forEach(o=>{o.role==="cellist"&&(o.block=8)}),this.relics.includes("baton")&&window.battle.manaData.current++;let s=window.ENEMIES.noise,t=1;if(e==="boss")s=window.ENEMIES.silence,t=3,window.UI.playBGM("assets/BGM/Scythian Suite.mp3");else if(e==="elite"){const o=["discord","shihengwuzhe"],a=o[Math.floor(Math.random()*o.length)];s=window.ENEMIES[a],t=1.8,window.UI.stopBGM(),a==="shihengwuzhe"?window.UI.playBGM("assets/BGM/Shostakovich_String Quartet.mp3"):a==="discord"&&window.UI.playBGM("assets/BGM/Mahler - Symphony.mp3")}else{const o=["noise","bayinhe","changshiban"],a=o[Math.floor(Math.random()*o.length)];s=window.ENEMIES[a],t=1,window.UI.stopBGM(),a==="changshiban"?window.UI.playBGM("assets/BGM/bin ich nun frei.m4a"):window.UI.playBGM("assets/BGM/Bruckner.mp3")}const n=(30+this.level*8)*t;window.battle.enemy={type:e,name:s.name,sprite:s.sprite,hp:Math.floor(n*s.hpScale),maxHp:Math.floor(n*s.hpScale),block:0,intent:{type:"atk",val:0},stunned:!1,buffs:{vuln:0,res:0,str:0},acts:s.act},window.battle.planEnemy(),window.UI.switchScene("scene-battle"),window.battle.phase="PREPARE",window.UI.renderBattleField(),window.UI.update(),document.getElementById("prep-ui").style.display="block",document.getElementById("hand").style.display="none",document.getElementById("btn-end").style.display="none",document.getElementById("party-container").classList.add("interactive")},recruit(e){if(this.partyRoles.includes(e))return;this.partyRoles.push(e);const s=window.ROLES[e];window.battle.manaData.max+=1,window.battle.manaData.draw+=1,e==="violinist"&&(window.battle.manaData.draw+=1),window.battle.allies.push(this.createAlly(e)),window.battle.playerDeck.push(...s.deck),e==="vocalist"&&window.battle.allies.forEach(t=>t.maxHp+=15),this.checkDuo(),window.UI.toast(`${s.name} åŠ å…¥! æ‰‹ç‰Œä¸Šé™+1`),setTimeout(()=>this.mapSelect(),1e3),this.level++},checkDuo(){window.DUO_CARDS.forEach(e=>{e.req.every(s=>this.partyRoles.includes(s))})},showCamp(){window.UI.switchScene("scene-camp")},getSmartRewards(){const e=window.DUO_CARDS.filter(n=>n.req.every(o=>this.partyRoles.includes(o))).map(n=>n.id);if(e.length===0)return[];const s=[],t=[...e];for(let n=0;n<3&&t.length!==0;n++){const o=Math.floor(Math.random()*t.length);s.push(t[o]),t.splice(o,1)}return s},campAction(e){if(e==="heal")window.battle.allies.forEach(s=>{s.dead?(s.dead=!1,s.hp=Math.floor(s.maxHp*.3)):s.hp=Math.min(s.maxHp,s.hp+Math.floor(s.maxHp*.3))}),window.UI.toast("ä¼‘æ•´å®Œæˆ");else if(e==="card"){window.UI.switchScene("scene-reward"),window.UI.renderRewards("new");return}else if(e==="upgrade"){let s=[...new Set([...window.battle.playerDeck])],t=[];if(s.length>0){for(let n=0;n<2&&s.length!==0;n++){const o=Math.floor(Math.random()*s.length),a=s[o];if((window.game.cardLevels[a]||0)>=5){s.splice(o,1),n--;continue}window.game.cardLevels[a]=(window.game.cardLevels[a]||0)+1;const i=window.game.cardLevels[a];t.push(window.CARDS[a].name+(i>0?`+${i}`:"")),s.splice(o,1)}t.length>0?window.UI.toast(`æŠ€è‰ºç²¾è¿›: ${t.join(", ")}`):window.UI.toast("æ‰€æœ‰æŠ€èƒ½å·²è¾¾åŒ–å¢ƒ (Max 5)")}}else if(e==="relic"){const t=Object.keys(window.RELICS).filter(n=>!this.relics.includes(n));if(t.length>0){const n=t[Math.floor(Math.random()*t.length)];this.relics.push(n),window.UI.toast(`è·å¾—åœ£ç‰©: ${window.RELICS[n].name}`),n==="sheet_music"&&Object.keys(window.game.cardLevels).forEach(o=>window.game.cardLevels[o]++)}else window.battle.allies.forEach(n=>{n.maxHp+=10,n.hp+=10}),window.UI.toast("è·å¾—: å¤©ä½¿ä¹‹ç¾½ (å…¨å±æ€§æå‡)")}setTimeout(()=>{this.level++,this.mapSelect()},1200)},finishReward(){this.level++,this.mapSelect()},showDeck(){const e=document.getElementById("scene-battle").classList.contains("active");let s=[];e?s=[...window.battle.playerDeck,...window.battle.hand,...window.battle.discard]:s=window.battle.playerDeck,window.UI.showDeckModal(s,`å½“å‰å¡ç»„ (${s.length})`)},closeDeck(){window.UI.closeDeckModal()},previewDeck(e,s){const t=window.ROLES[e];let n=[];s==="start"?n=[...window.COMMON_DECK,...t.deck]:n=[...t.deck],window.UI.showDeckModal(n,`${t.name} - æŠ€èƒ½é¢„è§ˆ`)},openDebugMenu(){window.UI.switchScene("scene-debug");const e=document.getElementById("debug-enemy-list");e.innerHTML="",this.partyRoles.length===0&&this.initParty("pianist",!1),Object.keys(window.ENEMIES).forEach(s=>{const t=window.ENEMIES[s],n=document.createElement("div");n.className="char-card",n.style.height="auto",n.style.padding="15px",n.innerHTML=`
                <img src="${t.sprite}" class="char-img" style="height:100px; object-fit:contain;">
                <div style="margin-top:10px; font-weight:bold;">${t.name}</div>
                <div style="font-size:0.8em; color:#888;">HP x ${t.hpScale}</div>
            `,n.onclick=()=>{this.startLevel("debug",s)},e.appendChild(n)})},startLevel(e,s=null){window.battle.reset(),window.battle.allies.forEach(a=>{a.role==="cellist"&&(a.block=8)}),this.relics.includes("baton")&&window.battle.manaData.current++;let t=window.ENEMIES.noise,n=1;if(s&&window.ENEMIES[s])t=window.ENEMIES[s],e="battle",s==="silence"?(e="boss",n=3):["discord","shihengwuzhe"].includes(s)?(e="elite",n=1.8):n=1,window.UI.stopBGM(),s==="silence"?window.UI.playBGM("assets/BGM/Scythian Suite.mp3"):s==="shihengwuzhe"?window.UI.playBGM("assets/BGM/Shostakovich_String Quartet.mp3"):s==="discord"?window.UI.playBGM("assets/BGM/Mahler - Symphony.mp3"):s==="changshiban"?window.UI.playBGM("assets/BGM/bin ich nun frei.m4a"):window.UI.playBGM("assets/BGM/Bruckner.mp3");else if(e==="boss")t=window.ENEMIES.silence,n=3,window.UI.playBGM("assets/BGM/Scythian Suite.mp3");else if(e==="elite"){const a=["discord","shihengwuzhe"],i=a[Math.floor(Math.random()*a.length)];t=window.ENEMIES[i],n=1.8,window.UI.stopBGM(),i==="shihengwuzhe"?window.UI.playBGM("assets/BGM/Shostakovich_String Quartet.mp3"):i==="discord"&&window.UI.playBGM("assets/BGM/Mahler - Symphony.mp3")}else{const a=["noise","bayinhe","changshiban"],i=a[Math.floor(Math.random()*a.length)];t=window.ENEMIES[i],n=1,window.UI.stopBGM(),i==="changshiban"?window.UI.playBGM("assets/BGM/bin ich nun frei.m4a"):window.UI.playBGM("assets/BGM/Bruckner.mp3")}const o=(30+this.level*8)*n;window.battle.enemy={type:e,name:t.name,sprite:t.sprite,hp:Math.floor(o*t.hpScale),maxHp:Math.floor(o*t.hpScale),block:0,intent:{type:"atk",val:0},stunned:!1,buffs:{vuln:0,res:0,str:0},acts:t.act},window.battle.planEnemy(),window.UI.switchScene("scene-battle"),window.battle.phase="PREPARE",window.UI.renderBattleField(),window.UI.update(),document.getElementById("prep-ui").style.display="block",document.getElementById("hand").style.display="none",document.getElementById("btn-end").style.display="none",document.getElementById("party-container").classList.add("interactive")}};window.PATHS=w;window.COMMON_DECK=E;window.ROLES=x;window.ENEMIES=B;window.RELICS=$;window.CARDS=S;window.DUO_CARDS=k;document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("btn-start-game");e&&e.addEventListener("click",()=>{window.game?window.game.start():console.error("Game object not initialized!")})});
