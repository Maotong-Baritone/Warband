<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>动画测试：杂音唱诗班序列帧 (Choir)</title>
<style>
    body {
        background-color: #1a1a1a;
        color: #fff;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
    }

    .test-stage {
        width: 800px;
        height: 400px;
        border: 2px solid #444;
        background-color: #000;
        position: relative;
        background-size: cover;
        overflow: hidden;
    }

    /* === 目标 === */
    .target-ally {
        width: 150px;
        height: 150px;
        position: absolute;
        left: 200px;
        bottom: 50px;
        background-image: url('assets/Roles/percussionist.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center bottom;
        transition: filter 0.1s, transform 0.1s;
    }

    /* === 攻击者：杂音唱诗班 === */
    .sprite-enemy {
        width: 250px;
        height: 250px;
        position: absolute;
        right: 150px;
        bottom: 50px;
        background-image: url('assets/Enemies/changshiban.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center bottom;
        z-index: 10;
    }

    /* === 特效 (精神尖啸) === */
    .vfx-particle {
        position: absolute;
        pointer-events: none;
        z-index: 20;
    }

    /* 模拟原游戏中的 Psychic_Shriek 动画 */
    .vfx-shriek {
        width: 600px;
        height: 200px;
        opacity: 0;
        transform-origin: right center;
        animation: shriekAnim 0.8s ease-out forwards;
    }
    @keyframes shriekAnim {
        0% { opacity: 0; transform: translate(-80%, -50%) scaleX(0.1); }
        20% { opacity: 1; transform: translate(-80%, -50%) scaleX(1); }
        100% { opacity: 0; transform: translate(-80%, -50%) scaleX(1.2); }
    }

    /* === 唱诗班远程攻击动画 (总时长 1.2s) === */
    /* 
       远程攻击设计：
       1. 吸气/蓄势 (0-40%): 身体微微向后仰，张开嘴巴准备尖啸。
       2. 尖啸爆发 (40-70%): 身体向前突，维持大声尖叫姿态，伴随剧烈颤动。
       3. 恢复 (70-100%): 慢慢回位。
    */

    @keyframes choirMove {
        0% { transform: scale(1); }
        
        /* 蓄势：后移并缩小一点 */
        40% { transform: translateX(20px) scale(0.95); } 
        
        /* 爆发：向前冲一点点并放大，颤动 */
        45% { transform: translateX(-10px) scale(1.1); }
        47% { transform: translateX(-15px) scale(1.1); }
        50% { transform: translateX(-10px) scale(1.1); }
        52% { transform: translateX(-15px) scale(1.1); }
        55% { transform: translateX(-10px) scale(1.1); }
        
        /* 持续爆发 */
        70% { transform: translateX(-10px) scale(1.05); }
        
        /* 恢复 */
        100% { transform: translateX(0) scale(1); }
    }

    @keyframes choirSequence {
        0% { background-image: url('assets/Enemies/changshiban.png'); }
        
        /* 开始张嘴蓄势 */
        10% { background-image: url('assets/Enemies/changshiban_attack_1.png'); }
        
        /* 尖啸瞬间：换成最夸张的表情 */
        40% { background-image: url('assets/Enemies/changshiban_attack_2.png'); }
        
        /* 维持尖啸 */
        70% { background-image: url('assets/Enemies/changshiban_attack_1.png'); }
        
        /* 恢复常态 */
        90% { background-image: url('assets/Enemies/changshiban.png'); }
        100% { background-image: url('assets/Enemies/changshiban.png'); }
    }

    .anim-choir-attack {
        animation: 
            choirMove 1.2s ease-in-out,
            choirSequence 1.2s steps(1); 
    }

    /* 受击动画 */
    .anim-hit {
        animation: shakeHit 0.4s ease-out;
    }
    @keyframes shakeHit {
        0% { filter: brightness(1.5) blur(1px); transform: translateX(-15px); }
        20% { transform: translateX(10px); }
        40% { transform: translateX(-10px); }
        100% { filter: none; transform: translateX(0); }
    }

    .controls { margin-top: 20px; }
    button { padding: 10px 30px; font-size: 18px; cursor: pointer; background: #9b59b6; color: white; border: none; border-radius: 4px; }
    button:hover { background: #8e44ad; }
    
    #preload { display: none; }
</style>
</head>
<body>

    <div class="test-stage">
        <!-- 目标 -->
        <div id="target-unit" class="target-ally"></div>
        <!-- 敌人 -->
        <div id="test-enemy" class="sprite-enemy"></div>
    </div>

    <div class="controls">
        <button onclick="playAnim()">测试尖啸 (Screech)</button>
    </div>

    <div id="preload">
        <img src="assets/Enemies/changshiban_attack_1.png">
        <img src="assets/Enemies/changshiban_attack_2.png">
        <img src="assets/Enemies/changshiban.png">
        <img src="assets/vfx/vfx_Psychic_Shriek.png">
    </div>

    <script>
        function playAnim() {
            const enemy = document.getElementById('test-enemy');
            const target = document.getElementById('target-unit');
            
            // 1. 重置并播放敌人动画
            enemy.classList.remove('anim-choir-attack');
            void enemy.offsetWidth; 
            enemy.classList.add('anim-choir-attack');

            // 2. 模拟击中时刻
            // 爆发点在 40% -> 1.2s * 0.4 = 480ms
            setTimeout(() => {
                spawnVFX();
                // 精神攻击受击感稍微延迟一点，模拟余波
                setTimeout(() => {
                    target.classList.remove('anim-hit');
                    void target.offsetWidth;
                    target.classList.add('anim-hit');
                }, 50);
            }, 480);
        }

        function spawnVFX() {
            const stage = document.querySelector('.test-stage');
            const enemy = document.getElementById('test-enemy');
            const eRect = enemy.getBoundingClientRect();
            const sRect = stage.getBoundingClientRect();
            
            const vfx = document.createElement('img');
            vfx.src = 'assets/vfx/vfx_Psychic_Shriek.png';
            vfx.className = 'vfx-particle vfx-shriek';
            
            // 从敌人嘴部位置发出 (大概是敌人图片中心靠左一点)
            vfx.style.right = '280px'; 
            vfx.style.top = '50%';
            
            stage.appendChild(vfx);
            
            setTimeout(() => vfx.remove(), 800);
        }
    </script>
</body>
</html>